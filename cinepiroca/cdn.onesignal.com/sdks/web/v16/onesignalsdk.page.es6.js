(function(){"use strict";class A extends Error{constructor(e=""){super(e),Object.defineProperty(this,"message",{configurable:!0,enumerable:!1,value:e,writable:!0}),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:this.constructor.name,writable:!0}),Object.defineProperty(this,"stack",{configurable:!0,enumerable:!1,value:new Error(e).stack,writable:!0}),Object.setPrototypeOf(this,A.prototype)}}class ni extends A{constructor(e="The asynchronous operation has timed out."){super(e),this.message=e,Object.setPrototypeOf(this,ni.prototype)}}class y{static contains(e,t){return e?e.indexOf(t)!==-1:!1}static trimUndefined(e){for(const t in e)e[t]===void 0&&delete e[t];return e}static capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}static isNullOrUndefined(e){return typeof e>"u"||e===null}static valueOrDefault(e,t){return typeof e>"u"||e===null?t:e}static stringify(e){return JSON.stringify(e,(t,i)=>typeof i=="function"?"[Function]":i,4)}static encodeHashAsUriComponent(e){let t="";const i=Object.keys(e);for(const n of i){const o=e[n];t+=`${encodeURIComponent(n)}=${encodeURIComponent(o)}`}return t}static timeoutPromise(e,t){const i=new Promise((n,o)=>{setTimeout(()=>{o(new ni)},t)});return Promise.race([e,i])}static getValueOrDefault(e,t){return e??t}static padStart(e,t,i){let n=e;for(;n.length<t;)n=i+n;return n}static parseVersionString(e){const t=e.toString().split("."),i=y.padStart(t[0],2,"0");let n;return t[1]?n=y.padStart(t[1],2,"0"):n="00",+`${i}.${n}`}static lastParts(e,t,i){const n=e.split(t),o=Math.max(n.length-i,0);return n.slice(o).join(t)}static enforceAppId(e){if(!e)throw new Error("App id cannot be empty")}static enforceAlias(e){if(!e.label)throw new Error("Alias label cannot be empty");if(!e.id)throw new Error("Alias id cannot be empty")}static sortArrayOfObjects(e,t,i=!1,n=!0){const o=n?e:e.slice();return o.sort((r,c)=>{const l=t(r),d=t(c);return l>d?i?-1:1:l<d?i?1:-1:0}),o}}const si="160405";let a=class Je{static debug;static trace;static info;static warn;static error;static proxyMethodsCreated;static shouldLog(){try{if(typeof window>"u"||typeof window.localStorage>"u")return!1;const e=window.localStorage.getItem("loglevel");return!!(e&&e.toLowerCase()==="trace")}catch{return!1}}static setLevel(e){if(!(typeof window>"u"||typeof window.localStorage>"u"))try{window.localStorage.setItem("loglevel",e),Je.proxyMethodsCreated=void 0,Je.createProxyMethods()}catch{return}}static createProxyMethods(){if(typeof Je.proxyMethodsCreated<"u")return;Je.proxyMethodsCreated=!0;const e={log:"debug",trace:"trace",info:"info",warn:"warn",error:"error"};for(const t of Object.keys(e)){const i=typeof console[t]<"u",n=e[t];i&&(Je.shouldLog()||n==="error")?Je[n]=console[t].bind(console):Je[n]=function(){}}}};a.createProxyMethods();var x=(s=>(s[s.Empty=0]="Empty",s[s.Malformed=1]="Malformed",s[s.EnumOutOfRange=2]="EnumOutOfRange",s[s.WrongType=3]="WrongType",s[s.Reserved=4]="Reserved",s))(x||{});class M extends A{argument;reason;constructor(e,t,i=""){let n;switch(t){case 0:n=`Supply a non-empty value to '${e}'.`;break;case 1:n=`The value for '${e}' was malformed.`;break;case 2:n=`The value for '${e}' was out of range of the expected input enum.`;break;case 3:n=`The value for '${e}' was of the wrong type.`;break;case 4:n=`The value for '${e}' is reserved.`;break}i&&(n+=` ${i}`),super(n),this.argument=e,this.reason=x[t],Object.setPrototypeOf(this,M.prototype)}}function bn(){return typeof PushSubscriptionOptions<"u"&&PushSubscriptionOptions.prototype.hasOwnProperty("applicationServerKey")}var X=(s=>(s.ServiceWorker="ServiceWorker",s.Host="Host",s))(X||{});function _i(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Ut={exports:{}};/*!
 * Bowser - a browser detector
 * https://github.com/ded/bowser
 * MIT License | (c) Dustin Diaz 2015
 */var wn=Ut.exports,Bi;function yn(){return Bi||(Bi=1,function(s){(function(e,t,i){s.exports?s.exports=i():e[t]=i()})(wn,"bowser",function(){var e=!0;function t(d){function g(Rt){var st=d.match(Rt);return st&&st.length>1&&st[1]||""}function S(Rt){var st=d.match(Rt);return st&&st.length>1&&st[2]||""}var h=g(/(ipod|iphone|ipad)/i).toLowerCase(),E=/like android/i.test(d),w=!E&&/android/i.test(d),_=/nexus\s*[0-6]\s*/i.test(d),pe=!_&&/nexus\s*[0-9]+/i.test(d),we=/CrOS/.test(d),We=/silk/i.test(d),Ui=/sailfish/i.test(d),Dt=/tizen/i.test(d),gn=/(web|hpw)os/i.test(d),hn=/windows phone/i.test(d),Gs=!hn&&/windows/i.test(d),zs=!h&&!We&&/macintosh/i.test(d),Ys=!w&&!Ui&&!Dt&&!gn&&/linux/i.test(d),Li=g(/edge\/(\d+(\.\d+)?)/i),Y=g(/version\/(\d+(\.\d+)?)/i),fn=/tablet/i.test(d)&&!/tablet pc/i.test(d),mn=!fn&&/[^-]mobi/i.test(d),Ks=/xbox/i.test(d),p;/opera/i.test(d)?p={name:"Opera",opera:e,version:Y||g(/(?:opera|opr|opios)[\s\/](\d+(\.\d+)?)/i)}:/opr\/|opios/i.test(d)?p={name:"Opera",opera:e,version:g(/(?:opr|opios)[\s\/](\d+(\.\d+)?)/i)||Y}:/SamsungBrowser/i.test(d)?p={name:"Samsung Internet for Android",samsungBrowser:e,version:Y||g(/(?:SamsungBrowser)[\s\/](\d+(\.\d+)?)/i)}:/coast/i.test(d)?p={name:"Opera Coast",coast:e,version:Y||g(/(?:coast)[\s\/](\d+(\.\d+)?)/i)}:/yabrowser/i.test(d)?p={name:"Yandex Browser",yandexbrowser:e,version:Y||g(/(?:yabrowser)[\s\/](\d+(\.\d+)?)/i)}:/ucbrowser/i.test(d)?p={name:"UC Browser",ucbrowser:e,version:g(/(?:ucbrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/mxios/i.test(d)?p={name:"Maxthon",maxthon:e,version:g(/(?:mxios)[\s\/](\d+(?:\.\d+)+)/i)}:/epiphany/i.test(d)?p={name:"Epiphany",epiphany:e,version:g(/(?:epiphany)[\s\/](\d+(?:\.\d+)+)/i)}:/puffin/i.test(d)?p={name:"Puffin",puffin:e,version:g(/(?:puffin)[\s\/](\d+(?:\.\d+)?)/i)}:/sleipnir/i.test(d)?p={name:"Sleipnir",sleipnir:e,version:g(/(?:sleipnir)[\s\/](\d+(?:\.\d+)+)/i)}:/k-meleon/i.test(d)?p={name:"K-Meleon",kMeleon:e,version:g(/(?:k-meleon)[\s\/](\d+(?:\.\d+)+)/i)}:hn?(p={name:"Windows Phone",windowsphone:e},Li?(p.msedge=e,p.version=Li):(p.msie=e,p.version=g(/iemobile\/(\d+(\.\d+)?)/i))):/msie|trident/i.test(d)?p={name:"Internet Explorer",msie:e,version:g(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:we?p={name:"Chrome",chromeos:e,chromeBook:e,chrome:e,version:g(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:/chrome.+? edge/i.test(d)?p={name:"Microsoft Edge",msedge:e,version:Li}:/vivaldi/i.test(d)?p={name:"Vivaldi",vivaldi:e,version:g(/vivaldi\/(\d+(\.\d+)?)/i)||Y}:Ui?p={name:"Sailfish",sailfish:e,version:g(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(d)?p={name:"SeaMonkey",seamonkey:e,version:g(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel|fxios/i.test(d)?(p={name:"Firefox",firefox:e,version:g(/(?:firefox|iceweasel|fxios)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(d)&&(p.firefoxos=e)):We?p={name:"Amazon Silk",silk:e,version:g(/silk\/(\d+(\.\d+)?)/i)}:/phantom/i.test(d)?p={name:"PhantomJS",phantom:e,version:g(/phantomjs\/(\d+(\.\d+)?)/i)}:/slimerjs/i.test(d)?p={name:"SlimerJS",slimer:e,version:g(/slimerjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(d)||/rim\stablet/i.test(d)?p={name:"BlackBerry",blackberry:e,version:Y||g(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:gn?(p={name:"WebOS",webos:e,version:Y||g(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(d)&&(p.touchpad=e)):/bada/i.test(d)?p={name:"Bada",bada:e,version:g(/dolfin\/(\d+(\.\d+)?)/i)}:Dt?p={name:"Tizen",tizen:e,version:g(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||Y}:/qupzilla/i.test(d)?p={name:"QupZilla",qupzilla:e,version:g(/(?:qupzilla)[\s\/](\d+(?:\.\d+)+)/i)||Y}:/chromium/i.test(d)?p={name:"Chromium",chromium:e,version:g(/(?:chromium)[\s\/](\d+(?:\.\d+)?)/i)||Y}:/chrome|crios|crmo/i.test(d)?p={name:"Chrome",chrome:e,version:g(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:w?p={name:"Android",version:Y}:/safari|applewebkit/i.test(d)?(p={name:"Safari",safari:e},Y&&(p.version=Y)):h?(p={name:h=="iphone"?"iPhone":h=="ipad"?"iPad":"iPod"},Y&&(p.version=Y)):/googlebot/i.test(d)?p={name:"Googlebot",googlebot:e,version:g(/googlebot\/(\d+(\.\d+))/i)||Y}:p={name:g(/^(.*)\/(.*) /),version:S(/^(.*)\/(.*) /)},!p.msedge&&/(apple)?webkit/i.test(d)?(/(apple)?webkit\/537\.36/i.test(d)?(p.name=p.name||"Blink",p.blink=e):(p.name=p.name||"Webkit",p.webkit=e),!p.version&&Y&&(p.version=Y)):!p.opera&&/gecko\//i.test(d)&&(p.name=p.name||"Gecko",p.gecko=e,p.version=p.version||g(/gecko\/(\d+(\.\d+)?)/i)),!p.windowsphone&&!p.msedge&&(w||p.silk)?p.android=e:!p.windowsphone&&!p.msedge&&h?(p[h]=e,p.ios=e):zs?p.mac=e:Ks?p.xbox=e:Gs?p.windows=e:Ys&&(p.linux=e);function Js(Rt){switch(Rt){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}var te="";p.windows?te=Js(g(/Windows ((NT|XP)( \d\d?.\d)?)/i)):p.windowsphone?te=g(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):p.mac?(te=g(/Mac OS X (\d+([_\.\s]\d+)*)/i),te=te.replace(/[_\s]/g,".")):h?(te=g(/os (\d+([_\s]\d+)*) like mac os x/i),te=te.replace(/[_\s]/g,".")):w?te=g(/android[ \/-](\d+(\.\d+)*)/i):p.webos?te=g(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):p.blackberry?te=g(/rim\stablet\sos\s(\d+(\.\d+)*)/i):p.bada?te=g(/bada\/(\d+(\.\d+)*)/i):p.tizen&&(te=g(/tizen[\/\s](\d+(\.\d+)*)/i)),te&&(p.osversion=te);var Sn=!p.windows&&te.split(".")[0];return fn||pe||h=="ipad"||w&&(Sn==3||Sn>=4&&!mn)||p.silk?p.tablet=e:(mn||h=="iphone"||h=="ipod"||w||_||p.blackberry||p.webos||p.bada)&&(p.mobile=e),p.msedge||p.msie&&p.version>=10||p.yandexbrowser&&p.version>=15||p.vivaldi&&p.version>=1||p.chrome&&p.version>=20||p.samsungBrowser&&p.version>=4||p.firefox&&p.version>=20||p.safari&&p.version>=6||p.opera&&p.version>=10||p.ios&&p.osversion&&p.osversion.split(".")[0]>=6||p.blackberry&&p.version>=10.1||p.chromium&&p.version>=20?p.a=e:p.msie&&p.version<10||p.chrome&&p.version<20||p.firefox&&p.version<20||p.safari&&p.version<6||p.opera&&p.version<10||p.ios&&p.osversion&&p.osversion.split(".")[0]<6||p.chromium&&p.version<20?p.c=e:p.x=e,p}var i=t(typeof navigator<"u"&&navigator.userAgent||"");i.test=function(d){for(var g=0;g<d.length;++g){var S=d[g];if(typeof S=="string"&&S in i)return!0}return!1};function n(d){return d.split(".").length}function o(d,g){var S=[],h;if(Array.prototype.map)return Array.prototype.map.call(d,g);for(h=0;h<d.length;h++)S.push(g(d[h]));return S}function r(d){for(var g=Math.max(n(d[0]),n(d[1])),S=o(d,function(h){var E=g-n(h);return h=h+new Array(E+1).join(".0"),o(h.split("."),function(w){return new Array(20-w.length).join("0")+w}).reverse()});--g>=0;){if(S[0][g]>S[1][g])return 1;if(S[0][g]===S[1][g]){if(g===0)return 0}else return-1}}function c(d,g,S){var h=i;typeof g=="string"&&(S=g,g=void 0),g===void 0&&(g=!1),S&&(h=t(S));var E=""+h.version;for(var w in d)if(d.hasOwnProperty(w)&&h[w]){if(typeof d[w]!="string")throw new Error("Browser version in the minVersion map should be a string: "+w+": "+String(d));return r([E,d[w]])<0}return g}function l(d,g,S){return!c(d,g,S)}return i.isUnsupportedBrowser=c,i.compareVersions=r,i.check=l,i._detect=t,i})}(Ut)),Ut.exports}var St=yn();const oi=_i(St);function k(){return{mobile:St.mobile,tablet:St.tablet,name:St.name.toLowerCase(),version:St.version}}class B{static isBrowser(){return typeof window<"u"}static useSafariLegacyPush(){return this.isBrowser()&&window.safari?.pushNotification!=null}static useSafariVapidPush(){return k().name=="safari"&&bn()&&!this.useSafariLegacyPush()}static version(){return si}static get TRADITIONAL_CHINESE_LANGUAGE_TAG(){return["tw","hant"]}static get SIMPLIFIED_CHINESE_LANGUAGE_TAG(){return["cn","hans"]}static getLanguage(){let e=navigator.language;if(e){e=e.toLowerCase();const t=e.split("-");if(t[0]=="zh"){for(const i of B.TRADITIONAL_CHINESE_LANGUAGE_TAG)if(t.indexOf(i)!==-1)return"zh-Hant";for(const i of B.SIMPLIFIED_CHINESE_LANGUAGE_TAG)if(t.indexOf(i)!==-1)return"zh-Hans";return"zh-Hant"}else return t[0].substring(0,2)}else return"en"}static supportsServiceWorkers(){switch(F.getWindowEnv()){case X.ServiceWorker:return!0;default:return typeof navigator<"u"&&"serviceWorker"in navigator}}}const In=["outcomes","on_focus"];class F{static getOrigin(){return B.isBrowser()?window.location.origin:typeof self<"u"&&typeof ServiceWorkerGlobalScope<"u"?self.location.origin:"Unknown"}static getWindowEnv(){if(typeof self<"u"&&typeof ServiceWorkerGlobalScope<"u")return X.ServiceWorker;if(typeof window>"u")throw Error("OneSignalSDK: Unsupported JS runtime!");return X.Host}static getOneSignalApiUrl({action:e,legacy:t=!1}={}){return new URL(t?"https://onesignal.com/api/v1/":"https://api.onesignal.com/")}static getOneSignalStaticResourcesUrl(){return new URL("https://media.onesignal.com/web-sdk")}static getOneSignalResourceUrlPath(){let e;return e="https://onesignal.com",new URL(`${e}/sdks/web/v16`)}static getOneSignalCssFileName(){return"OneSignalSDK.page.styles.css"}static isTurbineEndpoint(e){return e?In.some(t=>e.indexOf(t)>-1):!1}}class V{static getBaseUrl(){return location.origin}static redetectBrowserUserAgent(){return k().name===""&&k().version===""?oi._detect(navigator.userAgent):oi}static isValidUuid(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/.test(e)}static logMethodCall(e,...t){return a.debug(`Called ${e}(${t.map(y.stringify).join(", ")})`)}static isSafari(){return B.isBrowser()&&typeof window.safari<"u"}}class Lt{_events;constructor(){this._events={}}on(e,t){return this._events[e]=this._events[e]||[],this._events[e].push(t),this}once(e,t){const i=this;function n(){i.off(e,n),t.apply(this,arguments)}return n.listener=t,this.on(e,n),this}off(e,t){const i=this._events[e];if(i!==void 0){for(let n=0;n<i.length;n+=1)if(i[n]===t||i[n].listener===t){i.splice(n,1);break}i.length===0&&this.removeAllListeners(e)}return this}removeAllListeners(e){return e?delete this._events[e]:this._events={},this}listeners(e){try{return this._events[e]}catch{return}}numberOfListeners(e){const t=this.listeners(e);return t?t.length:0}async emit(...e){const t=e.shift();let i=this._events[t];if(i!==void 0){i=i.slice(0);const n=i.length;for(let o=0;o<n;o+=1)await i[o].apply(this,e)}return this}}const ge={Operations:"operations",Identity:"identity",Properties:"properties",Subscriptions:"subscriptions"},N={NORMAL:"NORMAL",HYDRATE:"HYDRATE"},vn=7,_t={PushSubscriptions:"pushSubscriptions",EmailSubscriptions:"emailSubscriptions",SmsSubscriptions:"smsSubscriptions"};class En{constructor(e,t=vn){this.databaseName=e,this.dbVersion=t,this.emitter=new Lt}emitter;database;openLock;open(e){return new Promise(t=>{let i;try{i=indexedDB.open(e,this.dbVersion)}catch{}if(!i)return null;i.onerror=this.onDatabaseOpenError.bind(this),i.onblocked=this.onDatabaseOpenBlocked.bind(this),i.onupgradeneeded=this.onDatabaseUpgradeNeeded.bind(this),i.onsuccess=()=>{this.database=i.result,this.database.onerror=this.onDatabaseError,this.database.onversionchange=this.onDatabaseVersionChange,t(this.database)}})}async close(){(await this.ensureDatabaseOpen()).close(),this.database?.close()}async ensureDatabaseOpen(){return this.openLock||(this.openLock=this.open(this.databaseName)),await this.openLock}onDatabaseOpenError(e){e.preventDefault();const t=e.target.error;y.contains(t.message,"The operation failed for reasons unrelated to the database itself and not covered by any other error code")||y.contains(t.message,"A mutation operation was attempted on a database that did not allow mutations")?a.warn("OneSignal: IndexedDb web storage is not available on this origin since this profile's IndexedDb schema has been upgraded in a newer version of Firefox. See: https://bugzilla.mozilla.org/show_bug.cgi?id=1236557#c6"):a.warn("OneSignal: Fatal error opening IndexedDb database:",t)}objectStoreNames(){return Array.from(this.database?.objectStoreNames||[])}onDatabaseError(e){a.debug("IndexedDb: Generic database error",e.target.errorCode)}onDatabaseOpenBlocked(){a.debug("IndexedDb: Blocked event")}onDatabaseVersionChange(){a.debug("IndexedDb: versionchange event")}onDatabaseUpgradeNeeded(e){a.debug("IndexedDb: Database is being rebuilt or upgraded (upgradeneeded event).");const t=e.target,i=t.transaction;if(!i)throw Error("Can't migrate DB without a transaction");const n=t.result,o=e.newVersion||Number.MAX_SAFE_INTEGER;o>=1&&e.oldVersion<1&&(n.createObjectStore("Ids",{keyPath:"type"}),n.createObjectStore("NotificationOpened",{keyPath:"url"}),n.createObjectStore("Options",{keyPath:"key"})),o>=2&&e.oldVersion<2&&(n.createObjectStore("Sessions",{keyPath:"sessionKey"}),n.createObjectStore("NotificationReceived",{keyPath:"notificationId"}),n.createObjectStore("NotificationClicked",{keyPath:"notificationId"})),o>=3&&e.oldVersion<3&&n.createObjectStore("SentUniqueOutcome",{keyPath:"outcomeName"}),o>=4&&e.oldVersion<4&&(n.createObjectStore(ge.Identity,{keyPath:"modelId"}),n.createObjectStore(ge.Properties,{keyPath:"modelId"}),n.createObjectStore(_t.PushSubscriptions,{keyPath:"modelId"}),n.createObjectStore(_t.SmsSubscriptions,{keyPath:"modelId"}),n.createObjectStore(_t.EmailSubscriptions,{keyPath:"modelId"})),o>=5&&e.oldVersion<5&&(this.migrateOutcomesNotificationClickedTableForV5(n,i),this.migrateOutcomesNotificationReceivedTableForV5(n,i)),o>=6&&e.oldVersion<6&&this.migrateModelNameSubscriptionsTableForV6(n,i),o>=7&&e.oldVersion<7&&n.createObjectStore(ge.Operations,{keyPath:"modelId"}),typeof OneSignal<"u"&&(OneSignal._isNewVisitor=!0)}migrateOutcomesNotificationClickedTableForV5(e,t){const i="Outcomes.NotificationClicked";e.createObjectStore(i,{keyPath:"notificationId"});const n="NotificationClicked",o=t.objectStore(n).openCursor();o.onsuccess=()=>{if(!o.result){e.deleteObjectStore(n);return}const r=o.result.value;t.objectStore(i).put({notificationId:r.notificationId||r.notification.id,appId:r.appId,timestamp:r.timestamp}),o.result.continue()},o.onerror=()=>{console.error("Could not migrate NotificationClicked records",o.error)}}migrateOutcomesNotificationReceivedTableForV5(e,t){const i="Outcomes.NotificationReceived";e.createObjectStore(i,{keyPath:"notificationId"});const n="NotificationReceived",o=t.objectStore(n).openCursor();o.onsuccess=()=>{if(!o.result){e.deleteObjectStore(n);return}t.objectStore(i).put(o.result.value),o.result.continue()},o.onerror=()=>{console.error("Could not migrate NotificationReceived records",o.error)}}migrateModelNameSubscriptionsTableForV6(e,t){const i=ge.Subscriptions;e.createObjectStore(i,{keyPath:"modelId"});let n;const o=t.objectStore(ge.Identity).openCursor();o.onsuccess=()=>{o.result&&(n=o.result.value.externalId)},o.onerror=()=>{console.error("Could not find "+ge.Identity+" records",o.error)},Object.values(_t).forEach(r=>{const c=t.objectStore(r).openCursor();c.onsuccess=()=>{if(!c.result){e.deleteObjectStore(r);return}const l=c.result.value;t.objectStore(i).put({...l,modelName:ge.Subscriptions,externalId:n}),c.result.continue()},c.onerror=()=>{console.error("Could not migrate "+r+" records",c.error)}})}async dbOperation(e,t,i){const n=await this.ensureDatabaseOpen();return await new Promise((o,r)=>{try{const c=n.transaction(e,t==="get"||t==="getAll"?"readonly":"readwrite").objectStore(e),l=t==="getAll"||t==="clear"?c[t]():c[t](i);l.onsuccess=()=>{o(l.result)},l.onerror=d=>{a.error("Database "+t.toUpperCase()+" Transaction Error:",d),r(d)}}catch(c){a.error("Database "+t.toUpperCase()+" Error:",c),r(c)}})}async get(e,t){return t?this.dbOperation(e,"get",t):this.dbOperation(e,"getAll")}async getAll(e){return this.dbOperation(e,"getAll")}async put(e,t){return this.dbOperation(e,"put",t)}async remove(e,t){return t?this.dbOperation(e,"delete",t):this.dbOperation(e,"clear")}}class Fi{static toDatabase(e){const t=e.notification,i=e.result;return{action:i.actionId,badge:t.badgeIcon,buttons:this.toDatabaseButtons(t.actionButtons),content:t.body,data:t.additionalData,heading:t.title,icon:t.icon,id:t.notificationId,image:t.image,rr:t.confirmDelivery,tag:t.topic,timestamp:e.timestamp,url:i.url}}static toDatabaseButtons(e){return e?.map(t=>({action:t.actionId,title:t.text,icon:t.icon,url:t.launchURL}))}static fromDatabase(e){return{result:{actionId:e.action,url:e.url},notification:{notificationId:e.id,title:e.heading,body:e.content,additionalData:e.data,launchURL:e.url,confirmDelivery:e.rr,icon:e.icon,image:e.image,topic:e.tag,badgeIcon:e.badge,actionButtons:this.toOSNotificationButtons(e.buttons)},timestamp:e.timestamp}}static toOSNotificationButtons(e){return e?.map(t=>({actionId:t.action,text:t.title,icon:t.icon,launchURL:t.url}))}}class Vi{static toDatabase(e,t){return{appId:e,notificationId:t.notification.notificationId,timestamp:t.timestamp}}static fromDatabase(e){return{appId:e.appId,notificationId:e.notificationId,timestamp:e.timestamp}}}class Wi{static toDatabase(e,t,i){return{appId:e,notificationId:t.notificationId,timestamp:i}}static fromDatabase(e){return{appId:e.appId,notificationId:e.notificationId,timestamp:e.timestamp}}}class On{defaultNotificationUrl;defaultNotificationTitle;lastKnownPushEnabled;lastKnownPushToken;lastKnownPushId;lastKnownOptedIn=!0;pendingNotificationClickEvents}var ot=(s=>(s.Active="active",s.Inactive="inactive",s))(ot||{}),ke=(s=>(s[s.UserCreate=1]="UserCreate",s[s.UserNewSession=2]="UserNewSession",s[s.VisibilityVisible=3]="VisibilityVisible",s[s.VisibilityHidden=4]="VisibilityHidden",s[s.BeforeUnload=5]="BeforeUnload",s[s.PageRefresh=6]="PageRefresh",s[s.Focus=7]="Focus",s[s.Blur=8]="Blur",s))(ke||{});const ri="oneSignalSession";function $i(s){const e=new Date().getTime(),t=s&&s.notificationId||null;return{accumulatedDuration:0,appId:s.appId,lastActivatedTimestamp:e,lastDeactivatedTimestamp:null,notificationId:t,sessionKey:ri,startTimestamp:e,status:"active"}}class ai{deviceId;subscriptionToken;optedOut;createdAt;expirationTime;serialize(){return{deviceId:this.deviceId,subscriptionToken:this.subscriptionToken,optedOut:this.optedOut,createdAt:this.createdAt,expirationTime:this.expirationTime}}static deserialize(e){const t=new ai;return t.deviceId=e.deviceId,t.subscriptionToken=e.subscriptionToken,t.optedOut=e.optedOut,t.createdAt=e.createdAt,t.expirationTime=e.expirationTime,t}}class Tn{previousOneSignalId;previousExternalId}var Hi=(s=>(s[s.SET=0]="SET",s))(Hi||{});const Cn="ONE_SIGNAL_SDK_DB",ci="Outcomes.NotificationClicked",li="Outcomes.NotificationReceived",Bt="NotificationOpened",di="Sessions";class u{constructor(e){this.databaseName=e,this.emitter=new Lt,this.database=new En(this.databaseName)}emitter;database;static databaseInstanceName;static databaseInstance;static EVENTS=Hi;static resetInstance(){u.databaseInstance=null}static get singletonInstance(){return u.databaseInstanceName||(u.databaseInstanceName=Cn),u.databaseInstance||(u.databaseInstance=new u(u.databaseInstanceName)),u.databaseInstance}static applyDbResultFilter(e,t,i){switch(e){case"Options":return i&&t?i.value:i&&!t?i:null;case"Ids":return i&&t?i.id:i&&!t?i:null;default:return i||null}}async get(e,t){const i=await this.database.get(e,t);return u.applyDbResultFilter(e,t,i)}async getAll(e){return await this.database.getAll(e)}async put(e,t){await new Promise(i=>{this.database.put(e,t).then(()=>i())}),this.emitter.emit(u.EVENTS.SET,t)}remove(e,t){return this.database.remove(e,t)}async getAppConfig(){const e={},t=await this.get("Ids","appId");return e.appId=t,e.vapidPublicKey=await this.get("Options","vapidPublicKey"),e}async setAppConfig(e){e.appId&&await this.put("Ids",{type:"appId",id:e.appId}),e.vapidPublicKey&&await this.put("Options",{key:"vapidPublicKey",value:e.vapidPublicKey})}async getAppState(){const e=new On;return e.defaultNotificationUrl=await this.get("Options","defaultUrl"),e.defaultNotificationTitle=await this.get("Options","defaultTitle"),e.lastKnownPushEnabled=await this.get("Options","isPushEnabled"),e.pendingNotificationClickEvents=await this.getAllPendingNotificationClickEvents(),e.lastKnownPushId=await this.get("Options","lastPushId"),e.lastKnownPushToken=await this.get("Options","lastPushToken"),e.lastKnownOptedIn=await this.get("Options","lastOptedIn"),e}async setIsPushEnabled(e){await this.put("Options",{key:"isPushEnabled",value:e})}async setAppState(e){if(e.defaultNotificationUrl&&await this.put("Options",{key:"defaultUrl",value:e.defaultNotificationUrl}),(e.defaultNotificationTitle||e.defaultNotificationTitle==="")&&await this.put("Options",{key:"defaultTitle",value:e.defaultNotificationTitle}),e.lastKnownPushEnabled!=null&&await this.setIsPushEnabled(e.lastKnownPushEnabled),e.lastKnownPushId!=null&&await this.put("Options",{key:"lastPushId",value:e.lastKnownPushId}),e.lastKnownPushToken!=null&&await this.put("Options",{key:"lastPushToken",value:e.lastKnownPushToken}),e.lastKnownOptedIn!=null&&await this.put("Options",{key:"lastOptedIn",value:e.lastKnownOptedIn}),e.pendingNotificationClickEvents){const t=Object.keys(e.pendingNotificationClickEvents);for(const i of t){const n=e.pendingNotificationClickEvents[i];n?await this.put(Bt,{url:i,data:n.data,timestamp:n.timestamp}):n===null&&await this.remove(Bt,i)}}}async getUserState(){const e=new Tn;return e.previousOneSignalId="",e.previousExternalId="",e.previousOneSignalId=await this.get("Options","previousOneSignalId"),e.previousExternalId=await this.get("Options","previousExternalId"),e}async setUserState(e){await this.put("Options",{key:"previousOneSignalId",value:e.previousOneSignalId}),await this.put("Options",{key:"previousExternalId",value:e.previousExternalId})}async getSubscription(){const e=new ai;e.deviceId=await this.get("Ids","userId"),e.subscriptionToken=await this.get("Ids","registrationId");const t=await this.get("Options","optedOut"),i=await this.get("Options","subscription"),n=await this.get("Options","subscriptionCreatedAt"),o=await this.get("Options","subscriptionExpirationTime");return t!=null?e.optedOut=t:i==null?e.optedOut=!1:e.optedOut=!i,e.createdAt=n,e.expirationTime=o,e}async setDeviceId(e){await this.put("Ids",{type:"userId",id:e})}async setSubscription(e){e.deviceId&&await this.setDeviceId(e.deviceId),typeof e.subscriptionToken<"u"&&await this.put("Ids",{type:"registrationId",id:e.subscriptionToken}),e.optedOut!=null&&await this.put("Options",{key:"optedOut",value:e.optedOut}),e.createdAt!=null&&await this.put("Options",{key:"subscriptionCreatedAt",value:e.createdAt}),e.expirationTime!=null?await this.put("Options",{key:"subscriptionExpirationTime",value:e.expirationTime}):await this.remove("Options","subscriptionExpirationTime")}async setJWTToken(e){await this.put("Ids",{type:"jwtToken",id:e})}async getJWTToken(){return await this.get("Ids","jwtToken")}async setProvideUserConsent(e){await this.put("Options",{key:"userConsent",value:e})}async getConsentGiven(){return await this.get("Options","userConsent")}async getSession(e){return await this.get(di,e)}async setSession(e){await this.put(di,e)}async removeSession(e){await this.remove(di,e)}async getLastNotificationClickedForOutcomes(e){let t=[];try{t=await this.getAllNotificationClickedForOutcomes()}catch(n){a.error("Database.getLastNotificationClickedForOutcomes",n)}const i=n=>n.appId===e;return t.find(i)||null}async getAllNotificationClickedForOutcomes(){return(await this.getAll(ci)).map(t=>Vi.fromDatabase(t))}async putNotificationClickedForOutcomes(e,t){await this.put(ci,Vi.toDatabase(e,t))}async putNotificationClickedEventPendingUrlOpening(e){await this.put(Bt,Fi.toDatabase(e))}async getAllPendingNotificationClickEvents(){const e={},t=await this.getAll(Bt);for(const i of t){const n=Fi.fromDatabase(i),o=n.result.url;o&&(e[o]=n)}return e}async removeAllNotificationClickedForOutcomes(){await this.remove(ci)}async getAllNotificationReceivedForOutcomes(){return(await this.getAll(li)).map(t=>Wi.fromDatabase(t))}async putNotificationReceivedForOutcomes(e,t){await this.put(li,Wi.toDatabase(e,t,new Date().getTime()))}async resetSentUniqueOutcomes(){const t=(await this.getAll("SentUniqueOutcome")).map(i=>(i.sentDuringSession=null,u.put("SentUniqueOutcome",i)));await Promise.all(t)}static async clear(){const e=await u.singletonInstance.database.objectStoreNames();for(const t of e)await u.singletonInstance.database.remove(t)}static async on(...e){return u.singletonInstance.emitter.on.apply(u.singletonInstance.emitter,e)}static async getPushId(){return this.get("Options","lastPushId")}static async setPushId(e){await this.put("Options",{key:"lastPushId",value:e})}static async getPushToken(){return this.get("Options","lastPushToken")}static async setPushToken(e){await this.put("Options",{key:"lastPushToken",value:e})}static async setIsPushEnabled(e){return u.singletonInstance.setIsPushEnabled(e)}static async getCurrentSession(){return await u.singletonInstance.getSession(ri)}static async upsertSession(e){await u.singletonInstance.setSession(e)}static async cleanupCurrentSession(){await u.singletonInstance.removeSession(ri)}static async setSubscription(e){return await u.singletonInstance.setSubscription(e)}static async getSubscription(){return await u.singletonInstance.getSubscription()}static async setJWTToken(e){return await u.singletonInstance.setJWTToken(e)}static async getJWTToken(){return await u.singletonInstance.getJWTToken()}static async setConsentGiven(e){return await u.singletonInstance.setProvideUserConsent(e)}static async getConsentGiven(){return await u.singletonInstance.getConsentGiven()}static async setAppState(e){return await u.singletonInstance.setAppState(e)}static async getAppState(){return await u.singletonInstance.getAppState()}static async setUserState(e){return await u.singletonInstance.setUserState(e)}static async getUserState(){return await u.singletonInstance.getUserState()}static async setAppConfig(e){return await u.singletonInstance.setAppConfig(e)}static async getAppConfig(){return await u.singletonInstance.getAppConfig()}static async getLastNotificationClickedForOutcomes(e){return await u.singletonInstance.getLastNotificationClickedForOutcomes(e)}static async removeAllNotificationClickedForOutcomes(){return await u.singletonInstance.removeAllNotificationClickedForOutcomes()}static async getAllNotificationReceivedForOutcomes(){return await u.singletonInstance.getAllNotificationReceivedForOutcomes()}static async putNotificationReceivedForOutcomes(e,t){return await u.singletonInstance.putNotificationReceivedForOutcomes(e,t)}static async getAllNotificationClickedForOutcomes(){return await u.singletonInstance.getAllNotificationClickedForOutcomes()}static async putNotificationClickedForOutcomes(e,t){return await u.singletonInstance.putNotificationClickedForOutcomes(e,t)}static async putNotificationClickedEventPendingUrlOpening(e){return await u.singletonInstance.putNotificationClickedEventPendingUrlOpening(e)}static async resetSentUniqueOutcomes(){return await u.singletonInstance.resetSentUniqueOutcomes()}static async setDeviceId(e){await u.singletonInstance.setDeviceId(e)}static async remove(e,t){return await u.singletonInstance.remove(e,t)}static async put(e,t){return await u.singletonInstance.put(e,t)}static async get(e,t){return await u.singletonInstance.get(e,t)}static async getAll(e){return await u.singletonInstance.getAll(e)}}const Pn=["notifyButtonHovering","notifyButtonHover","notifyButtonButtonClick","notifyButtonLauncherClick","animatedElementHiding","animatedElementHidden","animatedElementShowing","animatedElementShown","activeAnimatedElementActivating","activeAnimatedElementActive","activeAnimatedElementInactivating","activeAnimatedElementInactive"];class C{static async trigger(e,t,i){if(!y.contains(Pn,e)){const n=t,o=y.capitalize(F.getWindowEnv().toString());n||n===!1?a.debug(`(${o}) » ${e}:`,n):a.debug(`(${o}) » ${e}`)}if(B.isBrowser()){if(e===OneSignal.EVENTS.SDK_INITIALIZED){if(OneSignal.initialized)return;OneSignal.initialized=!0}i?await i.emit(e,t):await OneSignal.emitter.emit(e,t)}}}class Ne{static executing=!1;static async triggerNotificationPermissionChanged(e=!1){if(!Ne.executing){Ne.executing=!0;try{await Ne.privateTriggerNotificationPermissionChanged(e)}finally{Ne.executing=!1}}}static async privateTriggerNotificationPermissionChanged(e){const t=await OneSignal.context.permissionManager.getPermissionStatus(),i=await u.get("Options","notificationPermission");(t!==i||e)&&(await u.put("Options",{key:"notificationPermission",value:t}),C.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,t),this.triggerBooleanPermissionChangeEvent(i,t,e))}static triggerBooleanPermissionChangeEvent(e,t,i){const n=t==="granted";(n!==(e==="granted")||i)&&C.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_BOOLEAN,n)}}function $e(s){const e=document.querySelectorAll(s);if(e.length>0)for(let t=0;t<e.length;t++){const i=e[t].parentNode;i&&i.removeChild(e[t])}}async function ce(){return new Promise(s=>{OneSignal.initialized?s():OneSignal.emitter.once(OneSignal.EVENTS.SDK_INITIALIZED,s)})}async function kn(s=!1){return Ne.triggerNotificationPermissionChanged(s)}function Nn(s,...e){if(s)return s.apply(null,e)}function v(s,...e){return V.logMethodCall(s,...e)}function An(s){return!!s&&!!s.match(/^([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22))*\x40([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d))*$/)}function ne(s,e,t){let i;if(typeof s=="string"?i=document.querySelector(s):i=s,i){i.insertAdjacentHTML(e,t);return}throw new Error(`${s} must be a CSS selector string or DOM Element object.`)}function xn(s){if(typeof s=="string"){const e=document.querySelector(s);if(e===null)throw new Error(`Cannot find element with selector "${s}"`);for(;e.firstChild;)e.removeChild(e.firstChild)}else if(typeof s=="object")for(;s.firstChild;)s.removeChild(s.firstChild);else throw new Error(`${s} must be a CSS selector string or DOM Element object.`)}function m(s,e){if(typeof s=="string"){const t=document.querySelector(s);if(t===null)throw new Error(`Cannot find element with selector "${s}"`);t.classList.add(e)}else if(typeof s=="object")s.classList.add(e);else throw new Error(`${s} must be a CSS selector string or DOM Element object.`)}function le(s,e){if(typeof s=="string"){const t=document.querySelector(s);if(t===null)throw new Error(`Cannot find element with selector "${s}"`);t.classList.remove(e)}else if(typeof s=="object")s.classList.remove(e);else throw new Error(`${s} must be a CSS selector string or DOM Element object.`)}function ui(s,e){if(typeof s=="string"){const t=document.querySelector(s);if(t===null)throw new Error(`Cannot find element with selector "${s}"`);return t.classList.contains(e)}else{if(typeof s=="object")return s.classList.contains(e);throw new Error(`${s} must be a CSS selector string or DOM Element object.`)}}function rt(s){return new Promise(e=>{setTimeout(e,s)})}function at(){return Promise.resolve()}function He(s,e){return y.contains(s,e)}function pi(s){return V.isValidUuid(s)}function ye(s,e,t,i=!1){if(e||a.error("Cannot call on() with no event: ",e),t||a.error("Cannot call on() with no task: ",t),typeof s=="string"){const n=document.querySelectorAll(s);if(n.length>0)for(let o=0;o<n.length;o++)ye(n[o],e,t)}else if(Array.isArray(s))for(let n=0;n<s.length;n++)ye(s[n],e,t);else if(typeof s=="object"){const n=function(){return function(r){const c=function(){s.removeEventListener(r.type,n)};i||c(),t(r,c)}}();s.addEventListener(e,n)}else throw new Error(`${s} must be a CSS selector string or DOM Element object.`)}function gi(){return window.__oneSignalSdkLoadCount||0}function Mn(){window.__oneSignalSdkLoadCount=gi()+1}function hi(s){return s?k().name=="safari"&&s.safari?s.safari:k().name==="firefox"&&s.firefox?s.firefox:s.chrome||s.firefox||s.safari||"default-icon":"default-icon"}function W(s){const e=document.querySelector(s);return e||(a.debug(`No instance of ${s} found. Returning stub.`),document.createElement("div"))}function fi(s){return JSON.parse(JSON.stringify(s))}function Dn(){return Intl.DateTimeFormat().resolvedOptions().timeZone}function Rn(s){return typeof s=="object"&&s!==null&&!Array.isArray(s)}const b={SUCCESS:0,SUCCESS_STARTING_ONLY:1,FAIL_RETRY:2,FAIL_NORETRY:3,FAIL_UNAUTHORIZED:4,FAIL_CONFLICT:5,FAIL_PAUSE_OPREPO:6},D={INVALID:"INVALID",RETRYABLE:"RETRYABLE",UNAUTHORIZED:"UNAUTHORIZED",MISSING:"MISSING",CONFLICT:"CONFLICT"};function je(s){switch(s){case 400:case 402:return D.INVALID;case 401:case 403:return D.UNAUTHORIZED;case 404:case 410:return D.MISSING;case 409:return D.CONFLICT;case 429:default:return D.RETRYABLE}}const R={SET_ALIAS:"set-alias",DELETE_ALIAS:"delete-alias",SET_PROPERTY:"set-property",REFRESH_USER:"refresh-user",LOGIN_USER:"login-user",CREATE_SUBSCRIPTION:"create-subscription",UPDATE_SUBSCRIPTION:"update-subscription",DELETE_SUBSCRIPTION:"delete-subscription",TRANSFER_SUBSCRIPTION:"transfer-subscription"},Ae={EXTERNAL_ID:"external_id",ONESIGNAL_ID:"onesignal_id"},xe={LOCAL_PREFIX:"local-",createLocalId(){return`${this.LOCAL_PREFIX}${crypto.randomUUID()}`},isLocalId(s){return s?.startsWith(this.LOCAL_PREFIX)??!1}};class mi{subscribers=[];get hasSubscribers(){return this.subscribers.length>0}subscribe(e){this.subscribers.push(e)}unsubscribe(e){const t=this.subscribers.indexOf(e);t!==-1&&this.subscribers.splice(t,1)}subscribeAll(e){for(const t of e.subscribers)this.subscribe(t)}fire(e){for(const t of this.subscribers)e(t)}async suspendingFire(e){for(const t of this.subscribers)await e(t)}}class Ft{modelId;data=new Map;changeNotifier=new mi;constructor(){this.modelId=Math.random().toString(36).substring(2)}initializeFromJson(e){const{modelId:t,modelName:i,...n}=e;this.data.clear(),this.data=new Map(Object.entries(n)),t&&(this.modelId=t)}initializeFromModel(e,t){const i=new Map;t.data.forEach((n,o)=>{i.set(o,n)}),e!==null&&(this.modelId=e),this.data.clear(),this.data=i}setProperty(e,t,i=N.NORMAL,n=!1){const o=this.data.get(e);o===t&&!n||(t!==void 0?this.data.set(e,t):this.data.has(e)&&this.data.delete(e),this.notifyChanged(e,i,o,t))}hasProperty(e){return this.data.has(e)}getProperty(e,t){return this.data.get(e)??t}notifyChanged(e,t,i,n){const o={model:this,property:e,oldValue:i,newValue:n};this.changeNotifier.fire(r=>r.onChanged(o,t))}toJSON(){return Object.fromEntries(this.data.entries())}subscribe(e){return this.changeNotifier.subscribe(e)}unsubscribe(e){this.changeNotifier.unsubscribe(e)}get hasSubscribers(){return this.changeNotifier.hasSubscribers}mergeData(e){for(const[t,i]of Object.entries(e))this.data.set(t,i)}}const Be={CREATE:0,ALTER:1,NONE:2};class bt extends Ft{constructor(e,t,i){super(),this.name=e,t&&(this.appId=t),i&&(this.onesignalId=i)}get name(){return this.getProperty("name")}set name(e){this.setProperty("name",e)}get appId(){return this.getProperty("appId")}set appId(e){this.setProperty("appId",e)}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(e){this.setProperty("onesignalId",e)}get applyToRecordId(){return this.onesignalId}get createComparisonKey(){return""}get groupComparisonType(){return Be.ALTER}get canStartExecute(){return!xe.isLocalId(this.onesignalId)}translateIds(e){e[this.onesignalId]&&(this.onesignalId=e[this.onesignalId])}toString(){return JSON.stringify(this.toJSON())}}class ji extends bt{constructor(e,t,i,n){super(e,t,i),n&&(this.label=n)}get label(){return this.getProperty("label")}set label(e){this.setProperty("label",e)}}class Vt extends ji{constructor(e,t,i){super(R.DELETE_ALIAS,e,t,i)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Alias.${this.label}`}get groupComparisonType(){return Be.NONE}}class I{result;idTranslations;operations;retryAfterSeconds;constructor(e,t,i,n){this.result=e,this.retryAfterSeconds=t,this.operations=i,this.idTranslations=n}}class ct extends ji{constructor(e,t,i,n){super(R.SET_ALIAS,e,t,i),n&&(this.value=n)}get value(){return this.getProperty("value")}set value(e){this.setProperty("value",e)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Identity.${this.label}`}}class se{constructor(e,t){this.label=e,this.id=t}static ONESIGNAL_ID="onesignal_id";static EXTERNAL_ID="external_id"}var Si=(s=>(s[s.MissingAppId=0]="MissingAppId",s[s.RetryLimitReached=1]="RetryLimitReached",s))(Si||{});class Wt extends A{reason;constructor(e){let t;switch(e){case 0:t="The API call is missing an app ID.";break;case 1:t="The API call has reached the retry limit.";break}super(t),Object.setPrototypeOf(this,Wt.prototype)}}function wt(s){return new Promise(e=>setTimeout(e,s))}const Un={5:1e4,4:2e4,3:3e4,2:3e4,1:3e4};class ${static get(e,t,i){return $.call("GET",e,t,i)}static post(e,t,i){return $.call("POST",e,t,i)}static put(e,t,i){return $.call("PUT",e,t,i)}static delete(e,t,i){return $.call("DELETE",e,t,i)}static patch(e,t,i){return $.call("PATCH",e,t,i)}static call(e,t,i,n){if(!this.requestHasAppId(t,i))return Promise.reject(new Wt(Si.MissingAppId));const o=new Headers;if(o.append("Origin",F.getOrigin()),o.append("SDK-Version",`onesignal/web/${B.version()}`),o.append("Content-Type","application/json;charset=UTF-8"),o.append("Accept","application/vnd.onesignal.v1+json"),n)for(const l of Object.keys(n))o.append(l,n[l]);const r={method:e||"NO_METHOD_SPECIFIED",headers:o,cache:"no-cache"};i&&(r.body=JSON.stringify(i));const c=`${F.getOneSignalApiUrl({action:t}).toString()}${t}`;return $.executeFetch(c,r)}static async executeFetch(e,t,i=5){if(i===0)return Promise.reject(new Wt(Si.RetryLimitReached));try{const n=await fetch(e,t),{status:o,headers:r}=n,c=await n.json(),l=r?.get("Retry-After");return{ok:n.ok,result:c,status:o,retryAfterSeconds:l?parseInt(l):void 0}}catch(n){if(n instanceof Error&&n.name==="TypeError")return await wt(Un[i]),a.error(`OneSignal: Network timed out while calling ${e}. Retrying...`),$.executeFetch(e,t,i-1);throw new A(`OneSignalApiBase: failed to execute HTTP call: ${n}`)}}static requestHasAppId(e,t){if(e.startsWith("apps/")){const i=e.split("/");return pi(i[1])}if(e.startsWith("sync/")){const i=e.split("/");return pi(i[1])}return t&&typeof t.app_id=="string"?pi(t.app_id):!1}}var Ie=(s=>(s[s.InvalidAppId=0]="InvalidAppId",s[s.AppNotConfiguredForWebPush=1]="AppNotConfiguredForWebPush",s[s.WrongSiteUrl=2]="WrongSiteUrl",s[s.MultipleInitialization=3]="MultipleInitialization",s[s.MissingSafariWebId=4]="MissingSafariWebId",s[s.Unknown=5]="Unknown",s))(Ie||{});class he extends A{reason;constructor(e,t){let i;switch(e){case 0:i="OneSignal: This app ID does not match any existing app. Double check your app ID.";break;case 1:i="OneSignal: This app ID does not have any web platforms enabled. Double check your app ID, or see step 1 on our setup guide (https://tinyurl.com/2x5jzk83).";break;case 2:t&&t.siteUrl?i=`OneSignal: This web push config can only be used on ${new URL(t.siteUrl).origin}. Your current origin is ${location.origin}.`:i="OneSignal: This web push config can not be used on the current site.";break;case 3:i="OneSignal: The OneSignal web SDK can only be initialized once. Extra initializations are ignored. Please remove calls initializing the SDK more than once.";break;case 4:i="OneSignal: Safari browser support on Mac OS X requires the Safari web platform to be enabled. Please see the Safari Support steps in our web setup guide.";break;case 5:i="OneSignal: An unknown initialization error occurred.";break}super(i),this.reason=Ie[e],Object.setPrototypeOf(this,he.prototype)}}function Ln(s){const e="=".repeat((4-s.length%4)%4),t=(s+e).replace(/-/g,"+").replace(/_/g,"/"),i=atob(t),n=new Uint8Array(i.length);for(let o=0;o<i.length;++o)n[o]=i.charCodeAt(o);return n}function qi(s){return encodeURIComponent(s).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}class fe{static async createUser(e,t){const{appId:i,subscriptionId:n}=e,o=n?{"OneSignal-Subscription-Id":n}:void 0;let r={};return o&&(r={...r,...o}),e.jwtHeader&&(r={...r,...e.jwtHeader}),t.refresh_device_metadata=!0,$.post(`apps/${i}/users`,t,r)}static async getUser(e,t){const{appId:i}=e;return $.get(`apps/${i}/users/by/${t.label}/${t.id}`,e.jwtHeader)}static async updateUser(e,t,i){const{appId:n,subscriptionId:o}=e;if(!V.isValidUuid(n))throw new he(Ie.InvalidAppId);const r=o?{"OneSignal-Subscription-Id":o}:void 0;let c={};r&&(c={...c,...r}),e.jwtHeader&&(c={...c,...e.jwtHeader});const l={label:qi(t.label),id:qi(t.id)};return $.patch(`apps/${n}/users/by/${l.label}/${l.id}`,i,c)}static async deleteUser(e,t){const{appId:i}=e;return $.delete(`apps/${i}/users/by/${t.label}/${t.id}`,e.jwtHeader)}static async addAlias(e,t,i){const{appId:n}=e;return $.patch(`apps/${n}/users/by/${t.label}/${t.id}/identity`,{identity:i},e.jwtHeader)}static async getUserIdentity(e,t){const{appId:i}=e;return $.get(`apps/${i}/users/by/${t.label}/${t.id}/identity`,e.jwtHeader)}static async deleteAlias(e,t,i){const{appId:n}=e;return $.delete(`apps/${n}/users/by/${t.label}/${t.id}/identity/${i}`,e.jwtHeader)}static async createSubscription(e,t,i){const{appId:n}=e;return $.post(`apps/${n}/users/by/${t.label}/${t.id}/subscriptions`,i,e.jwtHeader)}static async updateSubscription(e,t,i){const{appId:n}=e;return $.patch(`apps/${n}/subscriptions/${t}`,{subscription:i})}static async deleteSubscription(e,t){const{appId:i}=e;return $.delete(`apps/${i}/subscriptions/${t}`)}static async getIdentityFromSubscription(e,t){const{appId:i}=e;return $.get(`apps/${i}/subscriptions/${t}/user/identity`)}static async identifyUserForSubscription(e,t,i){const{appId:n}=e;return $.patch(`apps/${n}/users/by/subscriptions/${t}/identity`,{identity:i},e.jwtHeader)}static async transferSubscription(e,t,i,n){const{appId:o}=e;return $.patch(`apps/${o}/subscriptions/${t}/owner`,{identity:{...i},retain_previous_owner:n},e.jwtHeader)}}class _n{_identityModelStore;_buildUserService;_newRecordState;constructor(e,t,i){this._identityModelStore=e,this._buildUserService=t,this._newRecordState=i}get operations(){return[R.SET_ALIAS,R.DELETE_ALIAS]}async execute(e){if(a.debug(`IdentityOperationExecutor(operations: ${JSON.stringify(e)})`),e.filter(h=>!(h instanceof ct||h instanceof Vt)).length>0)throw new Error(`Unrecognized operation(s)! Attempted operations:
${JSON.stringify(e)}`);const i=e.some(h=>h instanceof ct),n=e.some(h=>h instanceof Vt);if(i&&n)throw new Error("Can't process SetAliasOperation and DeleteAliasOperation at the same time.");const o=e[e.length-1],r=o instanceof ct,c=r?fe.addAlias({appId:o.appId},new se(se.ONESIGNAL_ID,o.onesignalId),{[o.label]:o.value}):fe.deleteAlias({appId:o.appId},new se(se.ONESIGNAL_ID,o.onesignalId),o.label),{ok:l,status:d,retryAfterSeconds:g}=await c;if(l)return this._identityModelStore.model.onesignalId===o.onesignalId&&this._identityModelStore.model.setProperty(o.label,r?o.value:void 0,N.HYDRATE),new I(b.SUCCESS);switch(je(d)){case D.RETRYABLE:return new I(b.FAIL_RETRY,g);case D.INVALID:return new I(b.FAIL_NORETRY);case D.CONFLICT:return r?new I(b.FAIL_CONFLICT,g):new I(b.SUCCESS);case D.UNAUTHORIZED:return new I(b.FAIL_UNAUTHORIZED,g);case D.MISSING:{if(d===404&&this._newRecordState.isInMissingRetryWindow(o.onesignalId))return new I(b.FAIL_RETRY,g);if(r){const h=await this._buildUserService.getRebuildOperationsIfCurrentUser(o.appId,o.onesignalId);return h==null?new I(b.FAIL_NORETRY):new I(b.FAIL_RETRY,g,h)}return new I(b.SUCCESS)}}}}class $t{}function Ze(s){return s?.type!==void 0&&s?.id!==void 0}class Ht{static isValidUrl(e,t){if(t&&t.allowNull&&e===null)return!0;if(t&&t.allowEmpty&&e==null)return!0;try{const i=new URL(e);return t&&t.requireHttps?i.protocol==="https:":!0}catch{return!1}}static isValidBoolean(e,t){return t&&t.allowNull&&e===null?!0:e===!0||e===!1}static isValidArray(e,t){return t&&t.allowNull&&e===null||t&&t.allowEmpty&&e==null?!0:e instanceof Array}}var Gi=(s=>(s.HttpsPermissionRequest="HTTPS permission request",s.SlidedownPermissionMessage="slidedown permission message",s.SubscriptionBell="subscription bell",s))(Gi||{}),Fe=(s=>(s[s.MissingAppId=0]="MissingAppId",s[s.RedundantPermissionMessage=1]="RedundantPermissionMessage",s[s.PushPermissionAlreadyGranted=2]="PushPermissionAlreadyGranted",s[s.UnsupportedEnvironment=3]="UnsupportedEnvironment",s[s.MissingDomElement=4]="MissingDomElement",s[s.ServiceWorkerNotActivated=5]="ServiceWorkerNotActivated",s))(Fe||{});class Me extends A{description;reason;constructor(e,t){let i;switch(e){case 0:i="Missing required app ID.";break;case 1:{let n="";t&&t.permissionPromptType&&(n=`(${Gi[t.permissionPromptType]})`),i=`Another permission message ${n} is being displayed.`;break}case 2:i="Push permission has already been granted.";break;case 3:i="The current environment does not support this operation.";break;case 5:i="The service worker must be activated first.";break}super(i),this.description=Fe[e],this.reason=e,Object.setPrototypeOf(this,Me.prototype)}}class zi extends $t{_id;_token;_optedIn;_permission;constructor(e,t,i){if(super(),!e||!t){a.warn(`PushSubscriptionNamespace: skipping initialization. One or more required params are falsy: initialize: ${e}, subscription: ${t}`);return}this._optedIn=!t.optedOut,this._permission=i,this._token=t.subscriptionToken,OneSignal.coreDirector.getPushSubscriptionModel().then(n=>{Ze(n)&&(this._id=n.id)}).catch(n=>{a.error(n)}),OneSignal.emitter.on(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,async n=>{this._id=n?.current.id,this._token=n?.current.token}),OneSignal.emitter.on(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,async n=>{this._permission=n})}get id(){return this._id}get token(){return this._token}get optedIn(){return!!this._optedIn&&this._permission==="granted"}async optIn(){if(v("optIn"),await ce(),this._optedIn=!0,await OneSignal.context.permissionManager.getPermissionStatus()!=="granted"){await OneSignal.Notifications.requestPermission();return}await this._enable(!0)}async optOut(){v("optOut"),await ce(),this._optedIn=!1,await this._enable(!1)}addEventListener(e,t){OneSignal.emitter.on(e,t)}removeEventListener(e,t){OneSignal.emitter.off(e,t)}async _enable(e){await ce();const t=await u.getAppConfig(),i=await u.getSubscription();if(!t.appId)throw new Me(Fe.MissingAppId);if(!Ht.isValidBoolean(e))throw new M("enabled",x.Malformed);i.optedOut=!e,await u.setSubscription(i),Q.onInternalSubscriptionSet(i.optedOut).catch(n=>{a.error(n)}),Q.checkAndTriggerSubscriptionChanged().catch(n=>{a.error(n)})}}const qe={Email:"Email",SMS:"SMS",Push:"Push"},J={ChromePush:"ChromePush",Email:"Email",SMS:"SMS",SafariPush:"SafariPush",SafariLegacyPush:"SafariLegacyPush",FirefoxPush:"FirefoxPush"},ee={NoNativePermission:0,Subscribed:1,UserOptedOut:-2,TemporaryWebRecord:-20,ServiceWorkerStatus403:-23,ServiceWorkerStatus404:-24};var yt=(s=>(s[s.ChromeLike=5]="ChromeLike",s[s.SafariLegacy=7]="SafariLegacy",s[s.Firefox=8]="Firefox",s[s.Email=11]="Email",s[s.Edge=12]="Edge",s[s.SMS=14]="SMS",s[s.SafariVapid=17]="SafariVapid",s))(yt||{}),Qe=(s=>(s.Safari="safari",s.Firefox="firefox",s.Chrome="chrome",s.Opera="opera",s.Edge="edge",s.Other="other",s))(Qe||{});class bi{static getEnvironmentInfo(){return{browserType:this.getBrowser(),browserVersion:this.getBrowserVersion(),isBrowserAndSupportsServiceWorkers:this.supportsServiceWorkers(),requiresUserInteraction:this.requiresUserInteraction(),osVersion:this.getOsVersion()}}static getBrowser(){return k().name==="chrome"?Qe.Chrome:k().name==="msedge"?Qe.Edge:k().name==="opera"?Qe.Opera:k().name==="firefox"?Qe.Firefox:this.isMacOSSafari()?Qe.Safari:Qe.Other}static isMacOSSafari(){return typeof window.safari<"u"}static getBrowserVersion(){return y.parseVersionString(k().version)}static supportsServiceWorkers(){return window.navigator&&"serviceWorker"in window.navigator}static requiresUserInteraction(){return this.getBrowser()==="firefox"&&this.getBrowserVersion()>=72||this.getBrowser()==="safari"&&this.getBrowserVersion()>=12.1}static getOsVersion(){return oi.osversion}}class Z{type;token;enabled;notificationTypes;sdk;deviceModel;deviceOs;webAuth;webp256;constructor(e){this.token=this._getToken(e),this.type=Z.getSubscriptionType(),this.enabled=!0,this.notificationTypes=ee.Subscribed,this.sdk=Z.getSdk(),this.deviceModel=Z.getDeviceModel(),this.deviceOs=Z.getDeviceOS(),this.webAuth=e.w3cAuth,this.webp256=e.w3cP256dh}_getToken(e){return e.w3cEndpoint?e.w3cEndpoint.toString():e.safariDeviceToken}serialize(){return{type:this.type,token:this.token,enabled:this.enabled,notification_types:this.notificationTypes,sdk:this.sdk,device_model:this.deviceModel,device_os:this.deviceOs,web_auth:this.webAuth,web_p256:this.webp256}}static getSubscriptionType(){return V.redetectBrowserUserAgent().firefox?J.FirefoxPush:B.useSafariVapidPush()?J.SafariPush:B.useSafariLegacyPush()?J.SafariLegacyPush:J.ChromePush}static getDeviceType(){switch(this.getSubscriptionType()){case J.FirefoxPush:return yt.Firefox;case J.SafariLegacyPush:return yt.SafariLegacy;case J.SafariPush:return yt.SafariVapid}return yt.ChromeLike}static getDeviceOS(){const e=bi.getEnvironmentInfo();return isNaN(e.browserVersion)?-1:e.browserVersion}static getDeviceModel(){return navigator.platform}static getSdk(){return String(si)}}class It extends Ft{constructor(){super(),this.sdk=Z.getSdk(),this.device_model=Z.getDeviceModel(),this.device_os=Z.getDeviceOS()}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(e){this.setProperty("onesignalId",e)}get id(){return this.getProperty("id")}set id(e){this.setProperty("id",e)}get enabled(){return this.getProperty("enabled")}set enabled(e){this.setProperty("enabled",e)}get type(){return this.getProperty("type")}set type(e){this.setProperty("type",e)}get token(){return this.getProperty("token")}set token(e){this.setProperty("token",e)}get notification_types(){return this.getProperty("notification_types")}set notification_types(e){this.setProperty("notification_types",e)}get sdk(){return this.getProperty("sdk")}set sdk(e){this.setProperty("sdk",e)}get device_model(){return this.getProperty("device_model")}set device_model(e){this.setProperty("device_model",e)}get device_os(){return this.getProperty("device_os")}set device_os(e){this.setProperty("device_os",e)}get web_auth(){return this.getProperty("web_auth")}set web_auth(e){this.setProperty("web_auth",e)}get web_p256(){return this.getProperty("web_p256")}set web_p256(e){this.setProperty("web_p256",e)}}class me{static singletonInstance=void 0;static createOrGetInstance(){return me.singletonInstance||(me.singletonInstance=new me),me.singletonInstance}get onesignalId(){const e=OneSignal.coreDirector.getIdentityModel().onesignalId;return xe.isLocalId(e)?void 0:e}validateStringLabel(e,t){if(typeof e!="string")throw new M(t,x.WrongType);if(!e)throw new M(t,x.Empty)}validateArray(e,t){if(!Array.isArray(e))throw new M(t,x.WrongType);if(e.length===0)throw new M(t,x.Empty);for(const i of e)this.validateLabel(i,"label")}validateObject(e,t){if(!Rn(e))throw new M(t,x.WrongType);if(!e||Object.keys(e).length===0)throw new M(t,x.Empty)}validateLabel(e,t){if(this.validateStringLabel(e,t),e==="external_id"||e==="onesignal_id")throw new M(e,x.Reserved)}updateIdentityModel(e){const t=OneSignal.coreDirector.getIdentityModel();Object.keys(e).forEach(i=>{t.setProperty(i,e[i])})}addAlias(e,t){v("addAlias",{label:e,id:t}),this.validateStringLabel(e,"label"),this.validateStringLabel(t,"id"),this.addAliases({[e]:t})}addAliases(e){v("addAliases",{aliases:e}),this.validateObject(e,"aliases");for(const t of Object.keys(e))this.validateStringLabel(e[t],`key: ${t}`),this.validateLabel(t,`key: ${t}`);this.updateIdentityModel(e)}removeAlias(e){v("removeAlias",{label:e}),this.removeAliases([e])}removeAliases(e){v("removeAliases",{aliases:e}),this.validateArray(e,"aliases");const t=Object.fromEntries(e.map(i=>[i,void 0]));this.updateIdentityModel(t)}async addSubscriptionToModels({type:e,token:t}){if(OneSignal.coreDirector.subscriptionModelStore.list().find(r=>r.token===t&&r.type===e))return;const n={id:xe.createLocalId(),enabled:!0,notification_types:ee.Subscribed,onesignalId:OneSignal.coreDirector.getIdentityModel().onesignalId,token:t,type:e},o=new It;o.mergeData(n),OneSignal.coreDirector.addSubscriptionModel(o)}validateUserExists(){const e=!!OneSignal.coreDirector.getIdentityModel().onesignalId;return e||a.error("Call login before adding an email/sms subscription"),e}async addEmail(e){if(this.validateUserExists()){if(v("addEmail",{email:e}),this.validateStringLabel(e,"email"),!An(e))throw new M("email",x.Malformed);this.addSubscriptionToModels({type:J.Email,token:e})}}async addSms(e){this.validateUserExists()&&(v("addSms",{sms:e}),this.validateStringLabel(e,"sms"),this.addSubscriptionToModels({type:J.SMS,token:e}))}removeEmail(e){v("removeEmail",{email:e}),this.validateStringLabel(e,"email"),OneSignal.coreDirector.getEmailSubscriptionModels().forEach(i=>{i.token===e&&OneSignal.coreDirector.removeSubscriptionModel(i.modelId)})}removeSms(e){v("removeSms",{smsNumber:e}),this.validateStringLabel(e,"smsNumber"),OneSignal.coreDirector.getSmsSubscriptionModels().forEach(i=>{i.token===e&&OneSignal.coreDirector.removeSubscriptionModel(i.modelId)})}addTag(e,t){v("addTag",{key:e,value:t}),this.validateStringLabel(e,"key"),this.validateStringLabel(t,"value"),this.addTags({[e]:t})}addTags(e){v("addTags",{tags:e}),this.validateObject(e,"tags");const t=OneSignal.coreDirector.getPropertiesModel(),i={...t.tags,...e};t.tags=i}removeTag(e){v("removeTag",{tagKey:e}),this.validateStringLabel(e,"tagKey"),this.removeTags([e])}removeTags(e){v("removeTags",{tagKeys:e}),this.validateArray(e,"tagKeys");const t=OneSignal.coreDirector.getPropertiesModel(),i={...t.tags};e.forEach(n=>{i[n]=""}),t.tags=i}getTags(){return v("getTags"),OneSignal.coreDirector.getPropertiesModel().tags}setLanguage(e){v("setLanguage",{language:e}),this.validateStringLabel(e,"language");const t=OneSignal.coreDirector.getPropertiesModel();t.language=e}getLanguage(){return v("getLanguage"),OneSignal.coreDirector.getPropertiesModel().language}}class lt extends $t{_currentUser;PushSubscription=new zi(!1);static emitter=new Lt;constructor(e,t,i){super(),e&&(this._currentUser=me.createOrGetInstance(),this.PushSubscription=new zi(!0,t,i))}get onesignalId(){return this._currentUser?.onesignalId}get externalId(){return OneSignal.coreDirector.getIdentityModel()?.externalId}addAlias(e,t){this._currentUser?.addAlias(e,t)}addAliases(e){this._currentUser?.addAliases(e)}removeAlias(e){this._currentUser?.removeAlias(e)}removeAliases(e){this._currentUser?.removeAliases(e)}addEmail(e){this._currentUser?.addEmail(e)}removeEmail(e){this._currentUser?.removeEmail(e)}addSms(e){this._currentUser?.addSms(e)}removeSms(e){this._currentUser?.removeSms(e)}addTag(e,t){this._currentUser?.addTag(e,t)}addTags(e){this._currentUser?.addTags(e)}removeTag(e){this._currentUser?.removeTag(e)}removeTags(e){this._currentUser?.removeTags(e)}getTags(){return this._currentUser?.getTags()||{}}setLanguage(e){this._currentUser?.setLanguage(e)}getLanguage(){return this._currentUser?.getLanguage()||""}addEventListener(e,t){lt.emitter.on(e,t)}removeEventListener(e,t){lt.emitter.off(e,t)}}var jt=(s=>(s[s.Loaded=0]="Loaded",s[s.Failed=1]="Failed",s))(jt||{});class wi{cache;constructor(){this.cache={}}getCache(){return{...this.cache}}async loadSdkStylesheet(){const e=F.getOneSignalResourceUrlPath(),t=F.getOneSignalCssFileName();return this.loadIfNew(0,new URL(`${e}/${t}?v=${si}`))}async loadIfNew(e,t){return this.cache[t.toString()]||(this.cache[t.toString()]=wi.load(e,t)),this.cache[t.toString()]}static async load(e,t){try{let i;return await new Promise((n,o)=>{switch(e){case 1:i=document.createElement("script"),i.setAttribute("type","text/javascript"),i.setAttribute("async","async"),i.setAttribute("src",t.toString());break;case 0:i=document.createElement("link"),i.setAttribute("rel","stylesheet"),i.setAttribute("href",t.toString());break}i.onerror=o,i.onload=n,document.querySelector("head")?.appendChild(i)}),0}catch{return 1}}}const L={body:"slidedown-body",buttonIndicatorHolder:"onesignal-button-indicator-holder",container:"onesignal-slidedown-container",dialog:"onesignal-slidedown-dialog",footer:"slidedown-footer",reset:"onesignal-reset",savingStateButton:"onesignal-saving-state-button",slideUp:"slide-up",slideDown:"slide-down",closeSlidedown:"close-slidedown",icon:"slidedown-body-icon",message:"slidedown-body-message",defaultIcon:"default-icon",loadingContainer:"onesignal-loading-container",clearfix:"clearfix"},Bn={toastText:"onesignal-toast-text"},Fn={toastText:"onesignal-toast-text"},P={allowButton:"onesignal-slidedown-allow-button",body:"slidedown-body",buttonIndicatorHolder:"onesignal-button-indicator-holder",cancelButton:"onesignal-slidedown-cancel-button",container:"onesignal-slidedown-container",dialog:"onesignal-slidedown-dialog",footer:"slidedown-footer",normalSlidedown:"normal-slidedown",loadingContainer:"onesignal-loading-container"},dt={alignRight:"align-right",primary:"primary",secondary:"secondary",slidedownButton:"slidedown-button"},De={categoryLabelInput:"onesignal-category-label-input",categoryLabelText:"onesignal-category-label-text",categoryLabel:"onesignal-category-label",checkmark:"onesignal-checkmark",taggingContainer:"tagging-container",taggingContainerCol:"tagging-container-col",loadingMessage:"onesignal-loading-message"},Vn={taggingContainer:"tagging-container"},Wn="data:image/svg+xml,%3Csvg fill='none' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Cg clip-path='url(%23clip0)'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M33.232 28.434a2.5 2.5 0 001.768.733 1.667 1.667 0 010 3.333H5a1.667 1.667 0 110-3.333 2.5 2.5 0 002.5-2.5v-8.104A13.262 13.262 0 0118.333 5.122V1.667a1.666 1.666 0 113.334 0v3.455A13.262 13.262 0 0132.5 18.563v8.104a2.5 2.5 0 00.732 1.767zM16.273 35h7.454a.413.413 0 01.413.37 4.167 4.167 0 11-8.28 0 .417.417 0 01.413-.37z' fill='%23BDC4CB'/%3E%3C/g%3E%3Cdefs%3E%3CclipPath id='clip0'%3E%3Cpath fill='%23fff' d='M0 0h40v40H0z'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E",$n="data:image/svg+xml;charset=UTF-8,%3csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7.98775 -0.00114406C5.85015 0.0338508 3.81219 0.908665 2.31442 2.43419C1.565 3.18031 0.973715 4.06987 0.575897 5.04969C0.17808 6.02952 -0.0180997 7.07949 -0.000914196 8.13686C-0.00214385 9.17005 0.200528 10.1933 0.595487 11.148C0.990446 12.1028 1.56993 12.9702 2.30072 13.7005C3.03151 14.4309 3.89925 15.0098 4.85421 15.4042C5.80916 15.7986 6.83256 16.0007 7.86575 15.9989H8.00842C10.1467 15.9769 12.1889 15.1075 13.6869 13.5816C15.185 12.0557 16.0165 9.99781 15.9991 7.85952C16.0015 6.8138 15.7949 5.77814 15.3913 4.81345C14.9876 3.84876 14.3952 2.97451 13.6488 2.24213C12.9023 1.50974 12.017 0.933994 11.0448 0.548751C10.0726 0.163508 9.03324 -0.0234551 7.98775 -0.00114406ZM6.99909 11.0269C6.99428 10.8961 7.01558 10.7658 7.06175 10.6434C7.10792 10.521 7.17803 10.4091 7.26797 10.3141C7.35792 10.2191 7.4659 10.143 7.58559 10.0903C7.70529 10.0375 7.8343 10.0092 7.96509 10.0069H7.98309C8.24616 10.0074 8.49882 10.1097 8.6881 10.2924C8.87739 10.4751 8.9886 10.724 8.99842 10.9869C9.00331 11.1176 8.98207 11.248 8.93594 11.3704C8.8898 11.4928 8.8197 11.6048 8.72974 11.6998C8.63978 11.7948 8.53176 11.8709 8.41202 11.9236C8.29229 11.9763 8.16323 12.0046 8.03242 12.0069H8.01442C7.75145 12.006 7.49897 11.9036 7.30976 11.721C7.12054 11.5383 7.00923 11.2896 6.99909 11.0269ZM7.33242 8.33219V4.33219C7.33242 4.15538 7.40266 3.98581 7.52768 3.86079C7.65271 3.73576 7.82227 3.66552 7.99909 3.66552C8.1759 3.66552 8.34547 3.73576 8.47049 3.86079C8.59551 3.98581 8.66575 4.15538 8.66575 4.33219V8.33219C8.66575 8.509 8.59551 8.67857 8.47049 8.80359C8.34547 8.92862 8.1759 8.99886 7.99909 8.99886C7.82227 8.99886 7.65271 8.92862 7.52768 8.80359C7.40266 8.67857 7.33242 8.509 7.33242 8.33219Z' fill='%23E54B4D'/%3e%3c/svg%3e",Yi={greyLoadingIndicator:"#95A1AC",whiteLoadingIndicator:"#FFFFFF"},Hn={fetchingPreferences:"Fetching your preferences"},G={channelCaptureContainer:"channel-capture-container",inputWithValidationElement:"input-with-validation-element",onesignalErrorInput:"onesignal-error-input",onesignalSmsInput:"iti-onesignal-sms-input",onesignalEmailInput:"onesignal-email-input",onesignalValidationElementHidden:"onesignal-validation-element-hidden",onesignalValidationElement:"onesignal-validation-element"},K={smsInputWithValidationElement:"sms-input-with-validation-element",emailInputWithValidationElement:"email-input-with-validation-element",onesignalSmsInput:"iti-onesignal-sms-input",onesignalEmailInput:"onesignal-email-input",onesignalSmsValidationElement:"onesignal-sms-validation-element",onesignalEmailValidationElement:"onesignal-email-validation-element"},Re={containerClass:"onesignal-customlink-container",subscribeClass:"onesignal-customlink-subscribe",explanationClass:"onesignal-customlink-explanation",resetClass:"onesignal-reset",hide:"hide",state:{subscribed:"state-subscribed",unsubscribed:"state-unsubscribed"}},jn={containerSelector:`.${Re.containerClass}`};class Ki{config;constructor(e){this.config=e}async initialize(){if(!this.config?.enabled||!await this.loadSdkStyles())return;a.info("OneSignal: initializing customlink");const e=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();if(!this.config?.unsubscribeEnabled&&e){this.hideCustomLinkContainers();return}for(let t=0;t<this.customlinkContainerElements.length;t++)await this.injectMarkup(this.customlinkContainerElements[t])}async injectMarkup(e){e.innerHTML="",await this.mountExplanationNode(e),await this.mountSubscriptionNode(e)}async mountExplanationNode(e){if(!this.config?.text){a.error("CustomLink: required property 'text' is missing in the config");return}if(this.config.text.explanation){const t=document.createElement("p");t.textContent=this.config.text.explanation,m(t,Re.resetClass),m(t,Re.explanationClass),this.config.size&&m(t,this.config.size),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?m(t,Re.state.subscribed):m(t,Re.state.unsubscribed),e.appendChild(t)}}async mountSubscriptionNode(e){if(!this.config?.text){a.error("CustomLink: required property 'text' is missing in the config");return}if(this.config.text.subscribe){const t=document.createElement("button");m(t,Re.resetClass),m(t,Re.subscribeClass),this.config.size&&m(t,this.config.size),this.config.style&&m(t,this.config.style),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?m(t,Re.state.subscribed):m(t,Re.state.unsubscribed),this.setCustomColors(t),await this.setTextFromPushStatus(t),t.addEventListener("click",async()=>{a.info("CustomLink: subscribe clicked"),await this.handleClick(t)}),t.setAttribute("type","button"),e.appendChild(t)}}async loadSdkStyles(){return await OneSignal.context.dynamicResourceLoader.loadSdkStylesheet()!==jt.Loaded?(a.debug("Not initializing custom link button because styles failed to load."),!1):!0}hideElement(e){m(e,Re.hide)}hideCustomLinkContainers(){this.customlinkContainerElements.forEach(e=>{this.hideElement(e)})}async handleClick(e){if(OneSignal.User.PushSubscription.optedIn)await OneSignal.User.PushSubscription.optOut(),await this.setTextFromPushStatus(e);else{await OneSignal.User.PushSubscription.optIn(),this.config?.unsubscribeEnabled||this.hideCustomLinkContainers();return}}async setTextFromPushStatus(e){this.config?.text?.subscribe&&(await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()||(e.textContent=this.config.text.subscribe)),this.config?.text?.unsubscribe&&await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()&&(e.textContent=this.config.text.unsubscribe)}setCustomColors(e){!this.config?.color||!this.config.color.text||(this.config?.style==="button"&&this.config?.color.button?(e.style.backgroundColor=this.config?.color.button,e.style.color=this.config?.color.text):this.config?.style==="link"&&(e.style.color=this.config?.color.text))}get customlinkContainerElements(){const e=document.querySelectorAll(jn.containerSelector);return Array.prototype.slice.call(e)}}class H{static store={};static LIMIT=2;static put(e,t){return H.store[e]===void 0&&(H.store[e]=[null,null]),H.store[e].push(t),H.store[e].length==H.LIMIT+1&&H.store[e].shift(),H.store[e]}static get(e){return H.store[e]===void 0&&(H.store[e]=[null,null]),H.store[e]}static getFirst(e){return H.get(e)[0]}static getLast(e){return H.get(e)[1]}static remove(e){delete H.store[e]}static isEmpty(e){const t=H.get(e);return t[0]===null&&t[1]===null}}class vt{static decodeHtmlEntities(e){return typeof DOMParser>"u"?e:new DOMParser().parseFromString(e,"text/html").documentElement.textContent||""}}var qt=(s=>(s[s.Unknown=0]="Unknown",s[s.NoDeviceId=1]="NoDeviceId",s[s.NoEmailSet=2]="NoEmailSet",s[s.NoSMSSet=3]="NoSMSSet",s[s.OptedOut=4]="OptedOut",s))(qt||{});class Gt extends A{reason;constructor(e){let t;switch(e){case 1:t="This operation can only be performed after the user is subscribed.";break;case 2:t="No email is currently set.";break;case 3:t="No sms is currently set.";break;case 4:t="The user has manually opted out of receiving of notifications. This operation can only be performed after the user is fully resubscribed.";break}super(t),this.reason=qt[e],Object.setPrototypeOf(this,Gt.prototype)}}class j{static async showLocalNotification(e,t,i,n,o,r){if(v("MainHelper:showLocalNotification: ",e,t,i,n,o,r),!(await u.getAppConfig()).appId)throw new Me(Fe.MissingAppId);if(!OneSignal.Notifications.permission)throw new Gt(qt.NoDeviceId);if(!Ht.isValidUrl(i))throw new M("url",x.Malformed);if(!Ht.isValidUrl(n,{allowEmpty:!0,requireHttps:!0}))throw new M("icon",x.Malformed);if(!n){const g=await j.getNotificationIcons();n=hi(g)}const l=g=>{const S=[];for(let h=0;h<g.length;h++){const E=g[h];S.push({action:E.id,title:E.text,icon:E.icon,url:E.url})}return S},d={data:o,launchURL:i,buttons:r?l(r):void 0};OneSignal.context.serviceWorkerManager.getRegistration().then(async g=>{if(!g){a.error("Service worker registration not available.");return}const S={body:t,data:d,icon:n,actions:r?l(r):[]};g.showNotification(e,S)})}static async checkAndTriggerNotificationPermissionChanged(){const e=await u.get("Options","notificationPermission"),t=await OneSignal.context.permissionManager.getPermissionStatus();e!==t&&(await Ne.triggerNotificationPermissionChanged(),await u.put("Options",{key:"notificationPermission",value:t}))}static async getNotificationIcons(){const e=j.getAppId();if(!e)throw new Me(Fe.MissingAppId);const t=`${F.getOneSignalApiUrl().toString()}apps/${e}/icon`,n=await(await fetch(t)).json();if(n.errors)throw a.error(`API call ${t}`,"failed with:",n.errors),new Error("Failed to get notification icons.");return n}static getSlidedownOptions(e){return y.getValueOrDefault(e.slidedown,{prompts:[]})}static getFullscreenPermissionMessageOptions(e){return e?e.fullscreen?{autoAcceptTitle:e.fullscreen.autoAcceptTitle,actionMessage:e.fullscreen.actionMessage,exampleNotificationTitleDesktop:e.fullscreen.title,exampleNotificationTitleMobile:e.fullscreen.title,exampleNotificationMessageDesktop:e.fullscreen.message,exampleNotificationMessageMobile:e.fullscreen.message,exampleNotificationCaption:e.fullscreen.caption,acceptButton:e.fullscreen.acceptButton,cancelButton:e.fullscreen.cancelButton}:e:null}static getPromptOptionsQueryString(){const e=j.getFullscreenPermissionMessageOptions(OneSignal.config.userConfig.promptOptions);let t="";if(e){const i=j.getPromptOptionsPostHash();for(const n of Object.keys(i)){const o=i[n];t+="&"+n+"="+o}}return t}static getPromptOptionsPostHash(){const e=j.getFullscreenPermissionMessageOptions(OneSignal.config.userConfig.promptOptions),t={};if(e){const i={exampleNotificationTitleDesktop:"exampleNotificationTitle",exampleNotificationMessageDesktop:"exampleNotificationMessage",exampleNotificationTitleMobile:"exampleNotificationTitle",exampleNotificationMessageMobile:"exampleNotificationMessage"};for(const o of Object.keys(i)){const r=i[o];e[o]&&(e[r]=e[o])}const n=["autoAcceptTitle","siteName","autoAcceptTitle","subscribeText","showGraphic","actionMessage","exampleNotificationTitle","exampleNotificationMessage","exampleNotificationCaption","acceptButton","cancelButton","timeout"];for(let o=0;o<n.length;o++){const r=n[o],c=e[r],l=encodeURIComponent(c);(c||c===!1||c==="")&&(t[r]=l)}}return t}static getAppId(){return OneSignal.config?.appId||""}static async getDeviceId(){return(await OneSignal.database.getSubscription()).deviceId||void 0}static async getCurrentPushToken(){if(B.useSafariLegacyPush())return window.safari?.pushNotification?.permission(OneSignal.config.safariWebId).deviceToken?.toLowerCase()||void 0;const e=await OneSignal.context.serviceWorkerManager.getRegistration();return e?(await e.pushManager.getSubscription())?.endpoint:void 0}}var f=(s=>(s.Native="native",s.Push="push",s.Category="category",s.Sms="sms",s.Email="email",s.SmsAndEmail="smsAndEmail",s))(f||{});class Se{static isCategorySlidedownConfigured(e){if(!e)return!1;const t=Se.getFirstSlidedownPromptOptionsWithType(e,f.Category);return t?!!t.categories&&t.categories.length>0:!1}static isCategorySlidedownConfiguredVersion1(e){return(e?.categories?.tags?.length||0)>0}static getFirstSlidedownPromptOptionsWithType(e,t){return e?e.filter(i=>i.type===t)[0]:void 0}static isSlidedownAutoPromptConfigured(e){if(!e)return!1;for(let t=0;t<e.length;t++)if(e[t].autoPrompt)return!0;return!1}static isSlidedownPushDependent(e){return e===f.Push||e===f.Category}}class Q{static onNotificationPermissionChange(){Q.checkAndTriggerSubscriptionChanged()}static async onInternalSubscriptionSet(e){H.put("subscription.optedOut",e)}static async checkAndTriggerSubscriptionChanged(){V.logMethodCall("checkAndTriggerSubscriptionChanged");const e=OneSignal.context,t=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),i=await OneSignal.context.subscriptionManager.isOptedIn(),n=await u.getAppState(),{lastKnownPushEnabled:o,lastKnownPushId:r,lastKnownPushToken:c,lastKnownOptedIn:l}=n,d=await j.getCurrentPushToken(),S=(await OneSignal.coreDirector.getPushSubscriptionModel())?.id;if(!(o===null||t!==o||d!==c||S!==r))return;await e.subscriptionManager.updateNotificationTypes(),n.lastKnownPushEnabled=t,n.lastKnownPushToken=d,n.lastKnownPushId=S,n.lastKnownOptedIn=i,await u.setAppState(n);const E={previous:{id:r,token:c,optedIn:l??!0},current:{id:S,token:d,optedIn:i}};a.info("Push Subscription state changed: ",E),Q.triggerSubscriptionChanged(E)}static async _onSubscriptionChanged(e){Q.onSubscriptionChanged_showWelcomeNotification(e?.current?.optedIn,e?.current?.id),Q.onSubscriptionChanged_sendCategorySlidedownTags(e?.current?.optedIn),Q.onSubscriptionChanged_evaluateNotifyButtonDisplayPredicate(),Q.onSubscriptionChanged_updateCustomLink()}static async onSubscriptionChanged_sendCategorySlidedownTags(e){if(e!==!0)return;const t=OneSignal.context.appConfig.userConfig.promptOptions?.slidedown?.prompts;Se.isCategorySlidedownConfigured(t)&&await OneSignal.context.tagManager.sendTags()}static async onSubscriptionChanged_showWelcomeNotification(e,t){if(OneSignal.__doNotShowWelcomeNotification){a.debug("Not showing welcome notification because user has previously subscribed.");return}const i=OneSignal.config?.userConfig.welcomeNotification;if(i!==void 0&&i.disable===!0||e!==!0||!t)return;let o=i!==void 0&&i.title!==void 0&&i.title!==null?i.title:"",r=i!==void 0&&i.message!==void 0&&i.message!==null&&i.message.length>0?i.message:"Thanks for subscribing!";const c=new URL(location.href).origin+"?_osp=do_not_open",l=i&&i.url&&i.url.length>0?i.url:c;o=vt.decodeHtmlEntities(o),r=vt.decodeHtmlEntities(r),a.debug("Sending welcome notification."),j.showLocalNotification(o,r,l,void 0,{__isOneSignalWelcomeNotification:!0},void 0),C.trigger(OneSignal.EVENTS.WELCOME_NOTIFICATION_SENT,{title:o,message:r,url:l})}static async onSubscriptionChanged_evaluateNotifyButtonDisplayPredicate(){if(!OneSignal.config.userConfig.notifyButton)return;const e=OneSignal.config.userConfig.notifyButton.displayPredicate;e&&typeof e=="function"&&OneSignal.notifyButton&&(await e()!==!1?(a.debug("Showing notify button because display predicate returned true."),OneSignal.notifyButton.launcher.show()):(a.debug("Hiding notify button because display predicate returned false."),OneSignal.notifyButton.launcher.hide()))}static async onSubscriptionChanged_updateCustomLink(){OneSignal.config.userConfig.promptOptions&&new Ki(OneSignal.config.userConfig.promptOptions.customlink).initialize()}static triggerSubscriptionChanged(e){C.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,e)}static triggerUserChanged(e){C.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,e,lt.emitter)}static triggerNotificationClick(e){const t={notification:e.notification,result:e.result};return C.trigger(OneSignal.EVENTS.NOTIFICATION_CLICKED,t)}static async fireStoredNotificationClicks(){await ce();const e=OneSignal.config.pageUrl||OneSignal.config.userConfig.pageUrl||document.URL;async function t(o){const r=await u.getAppState();r.pendingNotificationClickEvents[o.result.url]=null,await u.setAppState(r);const c=o.timestamp;c&&(Date.now()-c)/1e3/60>5||Q.triggerNotificationClick(o)}const i=await u.getAppState();if(await u.get("Options","notificationClickHandlerMatch")==="origin"){for(const o of Object.keys(i.pendingNotificationClickEvents))if(new URL(o).origin===location.origin){const r=i.pendingNotificationClickEvents[o];await t(r)}}else{let o=i.pendingNotificationClickEvents[e];if(o)await t(o);else if(!o&&e.endsWith("/")){const r=e.substring(0,e.length-1);o=i.pendingNotificationClickEvents[r],o&&await t(o)}}}static async checkAndTriggerUserChanged(){V.logMethodCall("checkAndTriggerUserChanged");const e=await u.getUserState(),{previousOneSignalId:t,previousExternalId:i}=e,n=await OneSignal.coreDirector.getIdentityModel(),o=n?.onesignalId,r=n?.externalId;if(!(o!==t||r!==i))return;e.previousOneSignalId=o,e.previousExternalId=r,await u.setUserState(e);const l={current:{onesignalId:o,externalId:r}};a.info("User state changed: ",l),Q.triggerUserChanged(l)}}const qn="isOptedOut",Gn="isPushNotificationsEnabled",Ji="os_pageViews",Zi="requiresPrivacyConsent";class ut{static removeLegacySubscriptionOptions(){localStorage.removeItem(qn),localStorage.removeItem(Gn)}static setConsentRequired(e){localStorage.setItem(Zi,e.toString())}static getConsentRequired(){return localStorage.getItem(Zi)==="true"}static setLocalPageViewCount(e){localStorage.setItem(Ji,e.toString())}static getLocalPageViewCount(){return Number(localStorage.getItem(Ji))}}class yi extends bt{constructor(e,t,i,n){super(e,t,i),n&&(this.subscriptionId=n)}get subscriptionId(){return this.getProperty("subscriptionId")}set subscriptionId(e){this.setProperty("subscriptionId",e)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Subscription.${this.subscriptionId}`}get canStartExecute(){return!xe.isLocalId(this.onesignalId)&&!xe.isLocalId(this.subscriptionId)}get applyToRecordId(){return this.subscriptionId}translateIds(e){super.translateIds(e),e[this.subscriptionId]&&(this.subscriptionId=e[this.subscriptionId])}}class Qi extends yi{constructor(e,t,i,n){super(e,t,i),n&&(this.sdk=Z.getSdk(),this.device_model=Z.getDeviceModel(),this.device_os=Z.getDeviceOS(),this.enabled=n.enabled,this.notification_types=n.notification_types,this.subscriptionId=n.subscriptionId,this.token=n.token,this.type=n.type,this.web_auth=n.web_auth,this.web_p256=n.web_p256)}get type(){return this.getProperty("type")}set type(e){this.setProperty("type",e)}get token(){return this.getProperty("token")}set token(e){this.setProperty("token",e)}get enabled(){return this.getProperty("enabled")}set enabled(e){this.setProperty("enabled",e)}get notification_types(){return this.getProperty("notification_types")}set notification_types(e){this.setProperty("notification_types",e)}get sdk(){return this.getProperty("sdk")}set sdk(e){this.setProperty("sdk",e)}get device_model(){return this.getProperty("device_model")}set device_model(e){this.setProperty("device_model",e)}get device_os(){return this.getProperty("device_os")}set device_os(e){this.setProperty("device_os",e)}get web_auth(){return this.getProperty("web_auth")}set web_auth(e){this.setProperty("web_auth",e)}get web_p256(){return this.getProperty("web_p256")}set web_p256(e){this.setProperty("web_p256",e)}}class Ge extends Qi{constructor(e){super(R.CREATE_SUBSCRIPTION,e?.appId,e?.onesignalId,e)}get canStartExecute(){return!xe.isLocalId(this.onesignalId)}get applyToRecordId(){return this.onesignalId}translateIds(e){e[this.onesignalId]&&(this.onesignalId=e[this.onesignalId])}}class pt extends yi{constructor(e,t,i){super(R.DELETE_SUBSCRIPTION,e,t),i&&(this.subscriptionId=i)}get groupComparisonType(){return Be.NONE}}class gt extends bt{constructor(e,t,i,n){super(R.LOGIN_USER,e,t),i&&(this.externalId=i),n&&(this.existingOnesignalId=n)}get externalId(){return this.getProperty("externalId")}set externalId(e){this.setProperty("externalId",e)}get existingOnesignalId(){return this.getProperty("existingOnesignalId")}set existingOnesignalId(e){this.setProperty("existingOnesignalId",e)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}get modifyComparisonKey(){return""}get groupComparisonType(){return Be.CREATE}get canStartExecute(){return!this.existingOnesignalId||!xe.isLocalId(this.existingOnesignalId)}get applyToRecordId(){return this.existingOnesignalId??this.onesignalId}translateIds(e){this.existingOnesignalId&&e[this.existingOnesignalId]&&(this.existingOnesignalId=e[this.existingOnesignalId])}}class Et extends bt{constructor(e,t){super(R.REFRESH_USER,e,t)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Refresh`}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Refresh`}get groupComparisonType(){return Be.CREATE}}class Ot extends yi{constructor(e,t,i){super(R.TRANSFER_SUBSCRIPTION,e,t),i&&(this.subscriptionId=i)}get groupComparisonType(){return Be.NONE}get modifyComparisonKey(){return`${this.appId}.Subscription.${this.subscriptionId}.Transfer`}}class ht extends Qi{constructor(e){super(R.UPDATE_SUBSCRIPTION,e?.appId,e?.onesignalId,e)}}class zn{constructor(e,t,i,n){this._identityOperationExecutor=e,this._identityModelStore=t,this._propertiesModelStore=i,this._subscriptionsModelStore=n}get operations(){return[R.LOGIN_USER]}async execute(e){a.debug(`LoginUserOperationExecutor(operation: ${JSON.stringify(e)})`);const t=e[0];if(t instanceof gt)return this.loginUser(t,e.slice(1));throw new Error(`Unrecognized operation: ${t.name}`)}async loginUser(e,t){const i=ut.getConsentRequired(),n=await u.getConsentGiven();if(i&&!n)throw new A("Login: Consent required but not given, skipping login");if(!e.existingOnesignalId||!e.externalId)return this.createUser(e,t);const o=await this._identityOperationExecutor.execute([new ct(e.appId,e.existingOnesignalId,Ae.EXTERNAL_ID,e.externalId)]);switch(o.result){case b.SUCCESS:{const r=e.existingOnesignalId,c=e.onesignalId;return this._identityModelStore.model.onesignalId===c&&this._identityModelStore.model.setProperty(Ae.ONESIGNAL_ID,r,N.HYDRATE),this._propertiesModelStore.model.onesignalId===c&&this._propertiesModelStore.model.setProperty("onesignalId",r,N.HYDRATE),new I(b.SUCCESS_STARTING_ONLY,void 0,void 0,{[e.onesignalId]:r})}case b.FAIL_CONFLICT:return a.debug(`Handling 409 for externalId: ${e.externalId}`),this.createUser(e,t);case b.FAIL_NORETRY:return a.error(`Recovering from SetAlias failure for externalId: ${e.externalId}`),this.createUser(e,t);default:return new I(o.result)}}async createUser(e,t){const i={};let n={};const o={timezone_id:Dn(),language:B.getLanguage()};e.externalId&&(i[Ae.EXTERNAL_ID]=e.externalId);for(const S of t)if(S instanceof Ge||S instanceof Ot||S instanceof ht||S instanceof pt)n=this.createSubscriptionsFromOperation(S,n);else throw new Error(`Unrecognized operation: ${S.name}`);const r=Object.entries(n),c=await fe.createUser({appId:e.appId},{identity:i,subscriptions:r.map(([,S])=>S),properties:o});if(c.ok){const S=c.result.identity.onesignal_id,h=e.onesignalId,E={[e.onesignalId]:S};this._identityModelStore.model.onesignalId===h&&this._identityModelStore.model.setProperty(Ae.ONESIGNAL_ID,S,N.HYDRATE),this._propertiesModelStore.model.onesignalId===h&&this._propertiesModelStore.model.setProperty("onesignalId",S,N.HYDRATE);const w=c.result.properties;if(w)for(const[pe,we]of Object.entries(w))this._propertiesModelStore.model.setProperty(pe,we,N.HYDRATE);for(let pe=0;pe<r.length;pe++){const[we]=r[pe],We=c.result.subscriptions?.[pe];if(!We||!("id"in We))continue;E[we]=We.id,await u.getPushId()===we&&(await u.setPushId(We.id),await u.setPushToken(We.token));const Dt=this._subscriptionsModelStore.getBySubscriptionId(we);Dt?.setProperty("id",We.id,N.HYDRATE),Dt?.setProperty("onesignalId",S,N.HYDRATE)}Q.checkAndTriggerUserChanged();const _=Object.keys(i).length>0?[new Et(e.appId,S)]:void 0;return new I(b.SUCCESS,void 0,_,E)}const{status:l,retryAfterSeconds:d}=c;switch(je(l)){case D.RETRYABLE:return new I(b.FAIL_RETRY,d);case D.UNAUTHORIZED:return new I(b.FAIL_UNAUTHORIZED,d);default:return new I(b.FAIL_PAUSE_OPREPO)}}createSubscriptionsFromOperation(e,t){switch(!0){case e instanceof Ge:{const i=e.subscriptionId;return{...t,[i]:{enabled:e.enabled,device_model:e.device_model,device_os:e.device_os,notification_types:e.notification_types,sdk:e.sdk,token:e.token,type:e.type,web_auth:e.web_auth,web_p256:e.web_p256}}}case e instanceof ht:{const i=e.subscriptionId;return t[i]?{...t,[i]:{...t[i],enabled:e.enabled,notification_types:e.notification_types,token:e.token}}:t}case e instanceof Ot:{const i=e.subscriptionId;return{...t,[i]:{...t[i],id:i}}}case e instanceof pt:{const i={...t};return delete i[e.subscriptionId],i}default:return t}}}var Tt=(s=>(s[s.ResubscribeExisting=0]="ResubscribeExisting",s[s.SubscribeNew=1]="SubscribeNew",s))(Tt||{});class Xe{static async registerForPush(){return await Xe.internalRegisterForPush()}static async internalRegisterForPush(){const e=OneSignal.context;let t=null;switch(F.getWindowEnv()){case X.Host:try{const i=await e.subscriptionManager.subscribe(Tt.ResubscribeExisting);t=await e.subscriptionManager.registerSubscription(i),e.pageViewManager.incrementPageViewCount(),await Ne.triggerNotificationPermissionChanged(),await Q.checkAndTriggerSubscriptionChanged()}catch(i){a.error(i)}break;default:throw new Me(Fe.UnsupportedEnvironment)}return t}static isPushSubscriptionType(e){switch(e){case J.ChromePush:case J.SafariPush:case J.SafariLegacyPush:case J.FirefoxPush:return!0;default:return!1}}static toSubscriptionChannel(e){switch(e){case J.Email:return qe.Email;case J.SMS:return qe.SMS;default:return this.isPushSubscriptionType(e)?qe.Push:void 0}}}class zt extends Ft{get onesignalId(){return this.getProperty(Ae.ONESIGNAL_ID)}set onesignalId(e){this.setProperty(Ae.ONESIGNAL_ID,e)}get externalId(){return this.getProperty(Ae.EXTERNAL_ID)}set externalId(e){this.setProperty(Ae.EXTERNAL_ID,e)}}class Yt extends Ft{constructor(){super()}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(e){this.setProperty("onesignalId",e)}get ip(){return this.getProperty("ip")}set ip(e){this.setProperty("ip",e)}get country(){return this.getProperty("country")}set country(e){this.setProperty("country",e)}get language(){return this.getProperty("language")}set language(e){this.setProperty("language",e)}get timezone_id(){return this.getProperty("timezone_id")}set timezone_id(e){this.setProperty("timezone_id",e)}get tags(){return this.getProperty("tags")??{}}set tags(e){this.setProperty("tags",e)}}class Yn{constructor(e,t,i,n,o){this._identityModelStore=e,this._propertiesModelStore=t,this._subscriptionsModelStore=i,this._buildUserService=n,this._newRecordState=o}get operations(){return[R.REFRESH_USER]}async execute(e){if(a.debug(`RefreshUserOperationExecutor(operation: ${JSON.stringify(e)})`),e.some(i=>!(i instanceof Et)))throw new Error(`Unrecognized operation(s)! Attempted operations:
${JSON.stringify(e)}`);const t=e[0];return this.getUser(t)}async getUser(e){const t=await fe.getUser({appId:e.appId},new se(Ae.ONESIGNAL_ID,e.onesignalId)),{ok:i,result:n,retryAfterSeconds:o,status:r}=t;if(i){if(e.onesignalId!==this._identityModelStore.model.onesignalId)return new I(b.SUCCESS);const l=new zt;for(const[w,_]of Object.entries(n.identity))l.setProperty(w,_);const d=new Yt;d.onesignalId=e.onesignalId;const{properties:g={},subscriptions:S=[]}=n;Object.entries(g).forEach(([w,_])=>{d.setProperty(w,_)});const h=[];for(const w of S){const _=new It;_.id=w.id,_.token=w.token??"",_.notification_types=w.notification_types??ee.Subscribed,_.type=w.type,_.enabled=_.notification_types!==ee.UserOptedOut,_.sdk=w.sdk??"",_.device_os=w.device_os??"",_.device_model=w.device_model??"",_.onesignalId=e.onesignalId,Xe.isPushSubscriptionType(_.type)||h.push(_)}const E=await u.getPushId();if(E){const w=this._subscriptionsModelStore.getBySubscriptionId(E);w&&(w.onesignalId=e.onesignalId,h.push(w))}return this._identityModelStore.replace(l,N.HYDRATE),this._propertiesModelStore.replace(d,N.HYDRATE),this._subscriptionsModelStore.replaceAll(h,N.HYDRATE),new I(b.SUCCESS)}switch(je(r)){case D.RETRYABLE:return new I(b.FAIL_RETRY,o);case D.UNAUTHORIZED:return new I(b.FAIL_UNAUTHORIZED,o);case D.MISSING:{if(r===404&&this._newRecordState.isInMissingRetryWindow(e.onesignalId))return new I(b.FAIL_RETRY,o);const l=await this._buildUserService.getRebuildOperationsIfCurrentUser(e.appId,e.onesignalId);return l?new I(b.FAIL_RETRY,o,l):new I(b.FAIL_NORETRY)}default:return new I(b.FAIL_NORETRY)}}}class Kn{constructor(e,t,i){this._subscriptionModelStore=e,this._buildUserService=t,this._newRecordState=i}get operations(){return[R.CREATE_SUBSCRIPTION,R.UPDATE_SUBSCRIPTION,R.DELETE_SUBSCRIPTION,R.TRANSFER_SUBSCRIPTION]}async execute(e){a.debug(`SubscriptionOperationExecutor(operations: ${e})`);const t=e[0];if(t instanceof Ge)return this.createSubscription(t,e);if(e.some(i=>i instanceof pt)){if(e.length>1)throw new Error(`Only supports one operation! Attempted operations:
${e}`);return this.deleteSubscription(e[0])}if(t instanceof ht)return this.updateSubscription(e);if(t instanceof Ot){if(e.length>1)throw new Error(`TransferSubscriptionOperation only supports one operation! Attempted operations:
${e}`);return this.transferSubscription(t)}throw new Error(`Unrecognized operation: ${t}`)}async createSubscription(e,t){if(t.some(h=>h instanceof pt))return new I(b.SUCCESS);const i=t.toReversed().find(h=>h instanceof ht),n=i?.enabled??e.enabled,o=i?.token??e.token,r=i?.notification_types??e.notification_types,c={sdk:e.sdk,type:e.type,enabled:n,token:o,notification_types:r},l=await fe.createSubscription({appId:e.appId},new se(Ae.ONESIGNAL_ID,e.onesignalId),{subscription:c});if(l.ok){const{subscription:h}=l.result,E=this._subscriptionModelStore.getBySubscriptionId(e.subscriptionId),w=h?.id;return w&&(E?.setProperty("id",w,N.HYDRATE),E?.setProperty("onesignalId",e.onesignalId,N.HYDRATE)),await u.getPushId()===e.subscriptionId&&(await u.setPushId(w),await u.setPushToken(h?.token)),new I(b.SUCCESS,void 0,w?void 0:[new Et(e.appId,e.onesignalId)],w?{[e.subscriptionId]:w}:void 0)}const{retryAfterSeconds:d,status:g}=l;switch(je(g)){case D.RETRYABLE:return new I(b.FAIL_RETRY,d);case D.UNAUTHORIZED:return new I(b.FAIL_UNAUTHORIZED,d);case D.CONFLICT:case D.INVALID:return new I(b.FAIL_NORETRY);case D.MISSING:{if(g===404&&this._newRecordState.isInMissingRetryWindow(e.onesignalId))return new I(b.FAIL_RETRY,d);const h=await this._buildUserService.getRebuildOperationsIfCurrentUser(e.appId,e.onesignalId);return h?new I(b.FAIL_RETRY,d,h):new I(b.FAIL_NORETRY)}}}async updateSubscription(e){const t=e[e.length-1],i={type:t.type,enabled:t.enabled,token:t.token,notification_types:t.notification_types,web_auth:t.web_auth,web_p256:t.web_p256},n=await fe.updateSubscription({appId:t.appId},t.subscriptionId,i);if(n.ok)return new I(b.SUCCESS);const{retryAfterSeconds:o,status:r}=n;switch(je(r)){case D.RETRYABLE:return new I(b.FAIL_RETRY,o);case D.MISSING:return r===404&&[t.onesignalId,t.subscriptionId].some(l=>this._newRecordState.isInMissingRetryWindow(l))?new I(b.FAIL_RETRY,o):new I(b.FAIL_NORETRY,void 0,[new Ge({appId:t.appId,enabled:t.enabled,notification_types:t.notification_types,onesignalId:t.onesignalId,subscriptionId:t.subscriptionId,token:t.token,type:t.type})]);default:return new I(b.FAIL_NORETRY)}}async transferSubscription(e){const t=await fe.transferSubscription({appId:e.appId},e.subscriptionId,{onesignal_id:e.onesignalId},!1);if(t.ok)return new I(b.SUCCESS);const{retryAfterSeconds:i,status:n}=t;switch(je(n)){case D.RETRYABLE:return new I(b.FAIL_RETRY,i);default:return new I(b.FAIL_NORETRY)}}async deleteSubscription(e){const t=await fe.deleteSubscription({appId:e.appId},e.subscriptionId);if(t.ok)return this._subscriptionModelStore.remove(e.subscriptionId,N.HYDRATE),new I(b.SUCCESS);const{retryAfterSeconds:i,status:n}=t;switch(je(n)){case D.MISSING:return[e.onesignalId,e.subscriptionId].some(r=>this._newRecordState.isInMissingRetryWindow(r))?new I(b.FAIL_RETRY,i):new I(b.SUCCESS);case D.RETRYABLE:return new I(b.FAIL_RETRY,i);default:return new I(b.FAIL_NORETRY)}}}class Ii{ip;tags;language;timezone_id;country;constructor(e={}){this.ip=e.ip,this.tags=e.tags,this.language=e.language,this.timezone_id=e.timezone_id,this.country=e.country}get hasAtLeastOnePropertySet(){return Object.values(this).some(e=>e!==void 0)}}class Ct extends bt{constructor(e,t,i,n){super(R.SET_PROPERTY,e,t),i&&n&&(this.property=i,this.value=n)}get property(){return this.getProperty("property")}set property(e){this.setProperty("property",e)}get value(){return this.getProperty("value")}set value(e){this.setProperty("value",e)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}}class Jn{static createPropertiesFromOperation(e,t){if(e instanceof Ct){const i=e.property;return Object.keys(t).includes(i)?new Ii({...t,[i]:e.value}):new Ii({...t})}throw new Error(`Unsupported operation type: ${e.name}`)}}class Zn{constructor(e,t,i,n){this._identityModelStore=e,this._propertiesModelStore=t,this._buildUserService=i,this._newRecordState=n}get operations(){return[R.SET_PROPERTY]}processOperations(e){let t=null,i=null,n=new Ii;const o=!1;for(const r of e)if(r instanceof Ct)t||(t=r.appId,i=r.onesignalId),n=Jn.createPropertiesFromOperation(r,n);else throw new Error(`Unrecognized operation: ${r}`);return{appId:t,onesignalId:i,propertiesObject:n,refreshDeviceMetadata:o}}async execute(e){a.debug(`UpdateUserOperationExecutor(operation: ${e})`);const{appId:t,onesignalId:i,propertiesObject:n,refreshDeviceMetadata:o}=this.processOperations(e);if(!t||!i)return new I(b.SUCCESS);const r=await fe.updateUser({appId:t},new se(se.ONESIGNAL_ID,i),{properties:n,refresh_device_metadata:o}),{ok:c,retryAfterSeconds:l,status:d}=r,g=h=>h.property==="tags";if(c){if(this._identityModelStore.model.onesignalId===i){for(const h of e)if(h instanceof Ct){let E=h.value;if(g(h)){E={...h.value};for(const w in E)E[w]===""&&delete E[w]}this._propertiesModelStore.model.setProperty(h.property,E,N.HYDRATE)}}return new I(b.SUCCESS)}switch(je(d)){case D.RETRYABLE:return new I(b.FAIL_RETRY,l);case D.UNAUTHORIZED:return new I(b.FAIL_UNAUTHORIZED,l);case D.MISSING:{if(d===404&&this._newRecordState.isInMissingRetryWindow(i))return new I(b.FAIL_RETRY,l);const h=await this._buildUserService.getRebuildOperationsIfCurrentUser(t,i);return h?new I(b.FAIL_RETRY,l,h):new I(b.FAIL_NORETRY)}default:return new I(b.FAIL_NORETRY)}}}class Xi{store;opRepo;constructor(e,t){this.store=e,this.opRepo=t,this.store.subscribe(this)}onModelReplaced(e,t){if(t!==N.NORMAL)return;const i=this.getReplaceOperation(e);i!=null&&this.opRepo.enqueue(i)}onModelUpdated(e,t){if(t!==N.NORMAL)return;const i=this.getUpdateOperation(e.model,e.property,e.oldValue,e.newValue);i!=null&&this.opRepo.enqueue(i)}}class Qn extends Xi{constructor(e,t){super(e,t)}getReplaceOperation(e){return null}getUpdateOperation(e,t,i,n){const o=j.getAppId();return n!=null&&typeof n=="string"?new ct(o,e.onesignalId,t,n):new Vt(o,e.onesignalId,t)}}class Xn extends Xi{constructor(e,t){super(e,t)}getReplaceOperation(e){return null}getUpdateOperation(e,t,i,n){const o=j.getAppId();return new Ct(o,e.onesignalId,t,n)}}class es{store;opRepo;constructor(e,t){this.store=e,this.opRepo=t,this.store.subscribe(this)}close(){this.store.unsubscribe(this)}onModelAdded(e,t){if(t!==N.NORMAL)return;const i=this.getAddOperation(e);i!=null&&this.opRepo.enqueue(i)}async onModelUpdated(e,t){if(t!==N.NORMAL)return;const i=await this.getUpdateOperation(e.model,e.property,e.oldValue,e.newValue);i!=null&&this.opRepo.enqueue(i)}async onModelRemoved(e,t){if(t!==N.NORMAL)return;const i=await this.getRemoveOperation(e);i!=null&&this.opRepo.enqueue(i)}}class Kt extends es{_identityModelStore;constructor(e,t,i){super(e,t),this._identityModelStore=i}getAddOperation(e){const{enabled:t,notification_types:i}=Kt.getSubscriptionEnabledAndStatus(e),n=j.getAppId();return new Ge({appId:n,onesignalId:this._identityModelStore.model.onesignalId,subscriptionId:e.id,type:e.type,enabled:t,token:e.token,notification_types:i})}getRemoveOperation(e){const t=j.getAppId();return new pt(t,this._identityModelStore.model.onesignalId,e.id)}getUpdateOperation(e){const{enabled:t,notification_types:i}=Kt.getSubscriptionEnabledAndStatus(e),n=j.getAppId();return new ht({appId:n,onesignalId:this._identityModelStore.model.onesignalId,subscriptionId:e.id,type:e.type,enabled:t,token:e.token,notification_types:i,web_auth:e.web_auth,web_p256:e.web_p256})}static getSubscriptionEnabledAndStatus(e){let t,i;return e.enabled&&e.notification_types===ee.Subscribed&&e.token?(t=!0,i=ee.Subscribed):(t=!1,i=e.enabled?e.notification_types:ee.UserOptedOut),{enabled:t,notification_types:i}}}class en{constructor(e){this.modelName=e}changeSubscription=new mi;models=[];hasLoadedFromCache=!1;add(e,t=N.NORMAL){const i=this.models.find(n=>n.modelId===e.modelId);i&&this.removeItem(i,t),this.addItem(e,t)}addAt(e,t,i=N.NORMAL){const n=this.models.find(o=>o.modelId===t.modelId);n&&this.removeItem(n,i),this.addItem(t,i,e)}list(){return this.models}get(e){return this.models.find(t=>t.modelId===e)}remove(e,t=N.NORMAL){const i=this.models.find(n=>n.modelId===e);i&&this.removeItem(i,t)}onChanged(e,t){this.persist(),this.changeSubscription.fire(i=>i.onModelUpdated(e,t))}replaceAll(e,t=N.NORMAL){this.clear(t);for(const i of e)this.add(i,t)}clear(e=N.NORMAL){for(const t of this.models)t.unsubscribe(this),this.changeSubscription.fire(i=>i.onModelRemoved(t,e)),u.remove(this.modelName,t.modelId);this.models=[]}addItem(e,t,i){i!==void 0?this.models.splice(i,0,e):this.models.push(e),e.subscribe(this),this.persist(),this.changeSubscription.fire(n=>n.onModelAdded(e,t))}async removeItem(e,t){const i=this.models.findIndex(n=>n.modelId===e.modelId);i!==-1&&this.models.splice(i,1),e.unsubscribe(this),await u.remove(this.modelName,e.modelId),this.persist(),this.changeSubscription.fire(n=>n.onModelRemoved(e,t))}async load(){if(!this.modelName)return;const e=await u.getAll(this.modelName),t=this.models.length>0;for(let i=e.length-1;i>=0;i--){const n=this.create(e[i]);n&&(this.models.unshift(n),n.subscribe(this))}this.hasLoadedFromCache=!0,t&&this.persist()}async persist(){if(!(!this.modelName||!this.hasLoadedFromCache))for(const e of this.models)await u.put(this.modelName,{modelId:e.modelId,modelName:this.modelName,...e.toJSON()})}subscribe(e){this.changeSubscription.subscribe(e)}unsubscribe(e){this.changeSubscription.unsubscribe(e)}get hasSubscribers(){return this.changeSubscription.hasSubscribers}}class ts extends en{constructor(){super(ge.Operations)}async loadOperations(){return this.load()}create(e){if(e===null)return a.error("null jsonObject sent to OperationModelStore.create"),null;if(!this.isValidOperation(e))return null;const t=e.name;let i;switch(t){case R.SET_ALIAS:i=new ct;break;case R.DELETE_ALIAS:i=new Vt;break;case R.CREATE_SUBSCRIPTION:i=new Ge;break;case R.UPDATE_SUBSCRIPTION:i=new ht;break;case R.DELETE_SUBSCRIPTION:i=new pt;break;case R.TRANSFER_SUBSCRIPTION:i=new Ot;break;case R.LOGIN_USER:i=new gt;break;case R.REFRESH_USER:i=new Et;break;case R.SET_PROPERTY:i=new Ct;break;default:throw new Error(`Unrecognized operation: ${t}`)}return i.initializeFromJson(e),i}isValidOperation(e){const t=e?.name;if(!t)return a.error("jsonObject must have 'name' attribute"),!1;const i=new Set([R.LOGIN_USER]);return!e.onesignalId&&!i.has(t)?(a.error(`${t} jsonObject must have 'onesignalId' attribute`),!1):!0}}class is{constructor(e,t,i){this._identityModelStore=e,this._propertiesModelStore=t,this._subscriptionsModelStore=i}async getRebuildOperationsIfCurrentUser(e,t){const i=new zt;i.initializeFromModel(null,this._identityModelStore.model),new Yt().initializeFromModel(null,this._propertiesModelStore.model);const o=[];for(const d of this._subscriptionsModelStore.list()){const g=new It;g.initializeFromModel(null,d),o.push(g)}if(i.onesignalId!==t)return null;const r=[];r.push(new gt(e,t,i.externalId));const c=await u.getPushId(),l=o.find(d=>d.id===c);return l&&r.push(new Ge({appId:e,onesignalId:t,subscriptionId:l.id,type:l.type,enabled:l.enabled,token:l.token,notification_types:l.notification_types})),r.push(new Et(e,t)),r}}class vi extends en{_create;constructor(e,t){super(t),this._create=e,this.load()}create(e){const t=this._create();return e!=null&&t.initializeFromJson(e),t}}class tn{store;changeSubscription=new mi;constructor(e){this.store=e,e.subscribe(this)}get model(){const e=this.store.list()[0];if(e)return e;const t=this.store.create();if(!t)throw new Error(`Unable to initialize model from store ${this.store}`);return this.store.add(t),t}replace(e,t){const i=this.model;i.initializeFromModel(i.modelId,e),this.store.persist(),this.changeSubscription.fire(n=>n.onModelReplaced(i,t))}subscribe(e){this.changeSubscription.subscribe(e)}unsubscribe(e){this.changeSubscription.unsubscribe(e)}get hasSubscribers(){return this.changeSubscription.hasSubscribers}onModelAdded(){}onModelUpdated(e,t){this.changeSubscription.fire(i=>i.onModelUpdated(e,t))}onModelRemoved(){}}class ns extends tn{constructor(){super(new vi(()=>new zt,ge.Identity))}}class ss extends tn{constructor(){super(new vi(()=>new Yt,ge.Properties))}}class os extends vi{constructor(){super(()=>new It,ge.Subscriptions)}getBySubscriptionId(e){return super.list().find(t=>t.id===e)}replaceAll(e,t){if(t!==N.HYDRATE)return super.replaceAll(e,t);for(const i of e)if(Xe.isPushSubscriptionType(i.type)){const n=this.get(i.modelId);n&&(i.sdk=n.sdk,i.device_os=n.device_os);break}super.replaceAll(e,t)}}const rs=5e3,nn=3e3,as=3e3,cs=3e4;class ls{_records=new Map;get records(){return this._records}add(e){this._records.set(e,Date.now())}canAccess(e){if(!e)return!0;const t=this._records.get(e);return t?Date.now()-t>=nn:!0}isInMissingRetryWindow(e){const t=this._records.get(e);return t?Date.now()-t<=cs:!1}}const sn=s=>{u.remove(ge.Operations,s.modelId)};class Jt{operation;bucket;retries;resolver;constructor(e){this.operation=e.operation,this.bucket=e.bucket,this.retries=e.retries??0,this.resolver=e.resolver}toString(){return`bucket:${this.bucket}, retries:${this.retries}, operation:${this.operation}
`}}class ds{constructor(e,t,i){this.operationModelStore=t,this.newRecordState=i,this.executorsMap=new Map;for(const n of e)for(const o of n.operations)this.executorsMap.set(o,n)}executorsMap;queue=[];paused=!0;enqueueIntoBucket=0;get isPaused(){return this.paused}get records(){return this.newRecordState.records}get executeBucket(){return this.enqueueIntoBucket===0?0:this.enqueueIntoBucket-1}containsInstanceOf(e){return this.queue.some(t=>t.operation instanceof e)}async start(){this.paused=!1,await this.loadSavedOperations(),this.processQueueForever()}enqueue(e){a.debug(`OperationRepo.enqueue(operation: ${e})`),this.internalEnqueue(new Jt({operation:e,bucket:this.enqueueIntoBucket}),!0)}async enqueueAndWait(e){a.debug(`OperationRepo.enqueueAndWaitoperation: ${e})`),await new Promise(t=>{this.internalEnqueue(new Jt({operation:e,bucket:this.enqueueIntoBucket,resolver:t}),!0)})}internalEnqueue(e,t,i){if(this.queue.some(o=>o.operation.modelId===e.operation.modelId)){a.debug(`OperationRepo: internalEnqueue - operation.modelId: ${e.operation.modelId} already exists in the queue.`);return}i!==void 0?this.queue.splice(i,0,e):this.queue.push(e),t&&this.operationModelStore.add(e.operation)}async processQueueForever(){this.enqueueIntoBucket++;let e=!1;setInterval(async()=>{if(this.paused)return a.debug("OpRepo is paused");if(e)return a.debug("Operations in progress");const t=this.getNextOps(this.executeBucket);a.debug(`processQueueForever:ops:
${t}`),t?(e=!0,await this.executeOperations(t),e=!1):this.enqueueIntoBucket++},as)}async executeOperations(e){try{const t=e[0],i=this.executorsMap.get(t.operation.name);if(!i)throw new Error(`Could not find executor for operation ${t.operation.name}`);const n=e.map(l=>l.operation),o=await i.execute(n),r=o.idTranslations;a.debug(`OperationRepo: execute response = ${o.result}`),r&&(e.forEach(l=>l.operation.translateIds(r)),this.queue.forEach(l=>l.operation.translateIds(r)),Object.values(r).forEach(l=>this.newRecordState.add(l)));let c=0;switch(o.result){case b.SUCCESS:e.forEach(l=>{this.operationModelStore.remove(l.operation.modelId)}),e.forEach(l=>l.resolver?.(!0));break;case b.FAIL_UNAUTHORIZED:case b.FAIL_NORETRY:case b.FAIL_CONFLICT:a.error(`Operation execution failed without retry: ${n}`),e.forEach(l=>{this.operationModelStore.remove(l.operation.modelId)}),e.forEach(l=>l.resolver?.(!1));break;case b.SUCCESS_STARTING_ONLY:this.operationModelStore.remove(t.operation.modelId),t.resolver?.(!0),e.filter(l=>l!==t).reverse().forEach(l=>this.queue.unshift(l));break;case b.FAIL_RETRY:a.error(`Operation execution failed, retrying: ${n}`),e.toReversed().forEach(l=>{sn(l.operation),l.retries++,l.retries>c&&(c=l.retries),this.queue.unshift(l)});break;case b.FAIL_PAUSE_OPREPO:a.error(`Operation execution failed with eventual retry, pausing the operation repo: ${n}`),this.paused=!0,e.toReversed().forEach(l=>{sn(l.operation),this.queue.unshift(l)});break}if(o.operations)for(const l of o.operations.toReversed()){const d=new Jt({operation:l,bucket:0});this.queue.unshift(d),this.operationModelStore.addAt(0,d.operation)}await this.delayBeforeNextExecution(c,o.retryAfterSeconds),o.idTranslations&&await rt(nn)}catch(t){a.error(`Error attempting to execute operation: ${e}`,t),e.forEach(i=>{this.operationModelStore.remove(i.operation.modelId)}),e.forEach(i=>i.resolver?.(!1))}}async delayBeforeNextExecution(e,t){a.debug(`retryAfterSeconds: ${t}`);const i=(t||0)*1e3,n=e*rs,o=Math.max(n,i);o<1||(a.error(`Operations being delay for: ${o} ms`),await rt(o))}getNextOps(e){const t=this.queue.findIndex(i=>i.operation.canStartExecute&&this.newRecordState.canAccess(i.operation.applyToRecordId)&&i.bucket<=e);if(t!==-1){const i=this.queue[t];return this.queue.splice(t,1),this.getGroupableOperations(i)}return null}getGroupableOperations(e){const t=[e];if(e.operation.groupComparisonType===Be.NONE)return t;const i=e.operation.groupComparisonType===Be.CREATE?e.operation.createComparisonKey:e.operation.modifyComparisonKey,n=[...this.queue];for(const o of n){const r=e.operation.groupComparisonType===Be.CREATE?o.operation.createComparisonKey:o.operation.modifyComparisonKey;if(r===""&&i==="")throw new Error("Both comparison keys cannot be blank!");if(this.newRecordState.canAccess(o.operation.applyToRecordId)&&r===i){const c=this.queue.indexOf(o);c!==-1&&(this.queue.splice(c,1),t.push(o))}}return t}async loadSavedOperations(){await this.operationModelStore.loadOperations();const e=this.operationModelStore.list().toReversed();for(const t of e)this.internalEnqueue(new Jt({operation:t,bucket:this.enqueueIntoBucket}),!1,0)}}class us{operationModelStore;operationRepo;newRecordsState;subscriptionModelStore;identityModelStore;propertiesModelStore;initPromise;rebuildUserService;executors;listeners;constructor(){this.newRecordsState=new ls,this.operationModelStore=new ts,this.identityModelStore=new ns,this.propertiesModelStore=new ss,this.subscriptionModelStore=new os,this.rebuildUserService=new is(this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore),this.executors=this.initializeExecutors(),this.operationRepo=new ds(this.executors,this.operationModelStore,this.newRecordsState),this.listeners=this.initializeListeners(),this.initPromise=this.operationRepo.start()}async init(){return v("CoreModule.init"),this.initPromise}initializeListeners(){return this.operationRepo?[new Qn(this.identityModelStore,this.operationRepo),new Xn(this.propertiesModelStore,this.operationRepo),new Kt(this.subscriptionModelStore,this.operationRepo,this.identityModelStore)]:[]}initializeExecutors(){const e=new _n(this.identityModelStore,this.rebuildUserService,this.newRecordsState),t=new zn(e,this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore),i=new Yn(this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore,this.rebuildUserService,this.newRecordsState),n=new Kn(this.subscriptionModelStore,this.rebuildUserService,this.newRecordsState),o=new Zn(this.identityModelStore,this.propertiesModelStore,this.rebuildUserService,this.newRecordsState);return[e,t,i,n,o]}}class ps{constructor(e){this.core=e}get operationRepo(){return this.core.operationRepo}get identityModelStore(){return this.core.identityModelStore}get propertiesModelStore(){return this.core.propertiesModelStore}get subscriptionModelStore(){return this.core.subscriptionModelStore}generatePushSubscriptionModel(e){v("CoreModuleDirector.generatePushSubscriptionModel",{rawPushSubscription:e});const t=new It;return t.initializeFromJson(new Z(e).serialize()),t.id=xe.createLocalId(),u.setPushId(t.id),this.core.subscriptionModelStore.add(t,N.HYDRATE),t}addSubscriptionModel(e){this.core.subscriptionModelStore.add(e)}removeSubscriptionModel(e){this.core.subscriptionModelStore.remove(e)}getNewRecordsState(){return this.core.newRecordsState}getEmailSubscriptionModels(){return v("CoreModuleDirector.getEmailSubscriptionModels"),this.core.subscriptionModelStore.list().filter(t=>t.type===J.Email)}async hasEmail(){const e=this.getEmailSubscriptionModels();return Object.keys(e).length>0}getSmsSubscriptionModels(){return v("CoreModuleDirector.getSmsSubscriptionModels"),this.core.subscriptionModelStore.list().filter(t=>t.type===J.SMS)}async hasSms(){const e=this.getSmsSubscriptionModels();return Object.keys(e).length>0}getAllPushSubscriptionModels(){return v("CoreModuleDirector.getAllPushSubscriptionModels"),this.core.subscriptionModelStore.list().filter(t=>Xe.isPushSubscriptionType(t.type))}async getPushSubscriptionModelByCurrentToken(){v("CoreModuleDirector.getPushSubscriptionModelByCurrentToken");const e=await j.getCurrentPushToken();if(e)return this.getSubscriptionOfTypeWithToken(qe.Push,e)}async getPushSubscriptionModelByLastKnownToken(){v("CoreModuleDirector.getPushSubscriptionModelByLastKnownToken");const e=await u.getPushToken();if(e)return this.getSubscriptionOfTypeWithToken(qe.Push,e)}async getPushSubscriptionModel(){return v("CoreModuleDirector.getPushSubscriptionModel"),await this.getPushSubscriptionModelByCurrentToken()||await this.getPushSubscriptionModelByLastKnownToken()}getIdentityModel(){return v("CoreModuleDirector.getIdentityModel"),this.core.identityModelStore.model}getPropertiesModel(){return v("CoreModuleDirector.getPropertiesModel"),this.core.propertiesModelStore.model}async getAllSubscriptionsModels(){v("CoreModuleDirector.getAllSubscriptionsModels");const e=this.getEmailSubscriptionModels(),t=this.getSmsSubscriptionModels(),i=await this.getPushSubscriptionModel();return[...e,...t,...i?[i]:[]]}getSubscriptionOfTypeWithToken(e,t){v("CoreModuleDirector.getSubscriptionOfTypeWithToken",{type:e,token:t});let i;switch(e){case qe.Email:i=this.getEmailSubscriptionModels();break;case qe.SMS:i=this.getSmsSubscriptionModels();break;case qe.Push:i=this.getAllPushSubscriptionModels();break;default:return}return i.find(n=>n.token===t)}}var Ei,on;function gs(){if(on)return Ei;on=1,Ei=t;var s=0;function e(){}function t(i,n,o){typeof n=="function"&&(o=n,n={}),n||(n={});var r=n.prefix||"__jp",c=n.name||r+s++,l=n.param||"callback",d=n.timeout!=null?n.timeout:6e4,g=encodeURIComponent,S=document.getElementsByTagName("script")[0]||document.head,h,E;d&&(E=setTimeout(function(){w(),o&&o(new Error("Timeout"))},d));function w(){h.parentNode&&h.parentNode.removeChild(h),window[c]=e,E&&clearTimeout(E)}function _(){window[c]&&w()}return window[c]=function(pe){w(),o&&o(null,pe)},i+=(~i.indexOf("?")?"&":"?")+l+"="+g(c),i=i.replace("?&","?"),h=document.createElement("script"),h.src=i,S.parentNode.insertBefore(h,S),_}return Ei}var hs=gs();const fs=_i(hs);var ve=(s=>(s[s.Direct=1]="Direct",s[s.Indirect=2]="Indirect",s[s.Unattributed=3]="Unattributed",s[s.NotSupported=4]="NotSupported",s))(ve||{});class Zt{static async sendOutcome(e){a.info("Outcome payload:",e);try{await $.post("outcomes/measure",e)}catch(t){a.error("sendOutcome",t)}}}class Oi{static async downloadServerAppConfig(e){return y.enforceAppId(e),(await $.get(`sync/${e}/web`,null))?.result}static getUserIdFromSubscriptionIdentifier(e,t,i){return y.enforceAppId(e),$.post("players",{app_id:e,device_type:t,identifier:i,notification_types:ee.TemporaryWebRecord}).then(n=>n?.result?.id?n.result.id:null).catch(n=>(a.debug("Error getting user ID from subscription identifier:",n),null))}static async updateUserSession(e,t,i){const n=new se(se.ONESIGNAL_ID,t),o={refresh_device_metadata:!0,deltas:{session_count:1}};y.enforceAppId(e),y.enforceAlias(n);try{await fe.updateUser({appId:e,subscriptionId:i},n,o)}catch(r){a.debug("Error updating user session:",r)}}static async sendSessionDuration(e,t,i,n,o){const r={refresh_device_metadata:!0,deltas:{session_time:n}},c=new se(se.ONESIGNAL_ID,t),l={id:"os__session_duration",app_id:e,session_time:n,notification_ids:o.notificationIds,subscription:{id:i,type:Z.getSubscriptionType()},onesignal_id:t};l.direct=o.type===ve.Direct;try{await fe.updateUser({appId:e,subscriptionId:i},c,r),l.notification_ids&&l.notification_ids.length>0&&await Zt.sendOutcome(l)}catch(d){a.debug("Error sending session duration:",d)}}}class Ti{static jsonpLib(e,t){fs(e,null,t)}static async downloadServerAppConfig(e){return F.getWindowEnv()===X.Host?await new Promise((t,i)=>{Ti.jsonpLib(`${F.getOneSignalApiUrl().toString()}sync/${e}/web`,(n,o)=>{n?i(n):o.success?t(o):i(o)})}):await Oi.downloadServerAppConfig(e)}}const Ci={reportingThreshold:30,enableOnSessionForUnsubcribed:!1,enableOnFocus:!0},de={pageViews:1,timeDelay:0},oe={actionMessage:"We'd like to show you notifications for the latest news and updates.",acceptButton:"Allow",cancelButton:"Cancel",errorButton:"Try Again",categoryDefaults:{updateMessage:"Update your push notification subscription preferences.",positiveUpdateButton:"Save Preferences",negativeUpdateButton:"Cancel"},savingText:"Saving...",confirmMessage:"Thank You!"},Pi={type:f.Push,text:{actionMessage:oe.actionMessage,acceptButton:oe.acceptButton,cancelButton:oe.cancelButton},autoPrompt:!1,delay:de};var Qt=(s=>(s.TypicalSite="typical",s.WordPress="wordpress",s.Shopify="shopify",s.Blogger="blogger",s.Magento="magento",s.Drupal="drupal",s.SquareSpace="squarespace",s.Joomla="joomla",s.Weebly="weebly",s.Wix="wix",s.Custom="custom",s))(Qt||{});class Ee{static convertTagsApiToBooleans(e){const t={};return Object.keys(e).forEach(i=>{t[i]=e[i]==="1"}),t}static convertTagsBooleansToApi(e){const t={};return Object.keys(e).forEach(i=>{t[i]=e[i]===!0?"1":"0"}),t}static getObjectDifference(e,t){const i={};return Object.keys(e).forEach(n=>{t[n]!==e[n]&&(i[n]=e[n])}),i}static markAllTagsAsSpecified(e,t){e.forEach(i=>{i.checked=t})}static isTagObjectEmpty(e){return Object.keys(e).length===0}static getCheckedTagCategories(e,t){if(!t)return e;if(Ee.isTagObjectEmpty(t)){const o=fi(e);return Ee.markAllTagsAsSpecified(o,!0),o}return fi(e).map(o=>{const r=t[o.tag];return o.checked=Ee.getCheckedStatusForTagValue(r),o})}static getCheckedStatusForTagValue(e){return e===void 0?!0:e}static limitCategoriesToMaxCount(e,t){let i=fi(e);return i=e.slice(0,t),i}}class ft{static upgradeConfigToVersionTwo(e){ft.isPromptOptionsVersion0(e.promptOptions)&&(e.promptOptions=ft.convertConfigToVersionOne(e.promptOptions)),ft.isSlidedownConfigVersion1(e.promptOptions?.slidedown)&&e.promptOptions?.slidedown&&(e.promptOptions.slidedown=ft.convertConfigToVersionTwo(e.promptOptions?.slidedown))}static convertConfigToVersionOne(e){e.slidedown||(e.slidedown={});const{acceptButtonText:t,cancelButtonText:i,actionMessage:n}=e.slidedown,o=e.acceptButtonText||e.acceptButton,r=e.cancelButtonText||e.cancelButton;return e.slidedown.acceptButtonText=t||o,e.slidedown.cancelButtonText=i||r,e.slidedown.actionMessage=n||e.actionMessage,e}static convertConfigToVersionTwo(e){const t=Se.isCategorySlidedownConfiguredVersion1(e)?f.Category:f.Push;let i,n;return t===f.Category&&(i=e.categories?.positiveUpdateButton,n=e.categories?.negativeUpdateButton),{prompts:[...e.prompts||[],{type:t,autoPrompt:e.autoPrompt,text:{actionMessage:e.actionMessage,acceptButton:e.acceptButton||e.acceptButtonText,cancelButton:e.cancelButton||e.cancelButtonText,positiveUpdateButton:i,negativeUpdateButton:n,updateMessage:e?.categories?.updateMessage},delay:{pageViews:e.pageViews,timeDelay:e.timeDelay},categories:e?.categories?.tags}]}}static isPromptOptionsVersion0(e){if(e){const t=["acceptButtonText","cancelButtonText","actionMessage"];for(let i=0;i<t.length;i++)if(e.hasOwnProperty(t[i]))return!0}return!1}static isSlidedownConfigVersion1(e){if(e){const t=["enabled","autoPrompt","pageViews","timeDelay","acceptButton","acceptButtonText","cancelButton","cancelButtonText","actionMessage","customizeTextEnabled","categories"];for(let i=0;i<t.length;i++)if(e.hasOwnProperty(t[i]))return!0}return!1}}const ms=10;class rn{static async getAppConfig(e,t){try{if(!e||!e.appId||!V.isValidUuid(e.appId))throw new he(Ie.InvalidAppId);const i=await t(e.appId);ft.upgradeConfigToVersionTwo(e);const n=this.getMergedConfig(e,i);return this.checkUnsupportedSubdomain(n),this.checkRestrictedOrigin(n),n}catch(i){if(i){if(i.code===1)throw new he(Ie.InvalidAppId);if(i.code===2)throw new he(Ie.AppNotConfiguredForWebPush)}throw i}}static checkUnsupportedSubdomain(e){const t=!self.isSecureContext;if(e.hasUnsupportedSubdomain||t)throw t?new Error("OneSignalSDK: HTTP sites are no longer supported starting with version 16 (User Model), your public site must start with https://. Please visit the OneSignal dashboard's Settings > Web Configuration to find this option."):new Error(`OneSignalSDK: The "My site is not fully HTTPS" option is no longer supported starting with version 16 (User Model) of the OneSignal SDK. Please visit the OneSignal dashboard's Settings > Web Configuration to find this option.`)}static checkRestrictedOrigin(e){if(e.restrictedOriginEnabled&&F.getWindowEnv()===X.Host&&!this.doesCurrentOriginMatchConfigOrigin(e.origin))throw new he(Ie.WrongSiteUrl,{siteUrl:e.origin})}static doesCurrentOriginMatchConfigOrigin(e){try{return location.origin===new URL(e).origin}catch{return!1}}static getIntegrationCapabilities(e){switch(e){case Qt.Custom:case Qt.WordPress:return{configuration:1};default:return{configuration:0}}}static getMergedConfig(e,t){const i=this.getConfigIntegrationKind(t),n=this.hasUnsupportedSubdomainForConfigIntegrationKind(i,e,t),o=this.getUserConfigForConfigIntegrationKind(i,e,t);return{appId:t.app_id,hasUnsupportedSubdomain:n,siteName:t.config.siteInfo.name,origin:t.config.origin,restrictedOriginEnabled:t.features.restrict_origin&&t.features.restrict_origin.enable,safariWebId:t.config.safari_web_id,vapidPublicKey:t.config.vapid_public_key,onesignalVapidPublicKey:t.config.onesignal_vapid_public_key,userConfig:o,enableOnSession:y.valueOrDefault(t.features.enable_on_session,Ci.enableOnSessionForUnsubcribed),sessionThreshold:y.valueOrDefault(t.features.session_threshold,Ci.reportingThreshold),enableSessionDuration:y.valueOrDefault(t.features.web_on_focus_enabled,Ci.enableOnFocus)}}static getConfigIntegrationKind(e){return e.config.integration?e.config.integration.kind:Qt.Custom}static getCustomLinkConfig(e){const t={enabled:!1,style:"button",size:"medium",unsubscribeEnabled:!1,text:{explanation:"",subscribe:"",unsubscribe:""},color:{button:"",text:""}};if(!e||!e.config||!e.config.staticPrompts||!e.config.staticPrompts.customlink||!e.config.staticPrompts.customlink.enabled)return t;const i=e.config.staticPrompts.customlink;return{enabled:i.enabled,style:i.style,size:i.size,unsubscribeEnabled:i.unsubscribeEnabled,text:i.text?{subscribe:i.text.subscribe,unsubscribe:i.text.unsubscribe,explanation:i.text.explanation}:t.text,color:i.color?{button:i.color.button,text:i.color.text}:t.color}}static injectDefaultsIntoPromptOptions(e,t,i){let n={enabled:!1};e&&e.customlink&&(n=e.customlink);const o=t.customlink,r={...e,customlink:{enabled:y.getValueOrDefault(n.enabled,o.enabled),style:y.getValueOrDefault(n.style,o.style),size:y.getValueOrDefault(n.size,o.size),unsubscribeEnabled:y.getValueOrDefault(n.unsubscribeEnabled,o.unsubscribeEnabled),text:{subscribe:y.getValueOrDefault(n.text?n.text.subscribe:void 0,o.text.subscribe),unsubscribe:y.getValueOrDefault(n.text?n.text.unsubscribe:void 0,o.text.unsubscribe),explanation:y.getValueOrDefault(n.text?n.text.explanation:void 0,o.text.explanation)},color:{button:y.getValueOrDefault(n.color?n.color.button:void 0,o.color.button),text:y.getValueOrDefault(n.color?n.color.text:void 0,o.color.text)}}};return r.slidedown?r.slidedown.prompts=r.slidedown?.prompts?.map(c=>{if(c.type=y.getValueOrDefault(c.type,f.Push),c.type===f.Category&&(c.text={...c.text,positiveUpdateButton:y.getValueOrDefault(c.text?.positiveUpdateButton,oe.categoryDefaults.positiveUpdateButton),negativeUpdateButton:y.getValueOrDefault(c.text?.negativeUpdateButton,oe.categoryDefaults.negativeUpdateButton),updateMessage:y.getValueOrDefault(c.text?.updateMessage,oe.categoryDefaults.updateMessage)}),c.text={...c.text,actionMessage:y.getValueOrDefault(c.text?.actionMessage,oe.actionMessage),acceptButton:y.getValueOrDefault(c.text?.acceptButton,oe.acceptButton),cancelButton:y.getValueOrDefault(c.text?.cancelButton,oe.cancelButton),confirmMessage:y.getValueOrDefault(c.text?.confirmMessage,oe.confirmMessage)},c.autoPrompt=y.getValueOrDefault(c.autoPrompt,!0),c.delay={pageViews:y.getValueOrDefault(c.delay?.pageViews,de.pageViews),timeDelay:y.getValueOrDefault(c.delay?.timeDelay,de.timeDelay)},c.categories){const{categories:l}=c;c.categories=Ee.limitCategoriesToMaxCount(l,ms)}return c}):(r.slidedown={prompts:[]},r.slidedown.prompts=[Pi]),r.native?(r.native.enabled=!!r.native.enabled,r.native.autoPrompt=r.native.hasOwnProperty("autoPrompt")?!!r.native.enabled&&!!r.native.autoPrompt:!!r.native.enabled,r.native.pageViews=y.getValueOrDefault(r.native.pageViews,de.pageViews),r.native.timeDelay=y.getValueOrDefault(r.native.timeDelay,de.timeDelay)):r.native={enabled:!1,autoPrompt:!1,pageViews:de.pageViews,timeDelay:de.timeDelay},i.autoRegister===!0&&(r.native.enabled=!0,r.native.autoPrompt=!0),r.autoPrompt=r.native.autoPrompt||Se.isSlidedownAutoPromptConfigured(r.slidedown.prompts),r}static getPromptOptionsForDashboardConfiguration(e){const t=e.config.staticPrompts,i=t.native?{enabled:t.native.enabled,autoPrompt:t.native.enabled&&t.native.autoPrompt!==!1,pageViews:y.getValueOrDefault(t.native.pageViews,de.pageViews),timeDelay:y.getValueOrDefault(t.native.timeDelay,de.timeDelay)}:{enabled:!1,autoPrompt:!1,pageViews:de.pageViews,timeDelay:de.timeDelay},{prompts:n}=t.slidedown;return{autoPrompt:i.autoPrompt||Se.isSlidedownAutoPromptConfigured(n),native:i,slidedown:{prompts:n},fullscreen:{enabled:t.fullscreen.enabled,actionMessage:t.fullscreen.actionMessage,acceptButton:t.fullscreen.acceptButton,cancelButton:t.fullscreen.cancelButton,title:t.fullscreen.title,message:t.fullscreen.message,caption:t.fullscreen.caption,autoAcceptTitle:t.fullscreen.autoAcceptTitle},customlink:this.getCustomLinkConfig(e)}}static getServiceWorkerValues(e,t){const i=e.serviceWorkerOverrideForTypical,n=i?y.getValueOrDefault(e.path,t.config.serviceWorker.path):t.config.serviceWorker.path,o=i?y.getValueOrDefault(e.serviceWorkerParam,{scope:t.config.serviceWorker.registrationScope}):{scope:t.config.serviceWorker.registrationScope},r=i?y.getValueOrDefault(e.serviceWorkerPath,t.config.serviceWorker.workerName):t.config.serviceWorker.workerName;return{path:n,serviceWorkerParam:o,serviceWorkerPath:r}}static getUserConfigForConfigIntegrationKind(e,t,i){switch(this.getIntegrationCapabilities(e).configuration){case 0:{const{path:o,serviceWorkerPath:r,serviceWorkerParam:c}=this.getServiceWorkerValues(t,i);return{appId:i.app_id,autoRegister:!1,autoResubscribe:i.config.autoResubscribe,path:o,serviceWorkerPath:r,serviceWorkerParam:c,subdomainName:i.config.siteInfo.proxyOrigin,promptOptions:this.getPromptOptionsForDashboardConfiguration(i),welcomeNotification:{disable:!i.config.welcomeNotification.enable,title:i.config.welcomeNotification.title,message:i.config.welcomeNotification.message,url:i.config.welcomeNotification.url},notifyButton:{enable:i.config.staticPrompts.bell.enabled,displayPredicate:i.config.staticPrompts.bell.hideWhenSubscribed?()=>!OneSignal.User.PushSubscription.optedIn:null,size:i.config.staticPrompts.bell.size,position:i.config.staticPrompts.bell.location,showCredit:!1,offset:{bottom:`${i.config.staticPrompts.bell.offset.bottom}px`,left:`${i.config.staticPrompts.bell.offset.left}px`,right:`${i.config.staticPrompts.bell.offset.right}px`},colors:{"circle.background":i.config.staticPrompts.bell.color.main,"circle.foreground":i.config.staticPrompts.bell.color.accent,"badge.background":"black","badge.foreground":"white","badge.bordercolor":"black","pulse.color":i.config.staticPrompts.bell.color.accent,"dialog.button.background.hovering":i.config.staticPrompts.bell.color.main,"dialog.button.background.active":i.config.staticPrompts.bell.color.main,"dialog.button.background":i.config.staticPrompts.bell.color.main,"dialog.button.foreground":"white"},text:{"tip.state.unsubscribed":i.config.staticPrompts.bell.tooltip.unsubscribed,"tip.state.subscribed":i.config.staticPrompts.bell.tooltip.subscribed,"tip.state.blocked":i.config.staticPrompts.bell.tooltip.blocked,"message.prenotify":i.config.staticPrompts.bell.tooltip.unsubscribed,"message.action.subscribing":i.config.staticPrompts.bell.message.subscribing,"message.action.subscribed":i.config.staticPrompts.bell.message.subscribing,"message.action.resubscribed":i.config.staticPrompts.bell.message.subscribing,"message.action.unsubscribed":i.config.staticPrompts.bell.message.unsubscribing,"dialog.main.title":i.config.staticPrompts.bell.dialog.main.title,"dialog.main.button.subscribe":i.config.staticPrompts.bell.dialog.main.subscribeButton,"dialog.main.button.unsubscribe":i.config.staticPrompts.bell.dialog.main.unsubscribeButton,"dialog.blocked.title":i.config.staticPrompts.bell.dialog.blocked.title,"dialog.blocked.message":i.config.staticPrompts.bell.dialog.blocked.message}},persistNotification:i.config.notificationBehavior?i.config.notificationBehavior.display.persist:void 0,webhooks:{cors:i.config.webhooks.corsEnable,"notification.willDisplay":i.config.webhooks.notificationDisplayedHook,"notification.clicked":i.config.webhooks.notificationClickedHook,"notification.dismissed":i.config.webhooks.notificationDismissedHook},notificationClickHandlerMatch:i.config.notificationBehavior?i.config.notificationBehavior.click.match:void 0,notificationClickHandlerAction:i.config.notificationBehavior?i.config.notificationBehavior.click.action:void 0,outcomes:{direct:i.config.outcomes.direct,indirect:{enabled:i.config.outcomes.indirect.enabled,influencedTimePeriodMin:i.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:i.config.outcomes.indirect.notification_attribution.limit},unattributed:i.config.outcomes.unattributed}}}case 1:{const o={scope:"/"},c={...t,promptOptions:this.injectDefaultsIntoPromptOptions(t.promptOptions,i.config.staticPrompts,t),serviceWorkerParam:t.serviceWorkerParam?t.serviceWorkerParam:o,serviceWorkerPath:t.serviceWorkerPath?t.serviceWorkerPath:"OneSignalSDKWorker.js",path:t.path?t.path:"/",outcomes:{direct:i.config.outcomes.direct,indirect:{enabled:i.config.outcomes.indirect.enabled,influencedTimePeriodMin:i.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:i.config.outcomes.indirect.notification_attribution.limit},unattributed:i.config.outcomes.unattributed}};return t.hasOwnProperty("autoResubscribe")?c.autoResubscribe=!!t.autoResubscribe:t.hasOwnProperty("autoRegister")?c.autoResubscribe=!!t.autoRegister:c.autoResubscribe=!!i.config.autoResubscribe,c}}}static hasUnsupportedSubdomainForConfigIntegrationKind(e,t,i){switch(this.getIntegrationCapabilities(e).configuration){case 0:return i.config.siteInfo.proxyOriginEnabled;case 1:return!!t.subdomainName}}}class Ss{async getAppConfig(e){return await rn.getAppConfig(e,Ti.downloadServerAppConfig)}getMergedConfig(e,t){return rn.getMergedConfig(e,t)}}class Pt{static async createUserOnServer(){const e=OneSignal.coreDirector.getIdentityModel(),t=j.getAppId(),n=(await OneSignal.coreDirector.getAllSubscriptionsModels()).length>0,o=!!e.externalId;if(!n&&!o)return a.info("No subscriptions or external ID found, skipping user creation");const r=await OneSignal.coreDirector.getPushSubscriptionModel();if(r){const c=r.toJSON();OneSignal.coreDirector.operationRepo.enqueue(new gt(t,e.onesignalId,e.externalId)),await OneSignal.coreDirector.operationRepo.enqueueAndWait(new Ge({...c,appId:t,onesignalId:e.onesignalId,subscriptionId:r.id}))}else OneSignal.coreDirector.operationRepo.enqueue(new gt(t,e.onesignalId,e.externalId))}static resetUserModels(){const e=new zt,t=new Yt,i=xe.createLocalId();e.onesignalId=i,t.onesignalId=i,OneSignal.coreDirector.identityModelStore.replace(e),OneSignal.coreDirector.propertiesModelStore.replace(t)}}class Oe{static switchingUsersPromise=Promise.resolve();static async login(e,t){await(this.switchingUsersPromise=Oe._login(e,t))}static async _login(e,t){t&&u.setJWTToken(t);let i=O.coreDirector.getIdentityModel();const n=i.onesignalId,o=i.externalId;if(o===e){a.debug("Login: External ID already set, skipping login");return}Pt.resetUserModels(),i=O.coreDirector.getIdentityModel(),i.setProperty("external_id",e,N.HYDRATE);const r=i.onesignalId,c=j.getAppId(),l=await O.coreDirector.getPushSubscriptionModel();l&&O.coreDirector.operationRepo.enqueue(new Ot(c,r,l.id)),await O.coreDirector.operationRepo.enqueueAndWait(new gt(c,r,e,o?void 0:n))}static async logout(){await(this.switchingUsersPromise=Oe._logout())}static async _logout(){return O.coreDirector.getIdentityModel().externalId?(Pt.resetUserModels(),Pt.createUserOnServer()):a.debug("Logout: User is not logged in, skipping logout")}}class kt{static async getRegistration(e){try{const t=location.origin+e;return await navigator.serviceWorker.getRegistration(t)}catch(t){a.warn("[Service Worker Status] Error Checking service worker registration",e,t);return}}static getAvailableServiceWorker(e){const t=e.active||e.installing||e.waiting;return t||a.warn("Could not find an available ServiceWorker instance!"),t}static waitUntilActive(e){return new Promise(t=>{const i=e.installing||e.waiting;i&&i.addEventListener("statechange",()=>{a.debug("OneSignal Service Worker state changed:",i.state),e.active&&t()}),e.active&&t()})}}class Xt extends A{status;statusText;constructor(e,t){super("Registration of a Service Worker failed."),this.status=e,this.statusText=t,Object.setPrototypeOf(this,Xt.prototype)}}class Ue{static debug(...e){self.shouldLog&&console.debug(...e)}static trace(...e){self.shouldLog&&console.trace(...e)}static info(...e){self.shouldLog&&console.info(...e)}static warn(...e){self.shouldLog&&console.warn(...e)}static error(...e){self.shouldLog&&console.error(...e)}}function an(s,e){const t=e*1e3;let i,n=()=>{};return{promise:new Promise((r,c)=>{let l=!1;i=self.setTimeout(async()=>{l=!0;try{await s(),r()}catch(d){Ue.error("Failed to execute callback",d),c()}},t),n=()=>{Ue.debug("Cancel called"),self.clearTimeout(i),l||r()}}),cancel:n}}const bs="sendOutcome",ws="sendUniqueOutcome";class Nt{outcomeName;config;appId;isUnique;constructor(e,t,i,n){this.outcomeName=i,this.config=t,this.appId=e,this.isUnique=n}async getAttribution(){return await Nt.getAttribution(this.config)}async beforeOutcomeSend(){const e=this.isUnique?ws:bs;return v(e,this.outcomeName),this.config?this.outcomeName?(await ce(),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?!0:(a.warn("Reporting outcomes is supported only for subscribed users."),!1)):(a.error("Outcome name is required"),!1):(a.debug("Outcomes feature not supported by main application yet."),!1)}async getAttributedNotifsByUniqueOutcomeName(){return(await u.getAll("SentUniqueOutcome")).filter(t=>t.outcomeName===this.outcomeName).reduce((t,i)=>{const n=i.notificationIds||[];return[...t,...n]},[])}async getNotifsToAttributeWithUniqueOutcome(e){const t=await this.getAttributedNotifsByUniqueOutcomeName();return e.filter(i=>t.indexOf(i)===-1)}shouldSendUnique(e,t){return e.type===ve.Unattributed?!0:t.length>0}async saveSentUniqueOutcome(e){const t=this.outcomeName,i=await u.get("SentUniqueOutcome",t),n=await u.getCurrentSession(),r=[...i?i.notificationIds:[],...e],c=n?n.startTimestamp:null;await u.put("SentUniqueOutcome",{outcomeName:t,notificationIds:r,sentDuringSession:c})}async wasSentDuringSession(){const e=await u.get("SentUniqueOutcome",this.outcomeName);if(!e)return!1;const t=await u.getCurrentSession(),i=t&&e.sentDuringSession===t.startTimestamp,n=!t&&!!e.sentDuringSession;return i||n}async send(e){const{type:t,notificationIds:i,weight:n}=e;switch(t){case ve.Direct:this.isUnique&&await this.saveSentUniqueOutcome(i),await OneSignal.context.updateManager.sendOutcomeDirect(this.appId,i,this.outcomeName,n);return;case ve.Indirect:this.isUnique&&await this.saveSentUniqueOutcome(i),await OneSignal.context.updateManager.sendOutcomeInfluenced(this.appId,i,this.outcomeName,n);return;case ve.Unattributed:if(this.isUnique){if(await this.wasSentDuringSession()){a.warn("(Unattributed) unique outcome was already sent during this session");return}await this.saveSentUniqueOutcome([])}await OneSignal.context.updateManager.sendOutcomeUnattributed(this.appId,this.outcomeName,n);return;default:a.warn("You are on a free plan. Please upgrade to use this functionality.");return}}static async getAttribution(e){if(e.direct&&e.direct.enabled){const t=await u.getAllNotificationClickedForOutcomes();if(t.length>0)return{type:ve.Direct,notificationIds:[t[0].notificationId]}}if(e.indirect&&e.indirect.enabled){const t=e.indirect.influencedTimePeriodMin*60*1e3,n=new Date(new Date().getTime()-t).getTime(),o=await u.getAllNotificationReceivedForOutcomes();if(a.debug(`	Found total of ${o.length} received notifications`),o.length>0){const r=e.indirect.influencedNotificationsLimit,c=y.sortArrayOfObjects(o,g=>g.timestamp,!0,!1),l=c.filter(g=>g.timestamp>=n).slice(0,r).map(g=>g.notificationId);a.debug(`	Total of ${l.length} received notifications are within reporting window.`);const d=c.filter(g=>l.indexOf(g.notificationId)===-1).map(g=>g.notificationId);if(d.forEach(g=>u.remove(li,g)),a.debug(`	${d.length} received notifications will be deleted.`),l.length>0)return{type:ve.Indirect,notificationIds:l}}}return e.unattributed&&e.unattributed.enabled?{type:ve.Unattributed,notificationIds:[]}:{type:ve.NotSupported,notificationIds:[]}}}class Te{static getServiceWorkerHref(e,t,i){return Te.appendServiceWorkerParams(e.workerPath.getFullPath(),t,i)}static appendServiceWorkerParams(e,t,i){const n=new URL(e,V.getBaseUrl()).href,o=y.encodeHashAsUriComponent({appId:t}),r=y.encodeHashAsUriComponent({sdkVersion:i});return`${n}?${o}&${r}`}static async upsertSession(e,t,i,n,o,r,c){const l=await u.getCurrentSession();if(!l){const h=$i({appId:e}),E=await u.getLastNotificationClickedForOutcomes(e);E&&(h.notificationId=E.notificationId),await u.upsertSession(h),await Te.sendOnSessionCallIfNotPlayerCreate(e,t,i,r,h);return}if(l.status===ot.Active){Ue.debug("Session already active",l);return}if(!l.lastDeactivatedTimestamp){Ue.debug("Session is in invalid state",l);return}const d=new Date().getTime();if(Te.timeInSecondsBetweenTimestamps(d,l.lastDeactivatedTimestamp)<=n){l.status=ot.Active,l.lastActivatedTimestamp=d,l.lastDeactivatedTimestamp=null,await u.upsertSession(l);return}await Te.finalizeSession(e,t,i,l,o,c);const S=$i({appId:e});await u.upsertSession(S),await Te.sendOnSessionCallIfNotPlayerCreate(e,t,i,r,S)}static async deactivateSession(e,t,i,n,o,r){const c=await u.getCurrentSession();if(!c){Ue.debug("No active session found. Cannot deactivate.");return}const l=()=>Te.finalizeSession(e,t,i,c,o,r);if(c.status===ot.Inactive)return an(l,n);if(c.status!==ot.Active){Ue.warn(`Session in invalid state ${c.status}. Cannot deactivate.`);return}const d=new Date().getTime(),g=Te.timeInSecondsBetweenTimestamps(d,c.lastActivatedTimestamp);c.lastDeactivatedTimestamp=d,c.accumulatedDuration+=g,c.status=ot.Inactive;const S=an(l,n);return await u.upsertSession(c),S}static async sendOnSessionCallIfNotPlayerCreate(e,t,i,n,o){n!==ke.UserCreate&&(u.upsertSession(o),u.resetSentUniqueOutcomes(),await Oi.updateUserSession(e,t,i))}static async finalizeSession(e,t,i,n,o,r){if(Ue.debug("Finalize session",`started: ${new Date(n.startTimestamp)}`,`duration: ${n.accumulatedDuration}s`),o){Ue.debug(`send on_focus reporting session duration -> ${n.accumulatedDuration}s`);const c=await Nt.getAttribution(r);Ue.debug("send on_focus with attribution",c),await Oi.sendSessionDuration(e,t,i,n.accumulatedDuration,c)}await Promise.all([u.cleanupCurrentSession(),u.removeAllNotificationClickedForOutcomes()]),Ue.debug("Finalize session finished",`started: ${new Date(n.startTimestamp)}`)}static timeInSecondsBetweenTimestamps(e,t){return e<=t?0:Math.floor((e-t)/1e3)}}var Le=(s=>(s.OneSignalWorker="OneSignal Worker",s.ThirdParty="3rd Party",s.None="None",s))(Le||{}),Ce=(s=>(s.WorkerVersion="GetWorkerVersion",s.Subscribe="Subscribe",s.SubscribeNew="SubscribeNew",s.NotificationWillDisplay="notification.willDisplay",s.NotificationClicked="notification.clicked",s.NotificationDismissed="notification.dismissed",s.RedirectPage="command.redirect",s.SessionUpsert="os.session.upsert",s.SessionDeactivate="os.session.deactivate",s.AreYouVisible="os.page_focused_request",s.AreYouVisibleResponse="os.page_focused_response",s.SetLogging="os.set_sw_logging",s))(Ce||{});class ys{replies;constructor(){this.replies={}}addListener(e,t,i){const n={callback:t,onceListenerOnly:i},o=this.replies[e.toString()];o?o.push(n):this.replies[e.toString()]=[n]}findListenersForMessage(e){return this.replies[e.toString()]||[]}deleteListenerRecords(e){this.replies[e.toString()]=null}deleteAllListenerRecords(){this.replies={}}deleteListenerRecord(e,t){const i=this.replies[e.toString()];if(i!=null)for(let n=i.length-1;n>=0;n--)i[n]===t&&i.splice(n,1)}}class Is{context;replies;constructor(e,t=new ys){this.context=e,this.replies=t}async broadcast(e,t){if(F.getWindowEnv()!==X.ServiceWorker)return;const i=await self.clients.matchAll({type:"window",includeUncontrolled:!0});for(const n of i)a.debug(`[Worker Messenger] [SW -> Page] Broadcasting '${e.toString()}' to window client ${n.url}.`),n.postMessage({command:e,payload:t})}async unicast(e,t,i){if(F.getWindowEnv()===X.ServiceWorker)if(i)a.debug(`[Worker Messenger] [SW -> Page] Unicasting '${e.toString()}' to window client ${i.url}.`),i.postMessage({command:e,payload:t});else throw new M("windowClient",x.Empty);else a.debug(`[Worker Messenger] [Page -> SW] Unicasting '${e.toString()}' to service worker.`),this.directPostMessageToSW(e,t)}async directPostMessageToSW(e,t){a.debug(`[Worker Messenger] [Page -> SW] Direct command '${e.toString()}' to service worker.`);const i=await this.context?.serviceWorkerManager.getOneSignalRegistration();if(!i){a.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorkerRegistration to postMessage!");return}const n=kt.getAvailableServiceWorker(i);if(!n){a.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorker to postMessage!");return}n.postMessage({command:e,payload:t})}async listen(){if(!B.supportsServiceWorkers())return;F.getWindowEnv()===X.ServiceWorker?(self.addEventListener("message",this.onWorkerMessageReceivedFromPage.bind(this)),a.debug("[Worker Messenger] Service worker is now listening for messages.")):await this.listenForPage()}async listenForPage(){navigator.serviceWorker.addEventListener("message",this.onPageMessageReceivedFromServiceWorker.bind(this)),a.debug(`(${location.origin}) [Worker Messenger] Page is now listening for messages.`)}onWorkerMessageReceivedFromPage(e){const t=e.data;if(!t||!t.command)return;const i=this.replies.findListenersForMessage(t.command),n=[],o=[];a.debug("[Worker Messenger] Service worker received message:",e.data);for(const r of i)r.onceListenerOnly&&n.push(r),o.push(r);for(let r=n.length-1;r>=0;r--){const c=n[r];this.replies.deleteListenerRecord(t.command,c)}for(const r of o)r.callback.apply(null,[t.payload])}onPageMessageReceivedFromServiceWorker(e){const t=e.data;if(!t||!t.command)return;const i=this.replies.findListenersForMessage(t.command),n=[],o=[];a.debug("[Worker Messenger] Page received message:",e.data);for(const r of i)r.onceListenerOnly&&n.push(r),o.push(r);for(let r=n.length-1;r>=0;r--){const c=n[r];this.replies.deleteListenerRecord(t.command,c)}for(const r of o)r.callback.apply(null,[t.payload])}on(e,t){this.replies.addListener(e,t,!1)}once(e,t){this.replies.addListener(e,t,!0)}off(e){e?this.replies.deleteListenerRecords(e):this.replies.deleteAllListenerRecords()}}class et{static QUERY_STRING="?";path;constructor(e){if(!e)throw new M("path",x.Empty);this.path=e.trim()}getQueryString(){const e=this.path.indexOf("?");return e===-1?null:this.path.length>e?this.path.substring(e+1):null}getWithoutQueryString(){return this.path.split(et.QUERY_STRING)[0]}getFileName(){return this.getWithoutQueryString().split("\\").pop()?.split("/").pop()}getFileNameWithQuery(){return this.path.split("\\").pop()?.split("/").pop()}getFullPath(){return this.path}getPathWithoutFileName(){const e=this.getWithoutQueryString(),t=e.lastIndexOf(this.getFileName());let i=e.substring(0,t);return i=i.replace(/[\\/]$/,""),i}}class ki{context;config;constructor(e,t){this.context=e,this.config=t}async getRegistration(){return kt.getRegistration(this.config.registrationOptions.scope)}async getOneSignalRegistration(){if(await this.getActiveState()===Le.OneSignalWorker)return this.getRegistration()}async getActiveState(){const e=await this.getRegistration();if(!e)return Le.None;const t=ki.activeSwFileName(e);return this.swActiveStateByFileName(t)}static activeSwFileName(e){const t=kt.getAvailableServiceWorker(e);if(!t)return null;const i=new URL(t.scriptURL).pathname,n=new et(i).getFileName();if(n=="akam-sw.js"){const r=new URLSearchParams(new URL(t.scriptURL).search).get("othersw");if(r)return a.debug("Found a ServiceWorker under Akamai's akam-sw.js?othersw=",r),new et(new URL(r).pathname).getFileName()}return n}swActiveStateByFileName(e){return e?e==this.config.workerPath.getFileName()||e=="OneSignalSDK.sw.js"?Le.OneSignalWorker:Le.ThirdParty:Le.None}async getWorkerVersion(){return new Promise(async e=>{this.context.workerMessenger.once(Ce.WorkerVersion,t=>{e(t)}),await this.context.workerMessenger.unicast(Ce.WorkerVersion)})}async shouldInstallWorker(){if(!B.supportsServiceWorkers()||!OneSignal.config)return!1;const e=await this.getActiveState();if(a.debug("[shouldInstallWorker] workerState",e),e===Le.None||e===Le.ThirdParty){const i=await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId)==="granted";return i&&a.info("[shouldInstallWorker] Notification Permissions enabled, will install ServiceWorker"),i}return await this.haveParamsChanged()?!0:this.workerNeedsUpdate()}async haveParamsChanged(){const e=await this.getRegistration();if(!e)return a.info("[changedServiceWorkerParams] workerRegistration not found at scope",this.config.registrationOptions.scope),!0;const t=new URL(e.scope).pathname,i=this.config.registrationOptions.scope;if(t!=i)return a.info("[changedServiceWorkerParams] ServiceWorker scope changing",{a_old:t,b_new:i}),!0;const n=kt.getAvailableServiceWorker(e),o=Te.getServiceWorkerHref(this.config,this.context.appConfig.appId,B.version());return n?.scriptURL?o!==n.scriptURL?(a.info("[changedServiceWorkerParams] ServiceWorker href changing:",{a_old:n?.scriptURL,b_new:o}),!0):!1:!0}async workerNeedsUpdate(){a.info("[Service Worker Update] Checking service worker version...");let e;try{e=await y.timeoutPromise(this.getWorkerVersion(),2e3)}catch{return a.info("[Service Worker Update] Worker did not reply to version query; assuming older version and updating."),!0}return e!==B.version()?(a.info(`[Service Worker Update] Updating service worker from ${e} --> ${B.version()}.`),!0):(a.info(`[Service Worker Update] Service worker version is current at ${e} (no update required).`),!1)}async establishServiceWorkerChannel(){a.debug("establishServiceWorkerChannel");const e=this.context.workerMessenger;e.off(),e.on(Ce.NotificationWillDisplay,async i=>{a.debug(location.origin,"Received notification display event from service worker.");const n={notification:i.notification,preventDefault:function(){throw new Error("Browser does not support preventing display.")}};await C.trigger(OneSignal.EVENTS.NOTIFICATION_WILL_DISPLAY,n)}),e.on(Ce.NotificationClicked,async i=>{OneSignal.emitter.numberOfListeners(OneSignal.EVENTS.NOTIFICATION_CLICKED)===0?(a.debug("notification.clicked event received, but no event listeners; storing event in IndexedDb for later retrieval."),i.result.url,await u.putNotificationClickedEventPendingUrlOpening(i)):await Q.triggerNotificationClick(i)}),e.on(Ce.NotificationDismissed,async i=>{await C.trigger(OneSignal.EVENTS.NOTIFICATION_DISMISSED,i)});const t=V.isSafari();e.on(Ce.AreYouVisible,async i=>{if(t){const n={timestamp:i.timestamp,focused:document.hasFocus()};await e.directPostMessageToSW(Ce.AreYouVisibleResponse,n)}})}async installWorker(){if(!await this.shouldInstallWorker())return this.getOneSignalRegistration();a.info("Installing worker..."),await this.getActiveState()===Le.ThirdParty&&a.info("[Service Worker Installation] 3rd party service worker detected.");const t=Te.getServiceWorkerHref(this.config,this.context.appConfig.appId,B.version()),i=`${V.getBaseUrl()}${this.config.registrationOptions.scope}`;a.info(`[Service Worker Installation] Installing service worker ${t} ${i}.`);let n;try{n=await navigator.serviceWorker.register(t,{scope:i,type:void 0})}catch(o){a.error(`[Service Worker Installation] Installing service worker failed ${o}`),n=await this.fallbackToUserModelBetaWorker()}return a.debug("[Service Worker Installation] Service worker installed. Waiting for activation"),await kt.waitUntilActive(n),a.debug("[Service Worker Installation] Service worker active"),await this.establishServiceWorkerChannel(),n}async fallbackToUserModelBetaWorker(){const e="OneSignalSDK.sw.js",t={workerPath:new et(`/${e}`),registrationOptions:this.config.registrationOptions},i=Te.getServiceWorkerHref(t,this.context.appConfig.appId,B.version()),n=`${V.getBaseUrl()}${this.config.registrationOptions.scope}`;a.info(`[Service Worker Installation] Attempting to install v16 Beta Worker ${i} ${n}.`);try{const o=await navigator.serviceWorker.register(i,{scope:n}),r=`
        [Service Worker Installation] Successfully installed v16 Beta Worker.
        Deprecation warning: support for the v16 beta worker name of ${e}
        will be removed May 5 2024. We have decided to keep the v15 name.
        To avoid breaking changes for your users, please host both worker files:
        OneSignalSDK.sw.js & OneSignalSDKWorker.js.
      `;return a.error(r),o}catch(o){const r=await fetch(i);throw r.status===403||r.status===404?new Xt(r.status,r.statusText):o}}}class At extends A{constructor(){super("This code is not implemented yet."),Object.setPrototypeOf(this,At.prototype)}}var tt=(s=>(s[s.Blocked=0]="Blocked",s[s.Dismissed=1]="Dismissed",s[s.Default=2]="Default",s))(tt||{});class ze extends A{reason;constructor(e){let t;switch(e){case 1:t="The user dismissed the permission prompt.";break;case 0:t="Notification permissions are blocked.";break;case 2:t="Notification permissions have not been granted yet.";break}super(t),this.reason=e,Object.setPrototypeOf(this,ze.prototype)}}var cn=(s=>(s[s.InvalidSafariSetup=0]="InvalidSafariSetup",s[s.Blocked=1]="Blocked",s[s.Dismissed=2]="Dismissed",s))(cn||{});class Ni extends A{constructor(e){let t;switch(e){case 0:t="The Safari site URL, icon size, or push certificate is invalid, or Safari is in a private session.";break;case 1:t="Notification permissions are blocked.";break;case 2:t="The notification permission prompt was dismissed.";break}super(t),Object.setPrototypeOf(this,Ni.prototype)}}var re=(s=>(s.Default="default",s.Granted="granted",s.Denied="denied",s))(re||{});class it{w3cEndpoint;w3cP256dh;w3cAuth;safariDeviceToken;static setFromW3cSubscription(e){const t=new it;if(e&&(t.w3cEndpoint=new URL(e.endpoint),e.getKey)){let i=null;try{i=e.getKey("p256dh")}catch{}let n=null;try{n=e.getKey("auth")}catch{}if(i){const o=btoa(String.fromCharCode.apply(null,new Uint8Array(i)));t.w3cP256dh=o}if(n){const o=btoa(String.fromCharCode.apply(null,new Uint8Array(n)));t.w3cAuth=o}}return t}setFromSafariSubscription(e){e&&(this.safariDeviceToken=e)}serialize(){return{w3cEndpoint:this.w3cEndpoint?this.w3cEndpoint.toString():null,w3cP256dh:this.w3cP256dh,w3cAuth:this.w3cAuth,safariDeviceToken:this.safariDeviceToken}}static deserialize(e){const t=new it;if(!e)return t;try{t.w3cEndpoint=new URL(e.w3cEndpoint)}catch{}return t.w3cP256dh=e.w3cP256dh,t.w3cAuth=e.w3cAuth,t.safariDeviceToken=e.safariDeviceToken,t}}var Ai=(s=>(s[s.DestroySubscription=0]="DestroySubscription",s[s.MarkUnsubscribed=1]="MarkUnsubscribed",s))(Ai||{});const vs="99999999-9999-9999-9999-999999999999";class Ve{context;config;safariPermissionPromptFailed=!1;constructor(e,t){this.context=e,this.config=t}async isPushNotificationsEnabled(){const e=await this.getSubscriptionState();return e.subscribed&&!e.optedOut}async isOptedIn(){const e=await this.getSubscriptionState();return await OneSignal.context.permissionManager.getPermissionStatus()==="granted"&&!e.optedOut}async isOptedOut(e){v("isOptedOut",e);const{optedOut:t}=await u.getSubscription();return Nn(e,t),t}async subscribe(e){const t=F.getWindowEnv();let i;switch(t){case X.ServiceWorker:i=await this.subscribeFcmFromWorker(e);break;case X.Host:if(await OneSignal.context.permissionManager.getPermissionStatus()===re.Denied)throw new ze(tt.Blocked);if(B.useSafariLegacyPush()){i=await this.subscribeSafari(),await this._updatePushSubscriptionModelWithRawSubscription(i),a.info("Installing SW on Safari");try{await this.context.serviceWorkerManager.installWorker(),a.info("SW on Safari successfully installed")}catch{a.error("SW on Safari failed to install.")}}else i=await this.subscribeFcmFromPage(e),await this._updatePushSubscriptionModelWithRawSubscription(i);break;default:throw new Me(Fe.UnsupportedEnvironment)}return i}async _updatePushSubscriptionModelWithRawSubscription(e){await Oe.switchingUsersPromise;let t=await OneSignal.coreDirector.getPushSubscriptionModel();if(!t)return t=OneSignal.coreDirector.generatePushSubscriptionModel(e),Pt.createUserOnServer();if(xe.isLocalId(t.id))return Pt.createUserOnServer();const i=new Z(e).serialize();for(const n in i){const o=n;t.setProperty(o,i[o])}}async updateNotificationTypes(){const e=await this.getNotificationTypes();await this.updatePushSubscriptionNotificationTypes(e)}async getNotificationTypes(){const{optedOut:e}=await u.getSubscription();return e?ee.UserOptedOut:await OneSignal.context.permissionManager.getPermissionStatus()==="granted"?ee.Subscribed:ee.NoNativePermission}async updatePushSubscriptionNotificationTypes(e){const t=await OneSignal.coreDirector.getPushSubscriptionModel();if(!t){a.info("No Push Subscription yet to update notification_types.");return}t.notification_types=e,t.enabled=e===ee.Subscribed}async registerSubscription(e,t){e&&(e=it.deserialize(e)),await this.isAlreadyRegisteredWithOneSignal()?await this.context.updateManager.sendPushDeviceRecordUpdate():this.context.sessionManager.upsertSession(ke.UserCreate);const i=await u.getSubscription();return i.deviceId=vs,i.optedOut=!1,e?B.useSafariLegacyPush()?i.subscriptionToken=e.safariDeviceToken:i.subscriptionToken=e.w3cEndpoint?e.w3cEndpoint.toString():null:i.subscriptionToken=null,await u.setSubscription(i),F.getWindowEnv()!==X.ServiceWorker&&C.trigger(OneSignal.EVENTS.REGISTERED),typeof OneSignal<"u"&&(OneSignal._sessionInitAlreadyRunning=!1),i}static async requestPresubscribeNotificationPermission(){return await Ve.requestNotificationPermission()}async unsubscribe(e){if(e===Ai.DestroySubscription)throw new At;if(e===Ai.MarkUnsubscribed)if(F.getWindowEnv()===X.ServiceWorker)await u.put("Options",{key:"optedOut",value:!0});else throw new At;else throw new At}static async requestNotificationPermission(){return await window.Notification.requestPermission()}async isAlreadyRegisteredWithOneSignal(){const{deviceId:e}=await u.getSubscription();return!!e}async subscribeSafariPromptPermission(){const e=t=>new Promise(i=>{window.safari?.pushNotification?.requestPermission(t,this.config.safariWebId,{app_id:this.config.appId},n=>{n&&n.deviceToken?i(n.deviceToken.toLowerCase()):i(null)})});return this.safariPermissionPromptFailed?e(`${F.getOneSignalApiUrl({legacy:!0}).toString()}safari`):e(`${F.getOneSignalApiUrl({legacy:!0}).toString()}safari/apps/${this.config.appId}`)}async subscribeSafari(){const e=new it;if(!this.config.safariWebId)throw new he(Ie.MissingSafariWebId);const{deviceToken:t}=window.safari?.pushNotification?.permission(this.config.safariWebId)||{};if(t)return e.setFromSafariSubscription(t.toLowerCase()),e;C.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const i=await this.subscribeSafariPromptPermission();if(Ne.triggerNotificationPermissionChanged(),i)e.setFromSafariSubscription(i);else throw this.safariPermissionPromptFailed=!0,new Ni(cn.InvalidSafariSetup);return e}async subscribeFcmFromPage(e){if(F.getWindowEnv()===X.Host&&Notification.permission===re.Default){await C.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const i=await Ve.requestPresubscribeNotificationPermission(),n=i===re.Default;switch(await Ne.triggerNotificationPermissionChanged(n),i){case re.Default:throw a.debug("Exiting subscription and not registering worker because the permission was dismissed."),OneSignal._sessionInitAlreadyRunning=!1,new ze(tt.Dismissed);case re.Denied:throw a.debug("Exiting subscription and not registering worker because the permission was blocked."),OneSignal._sessionInitAlreadyRunning=!1,new ze(tt.Blocked)}}let t;try{t=await this.context.serviceWorkerManager.installWorker()}catch(i){throw i instanceof Xt&&(i.status===403?await this.context.subscriptionManager.registerFailedSubscription(ee.ServiceWorkerStatus403,this.context):i.status===404&&await this.context.subscriptionManager.registerFailedSubscription(ee.ServiceWorkerStatus404,this.context)),i}if(!t)throw new Error("OneSignal service worker not found!");return a.debug("[Subscription Manager] Service worker is ready to continue subscribing."),await this.subscribeWithVapidKey(t.pushManager,e)}async subscribeFcmFromWorker(e){const t=self.registration;if(!t.active&&k().name!=="firefox")throw new Me(Fe.ServiceWorkerNotActivated);const i=await t.pushManager.permissionState({userVisibleOnly:!0});if(i==="denied")throw new ze(tt.Blocked);if(i==="prompt")throw new ze(tt.Default);return await this.subscribeWithVapidKey(t.pushManager,e)}getVapidKeyForBrowser(){let e;if(k().name==="firefox"?e=this.config.onesignalVapidPublicKey:e=this.config.vapidPublicKey,e)return Ln(e).buffer}async subscribeWithVapidKey(e,t){const i=await e.getSubscription();switch(t){case Tt.ResubscribeExisting:if(!i)break;i.options?a.debug("[Subscription Manager] An existing push subscription exists and it's options is not null."):(a.debug("[Subscription Manager] An existing push subscription exists and options is null. Unsubscribing from push first now."),await Ve.doPushUnsubscribe(i));break;case Tt.SubscribeNew:i&&await Ve.doPushUnsubscribe(i);break}const[n,o]=await Ve.doPushSubscribe(e,this.getVapidKeyForBrowser());return await Ve.updateSubscriptionTime(o,n.expirationTime),it.setFromW3cSubscription(n)}static async updateSubscriptionTime(e,t){const i=await u.getSubscription();e&&(i.createdAt=new Date().getTime()),i.expirationTime=t,await u.setSubscription(i)}static async doPushUnsubscribe(e){a.debug("[Subscription Manager] Unsubscribing existing push subscription.");const t=await e.unsubscribe();return a.debug(`[Subscription Manager] Unsubscribing existing push subscription result: ${t}`),t}static async doPushSubscribe(e,t){if(!t)throw new Error("Missing required 'applicationServerKey' to subscribe for push notifications!");const i={userVisibleOnly:!0,applicationServerKey:t};a.debug("[Subscription Manager] Subscribing to web push with these options:",i);try{const n=await e.getSubscription();return[await e.subscribe(i),!n]}catch(n){if(n instanceof Me){a.warn("[Subscription Manager] Couldn't re-subscribe due to applicationServerKey changing, unsubscribe and attempting to subscribe with new key.",n);const o=await e.getSubscription();return o&&await Ve.doPushUnsubscribe(o),[await e.subscribe(i),!0]}else throw n}}async isSubscriptionExpiring(){if(await this.context.serviceWorkerManager.getActiveState()!==Le.OneSignalWorker)return!1;const t=await this.context.serviceWorkerManager.getOneSignalRegistration();if(!t||!t.pushManager)return!1;const i=await t.pushManager.getSubscription();if(!i||!i.expirationTime)return!1;let{createdAt:n}=await u.getSubscription();n||(n=new Date().getTime()+31536e6);const o=n+(i.expirationTime-n)/2;return!!i.expirationTime&&(new Date().getTime()>=i.expirationTime||new Date().getTime()>=o)}async getSubscriptionState(){switch(F.getWindowEnv()){case X.ServiceWorker:{const t=await self.registration.pushManager.getSubscription(),{optedOut:i}=await u.getSubscription();return{subscribed:!!t,optedOut:!!i}}default:return this.getSubscriptionStateFromBrowserContext()}}async getSubscriptionStateFromBrowserContext(){const{optedOut:e,subscriptionToken:t}=await u.getSubscription(),i=await OneSignal.coreDirector.getPushSubscriptionModel(),n=Ze(i);if(B.useSafariLegacyPush()){const l=window.safari?.pushNotification?.permission(this.config.safariWebId);return{subscribed:!!(n&&t&&l?.permission==="granted"&&l?.deviceToken),optedOut:!!e}}const o=await this.context.serviceWorkerManager.getOneSignalRegistration(),r=await this.context.permissionManager.getNotificationPermission(this.context.appConfig.safariWebId);return o?{subscribed:!!(n&&t&&r===re.Granted),optedOut:!!e}:{subscribed:!1,optedOut:!!e}}async registerFailedSubscription(e,t){t.pageViewManager.isFirstPageView()&&(t.subscriptionManager.registerSubscription(new it,e),t.pageViewManager.incrementPageViewCount())}}class ln{static getServiceWorkerManager(e){const t=e.appConfig,i={workerPath:new et("OneSignalSDKWorker.js"),registrationOptions:{scope:"/"}};return t.userConfig&&(t.userConfig.path&&(i.workerPath=new et(`${t.userConfig.path}${t.userConfig.serviceWorkerPath}`)),t.userConfig.serviceWorkerParam&&(i.registrationOptions=t.userConfig.serviceWorkerParam)),new ki(e,i)}static getSubscriptionManager(e){const t=e.appConfig,i={safariWebId:t.safariWebId,appId:t.appId,vapidPublicKey:t.vapidPublicKey,onesignalVapidPublicKey:t.onesignalVapidPublicKey};return new Ve(e,i)}}class ei{static SESSION_STORAGE_KEY_NAME="onesignal-pageview-count";incrementedPageViewCount=!1;getPageViewCount(){try{const e=sessionStorage.getItem(ei.SESSION_STORAGE_KEY_NAME),t=e?parseInt(e):0;return isNaN(t)?0:t}catch{return 0}}setPageViewCount(e){try{sessionStorage.setItem(ei.SESSION_STORAGE_KEY_NAME,e.toString())}catch{}}incrementPageViewCount(){if(this.incrementedPageViewCount)return;const e=this.getPageViewCount()+1,t=this.getLocalPageViewCount()+1;this.setPageViewCount(e),this.setLocalPageViewCount(t),this.incrementedPageViewCount=!0,a.debug(`Incremented page view count: newCountSingleTab: ${e},
      newCountAccrossTabs: ${t}.`)}simulatePageNavigationOrRefresh(){this.incrementedPageViewCount=!1}isFirstPageView(){return this.getPageViewCount()===1}getLocalPageViewCount(){return ut.getLocalPageViewCount()}setLocalPageViewCount(e){ut.setLocalPageViewCount(e)}}class xi{static get STORED_PERMISSION_KEY(){return"storedNotificationPermission"}async getPermissionStatus(){if(!OneSignal.context)throw new A("OneSignal.context is undefined. Make sure to call OneSignal.init() before calling getPermissionStatus().");return await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId)}async getNotificationPermission(e){return B.useSafariLegacyPush()?xi.getLegacySafariNotificationPermission(e):this.getW3cNotificationPermission()}static getLegacySafariNotificationPermission(e){if(e)return window.safari.pushNotification.permission(e).permission;throw new M("safariWebId",x.Empty)}getW3cNotificationPermission(){return Notification.permission}}class Es{context;onSessionSent;constructor(e){this.context=e,this.onSessionSent=e.pageViewManager.getPageViewCount()>1}async sendPushDeviceRecordUpdate(){if(!me.singletonInstance?.onesignalId){a.debug("Not sending the update because user is not registered with OneSignal (no onesignal_id)");return}this.onSessionSent||await this.sendOnSessionUpdate()}async sendOnSessionUpdate(){if(this.onSessionSent||!this.context.pageViewManager.isFirstPageView())return;if(!await this.context.subscriptionManager.isAlreadyRegisteredWithOneSignal()){a.debug("Not sending the on session because user is not registered with OneSignal (no device id)");return}if(!((await OneSignal.coreDirector.getPushSubscriptionModel())?.notification_types!==ee.Subscribed&&OneSignal.config?.enableOnSession!==!0))try{this.context.sessionManager.upsertSession(ke.UserNewSession),this.onSessionSent=!0}catch(i){i instanceof Error&&a.error(`Failed to update user session. Error "${i.message}" ${i.stack}`)}}async sendOutcomeDirect(e,t,i,n){v("sendOutcomeDirect");const o=await OneSignal.coreDirector.getPushSubscriptionModel();if(o&&Ze(o)){const r={id:i,app_id:e,notification_ids:t,direct:!0,subscription:{id:o.id,type:Z.getSubscriptionType()}};n!==void 0&&(r.weight=n),await Zt.sendOutcome(r);return}a.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeInfluenced(e,t,i,n){v("sendOutcomeInfluenced");const o=await OneSignal.coreDirector.getPushSubscriptionModel();if(o&&Ze(o)){const r={id:i,app_id:e,notification_ids:t,direct:!1,subscription:{id:o.id,type:Z.getSubscriptionType()}};n!==void 0&&(r.weight=n),await Zt.sendOutcome(r);return}a.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeUnattributed(e,t,i){v("sendOutcomeUnattributed");const n=await OneSignal.coreDirector.getPushSubscriptionModel();if(n&&Ze(n)){const o={id:t,app_id:e,subscription:{id:n.id,type:Z.getSubscriptionType()}};i!==void 0&&(o.weight=i),await Zt.sendOutcome(o);return}a.warn("Send outcome aborted because pushSubscriptionModel is not available.")}}class Os{context;onSessionSent=!1;constructor(e){this.context=e}async notifySWToUpsertSession(e,t,i){const n={onesignalId:e,subscriptionId:t,appId:this.context.appConfig.appId,sessionThreshold:this.context.appConfig.sessionThreshold||0,enableSessionDuration:!!this.context.appConfig.enableSessionDuration,sessionOrigin:i,isSafari:V.isSafari(),outcomesConfig:this.context.appConfig.userConfig.outcomes};this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers?(a.debug("Notify SW to upsert session"),await this.context.workerMessenger.unicast(Ce.SessionUpsert,n)):a.debug("Notify upsert: do nothing")}async notifySWToDeactivateSession(e,t,i){const n={appId:this.context.appConfig.appId,subscriptionId:t,onesignalId:e,sessionThreshold:this.context.appConfig.sessionThreshold,enableSessionDuration:this.context.appConfig.enableSessionDuration,sessionOrigin:i,isSafari:V.isSafari(),outcomesConfig:this.context.appConfig.userConfig.outcomes};this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers?(a.debug("Notify SW to deactivate session"),await this.context.workerMessenger.unicast(Ce.SessionDeactivate,n)):a.debug("Notify deactivate: do nothing")}async _getOneSignalAndSubscriptionIds(){const e=OneSignal.coreDirector.getIdentityModel(),t=await OneSignal.coreDirector.getPushSubscriptionModel();if(!e||!e.onesignalId)throw new A("Abort _getOneSignalAndSubscriptionIds: no identity");if(!t||!Ze(t))throw new A("Abort _getOneSignalAndSubscriptionIds: no subscription");const{onesignalId:i}=e,{id:n}=t;return{onesignalId:i,subscriptionId:n}}async handleVisibilityChange(){if(await Oe.switchingUsersPromise,!!me.singletonInstance?.onesignalId)try{const e=document.visibilityState,{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();if(e==="visible"){this.setupOnFocusAndOnBlurForSession(),a.debug("handleVisibilityChange","visible",`hasFocus: ${document.hasFocus()}`),document.hasFocus()&&await this.notifySWToUpsertSession(t,i,ke.VisibilityVisible);return}if(e==="hidden"){a.debug("handleVisibilityChange","hidden"),OneSignal.cache.focusHandler&&OneSignal.cache.isFocusEventSetup&&(window.removeEventListener("focus",OneSignal.cache.focusHandler,!0),OneSignal.cache.isFocusEventSetup=!1),OneSignal.cache.blurHandler&&OneSignal.cache.isBlurEventSetup&&(window.removeEventListener("blur",OneSignal.cache.blurHandler,!0),OneSignal.cache.isBlurEventSetup=!1),await this.notifySWToDeactivateSession(t,i,ke.VisibilityHidden);return}a.warn("Unhandled visibility state happened",e)}catch(e){a.error("Error handling visibility change:",e)}}async handleOnBeforeUnload(){if(await Oe.switchingUsersPromise,!!me.singletonInstance?.onesignalId)try{const{onesignalId:e,subscriptionId:t}=await this._getOneSignalAndSubscriptionIds(),i={appId:this.context.appConfig.appId,onesignalId:e,subscriptionId:t,sessionThreshold:this.context.appConfig.sessionThreshold,enableSessionDuration:this.context.appConfig.enableSessionDuration,sessionOrigin:ke.BeforeUnload,isSafari:V.isSafari(),outcomesConfig:this.context.appConfig.userConfig.outcomes};a.debug("Notify SW to deactivate session (beforeunload)"),this.context.workerMessenger.directPostMessageToSW(Ce.SessionDeactivate,i)}catch(e){a.error("Error handling onbeforeunload:",e)}}async handleOnFocus(e){if(await Oe.switchingUsersPromise,a.debug("handleOnFocus",e),!!me.singletonInstance?.onesignalId)try{if(e.target!==window)return;const{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();await this.notifySWToUpsertSession(t,i,ke.Focus)}catch(t){a.error("Error handling focus:",t)}}async handleOnBlur(e){if(await Oe.switchingUsersPromise,a.debug("handleOnBlur",e),!!me.singletonInstance?.onesignalId)try{if(e.target!==window)return;const{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();await this.notifySWToDeactivateSession(t,i,ke.Blur)}catch(t){a.error("Error handling blur:",t)}}async upsertSession(e){if(await Oe.switchingUsersPromise,me.singletonInstance?.onesignalId){const{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();await this.notifySWToUpsertSession(t,i,e)}this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers?this.setupSessionEventListeners():(this.onSessionSent=e===ke.UserCreate,OneSignal.emitter.emit(OneSignal.EVENTS.SESSION_STARTED))}setupSessionEventListeners(){if(!this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers){a.debug("Not setting session event listeners. No service worker possible.");return}this.setupOnFocusAndOnBlurForSession(),OneSignal.cache.isVisibilityChangeEventSetup||(document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this),!0),OneSignal.cache.isVisibilityChangeEventSetup=!0),OneSignal.cache.isBeforeUnloadEventSetup||(window.addEventListener("beforeunload",e=>{this.handleOnBeforeUnload(),delete e.returnValue},!0),OneSignal.cache.isBeforeUnloadEventSetup=!0)}setupOnFocusAndOnBlurForSession(){a.debug("setupOnFocusAndOnBlurForSession"),OneSignal.cache.focusHandler||(OneSignal.cache.focusHandler=this.handleOnFocus.bind(this)),OneSignal.cache.isFocusEventSetup||(window.addEventListener("focus",OneSignal.cache.focusHandler,!0),OneSignal.cache.isFocusEventSetup=!0),OneSignal.cache.blurHandler||(OneSignal.cache.blurHandler=this.handleOnBlur.bind(this)),OneSignal.cache.isBlurEventSetup||(window.addEventListener("blur",OneSignal.cache.blurHandler,!0),OneSignal.cache.isBlurEventSetup=!0)}async sendOnSessionUpdateFromPage(){if(this.onSessionSent||!this.context.pageViewManager.isFirstPageView())return;const i=OneSignal.coreDirector.getIdentityModel().onesignalId;if(!i){a.debug("Not sending the on session because user is not registered with OneSignal (no onesignal id)");return}const n=await OneSignal.coreDirector.getPushSubscriptionModel();if(n?.notification_types!==ee.Subscribed&&OneSignal.config?.enableOnSession!==!0)return;let o;Ze(n)&&(o=n?.id);try{const r=new se(se.ONESIGNAL_ID,i),c={refresh_device_metadata:!0,deltas:{session_count:1}},l=j.getAppId();y.enforceAppId(l),y.enforceAlias(r);try{await fe.updateUser({appId:l,subscriptionId:o},r,c),this.onSessionSent=!0}catch(d){a.debug("Error updating user session:",d)}}catch(r){r instanceof Error&&a.error(`Failed to update user session. Error "${r.message}" ${r.stack}`)}}}var ie=(s=>(s.Push="push",s.NonPush="nonPush",s))(ie||{}),Mi=(s=>(s.PromptDismissCount="promptDismissCount",s.NonPushPromptsDismissCount="nonPushPromptsDismissCount",s))(Mi||{}),xt=(s=>(s.OneSignalNotificationPrompt="onesignal-notification-prompt",s.OneSignalNonPushPrompt="onesignal-non-push-prompt",s))(xt||{});class Ye{static isLocalStorageSupported(){try{return typeof localStorage>"u"?!1:(localStorage.getItem("test"),!0)}catch{return!1}}static setItem(e,t,i){if(!Ye.isLocalStorageSupported())return;const n=typeof i<"u"?i*60*1e3:0,o={value:JSON.stringify(t),timestamp:typeof i<"u"?new Date().getTime()+n:void 0};localStorage.setItem(e,JSON.stringify(o))}static getItem(e){if(!Ye.isLocalStorageSupported())return null;const t=localStorage.getItem(e);let i;try{i=JSON.parse(t)}catch{return null}if(i===null)return null;if(i.timestamp&&new Date().getTime()>=i.timestamp)return localStorage.removeItem(e),null;let n=i.value;try{n=JSON.parse(i.value)}catch{return n}return n}static removeItem(e){if(!Ye.isLocalStorageSupported())return null;localStorage.removeItem(e)}}const Ts={[ie.Push]:Mi.PromptDismissCount,[ie.NonPush]:Mi.NonPushPromptsDismissCount},Cs={[ie.Push]:xt.OneSignalNotificationPrompt,[ie.NonPush]:xt.OneSignalNonPushPrompt};class Ke{static async markPromptDismissedWithType(e){const t=Ts[e],i=Cs[e];let n=await u.get("Options",t);n||(n=0),n+=1;let o=3;n==2?o=7:n>2&&(o=30),a.debug(`(${F.getWindowEnv().toString()}) OneSignal: User dismissed the ${e} notification prompt; reprompt after ${o} days.`),await u.put("Options",{key:t,value:n});const r=o*24*60;return Ye.setItem(i,"dismissed",r)}static wasPromptOfTypeDismissed(e){switch(e){case ie.Push:return Ye.getItem(xt.OneSignalNotificationPrompt)==="dismissed";case ie.NonPush:return Ye.getItem(xt.OneSignalNonPushPrompt)==="dismissed"}return!1}}class Pe{constructor(e,t,i,n="shown",o=["opacity","transform"],r,c=500){this.selector=e,this.showClass=t,this.hideClass=i,this.state=n,this.targetTransitionEvents=o,this.nestedContentSelector=r,this.transitionCheckTimeout=c}show(){return this.hidden?new Promise(e=>{this.state="showing",C.trigger(Pe.EVENTS.SHOWING,this);const t=this.element;if(t?(this.hideClass&&le(t,this.hideClass),this.showClass&&m(t,this.showClass)):a.error(`(show) could not find animated element with selector ${this.selector}`),this.targetTransitionEvents.length==0)return e(this);{const i=setTimeout(()=>{a.debug(`Element did not completely show (state: ${this.state}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,o)=>{if(n.target===this.element&&He(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),o(),this.state="shown",C.trigger(Pe.EVENTS.SHOWN,this),e(this)},!0)}}):Promise.resolve(this)}hide(){return this.shown?new Promise(e=>{this.state="hiding",C.trigger(Pe.EVENTS.HIDING,this);const t=this.element;if(t?(this.showClass&&le(t,this.showClass),this.hideClass&&m(t,this.hideClass)):a.error(`(hide) could not find animated element with selector ${this.selector}`),this.targetTransitionEvents.length==0)return e(this);ye(this.element,"transitionend",(i,n)=>{const o=setTimeout(()=>{a.debug(`Element did not completely hide (state: ${this.state}).`)},this.transitionCheckTimeout);if(i.target===this.element&&He(this.targetTransitionEvents,i.propertyName))return clearTimeout(o),n(),this.state="hidden",C.trigger(Pe.EVENTS.HIDDEN,this),e(this)},!0)}):Promise.resolve(this)}waitUntilShown(){return this.state==="shown"?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(Pe.EVENTS.SHOWN,t=>{if(t===this)return e(this)})})}waitUntilHidden(){return this.state==="hidden"?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(Pe.EVENTS.HIDDEN,t=>{if(t===this)return e(this)})})}static get EVENTS(){return{SHOWING:"animatedElementShowing",SHOWN:"animatedElementShown",HIDING:"animatedElementHiding",HIDDEN:"animatedElementHidden"}}get content(){if(!this.element)return"";if(this.nestedContentSelector){const e=this.element.querySelector(this.nestedContentSelector);return e?e.innerHTML:""}else return this.element.innerHTML}set content(e){if(this.element)if(this.nestedContentSelector){const t=this.element.querySelector(this.nestedContentSelector);t&&(t.textContent=e)}else this.element.textContent=e}get element(){return document.querySelector(this.selector)}get showing(){return this.state==="showing"}get shown(){return this.state==="shown"}get hiding(){return this.state==="hiding"}get hidden(){return this.state==="hidden"}}class be extends Pe{constructor(e,t,i,n,o,r="shown",c="active",l=["opacity","transform"],d){super(e,t,i,r,l),this.selector=e,this.showClass=t,this.hideClass=i,this.activeClass=n,this.inactiveClass=o,this.state=r,this.activeState=c,this.targetTransitionEvents=l,this.nestedContentSelector=d}activate(){return!this.inactive||!this.shown?Promise.resolve(this):new Promise(e=>{this.activeState="activating",C.trigger(be.EVENTS.ACTIVATING,this);const t=this.element;if(t?(this.inactiveClass&&le(t,this.inactiveClass),this.activeClass&&m(t,this.activeClass)):a.error("Could not find active animated element"),this.shown){if(this.targetTransitionEvents.length==0)return e(this);{const i=setTimeout(()=>{a.debug(`Element did not completely activate (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,o)=>{if(n.target===this.element&&He(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),o(),this.activeState="active",C.trigger(be.EVENTS.ACTIVE,this),e(this)},!0)}}else return a.debug("Ending activate() transition (alternative)."),this.activeState="active",C.trigger(be.EVENTS.ACTIVE,this),e(this)})}inactivate(){return this.active?new Promise(e=>{this.activeState="inactivating",C.trigger(be.EVENTS.INACTIVATING,this);const t=this.element;if(t?(this.activeClass&&le(t,this.activeClass),this.inactiveClass&&m(t,this.inactiveClass)):a.error("Could not find active animated element"),this.shown){if(this.targetTransitionEvents.length==0)return e(this);{const i=setTimeout(()=>{a.debug(`Element did not completely inactivate (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,o)=>{if(n.target===this.element&&He(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),o(),this.activeState="inactive",C.trigger(be.EVENTS.INACTIVE,this),e(this)},!0)}}else return this.activeState="inactive",C.trigger(be.EVENTS.INACTIVE,this),e(this)}):Promise.resolve(this)}waitUntilActive(){return this.active?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(be.EVENTS.ACTIVE,t=>{if(t===this)return e(this)})})}waitUntilInactive(){return this.inactive?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(be.EVENTS.INACTIVE,t=>{if(t===this)return e(this)})})}static get EVENTS(){return{...Pe.EVENTS,ACTIVATING:"activeAnimatedElementActivating",ACTIVE:"activeAnimatedElementActive",INACTIVATING:"activeAnimatedElementInactivating",INACTIVE:"activeAnimatedElementInactive"}}get activating(){return this.activeState==="activating"}get active(){return this.activeState==="active"}get inactivating(){return this.activeState==="inactivating"}get inactive(){return this.activeState==="inactive"}}class Ps extends be{constructor(){super(".onesignal-bell-launcher-badge","onesignal-bell-launcher-badge-opened",null,"onesignal-bell-launcher-badge-active",null,"hidden")}increment(){if(!isNaN(this.content)){let e=+this.content;e+=1,this.content=e.toString()}}show(){const e=super.show();return OneSignal.notifyButton.setCustomColorsIfSpecified(),e}decrement(){if(!isNaN(this.content)){let e=+this.content;e-=1,e>0?this.content=e.toString():this.content=""}}}class ue extends Pe{bell;contentType;queued;constructor(e){super(".onesignal-bell-launcher-message","onesignal-bell-launcher-message-opened",void 0,"hidden",["opacity","transform"],".onesignal-bell-launcher-message-body"),this.bell=e,this.contentType="",this.queued=[]}static get TIMEOUT(){return 2500}static get TYPES(){return{TIP:"tip",MESSAGE:"message",QUEUED:"queued"}}display(e,t,i=0){return a.debug(`Calling display(${e}, ${t}, ${i}).`),(this.shown?this.hide():at()).then(()=>{this.content=vt.decodeHtmlEntities(t),this.contentType=e}).then(()=>this.show()).then(()=>rt(i)).then(()=>this.hide()).then(()=>{this.content=this.getTipForState(),this.contentType="tip"})}getTipForState(){return this.bell.state===T.STATES.UNSUBSCRIBED?this.bell.options.text["tip.state.unsubscribed"]:this.bell.state===T.STATES.SUBSCRIBED?this.bell.options.text["tip.state.subscribed"]:this.bell.state===T.STATES.BLOCKED?this.bell.options.text["tip.state.blocked"]:""}enqueue(e){return this.queued.push(vt.decodeHtmlEntities(e)),new Promise(t=>{this.bell.badge.shown?this.bell.badge.hide().then(()=>this.bell.badge.increment()).then(()=>this.bell.badge.show()).then(t):(this.bell.badge.increment(),this.bell.initialized?this.bell.badge.show().then(t):t())})}dequeue(e){const t=this.queued.pop(e);return new Promise(i=>{this.bell.badge.shown?this.bell.badge.hide().then(()=>this.bell.badge.decrement()).then(n=>n>0?this.bell.badge.show():Promise.resolve(this)).then(i(t)):(this.bell.badge.decrement(),i(t))})}}class ks extends be{events;bell;constructor(e){super(".onesignal-bell-launcher-button",void 0,void 0,"onesignal-bell-launcher-button-active",void 0,"shown",""),this.bell=e,this.events={mouse:"bell.launcher.button.mouse"};const t=this.element;t&&(t.addEventListener("touchstart",()=>{this.onHovering(),this.onTap()},{passive:!0}),t.addEventListener("mouseenter",()=>{this.onHovering()}),t.addEventListener("mouseleave",()=>{this.onHovered()}),t.addEventListener("touchmove",()=>{this.onHovered()},{passive:!0}),t.addEventListener("mousedown",()=>{this.onTap()}),t.addEventListener("mouseup",()=>{this.onEndTap()}),t.addEventListener("click",()=>{this.onHovered(),this.onClick()}))}onHovering(){(H.isEmpty(this.events.mouse)||H.getLast(this.events.mouse)==="out")&&C.trigger(T.EVENTS.HOVERING),H.put(this.events.mouse,"over")}onHovered(){H.put(this.events.mouse,"out"),C.trigger(T.EVENTS.HOVERED)}onTap(){this.pulse(),this.activate(),this.bell.badge.activate()}onEndTap(){this.inactivate(),this.bell.badge.inactivate()}onClick(){if(C.trigger(T.EVENTS.BELL_CLICK),C.trigger(T.EVENTS.LAUNCHER_CLICK),this.bell.message.shown&&this.bell.message.contentType==ue.TYPES.MESSAGE)return;const e=H.getLast("subscription.optedOut");return this.bell.unsubscribed?e?this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}):(q.registerForPushNotifications(),this.bell._ignoreSubscriptionState=!0,OneSignal.emitter.once(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,()=>{this.bell.message.display(ue.TYPES.MESSAGE,this.bell.options.text["message.action.subscribed"],ue.TIMEOUT).then(()=>{this.bell._ignoreSubscriptionState=!1,this.bell.launcher.inactivate()})})):this.bell.subscribed?this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}):this.bell.blocked&&this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}),this.bell.message.hide()}pulse(){$e(".pulse-ring"),this.element&&ne(this.element,"beforeend",'<div class="pulse-ring"></div>'),this.bell.setCustomColorsIfSpecified()}}class Ns extends Pe{bell;subscribeButtonId;unsubscribeButtonId;notificationIcons;constructor(e){super(".onesignal-bell-launcher-dialog","onesignal-bell-launcher-dialog-opened",void 0,"hidden",["opacity","transform"],".onesignal-bell-launcher-dialog-body"),this.bell=e,this.subscribeButtonId="#onesignal-bell-container .onesignal-bell-launcher #subscribe-button",this.unsubscribeButtonId="#onesignal-bell-container .onesignal-bell-launcher #unsubscribe-button",this.notificationIcons=null}show(){return this.updateBellLauncherDialogBody().then(()=>super.show())}get subscribeButtonSelectorId(){return"subscribe-button"}get unsubscribeButtonSelectorId(){return"unsubscribe-button"}get subscribeButton(){return this.element?this.element.querySelector("#"+this.subscribeButtonSelectorId):null}get unsubscribeButton(){return this.element?this.element.querySelector("#"+this.unsubscribeButtonSelectorId):null}updateBellLauncherDialogBody(){return OneSignal.context.subscriptionManager.isPushNotificationsEnabled().then(e=>{this.nestedContentSelector&&xn(this.nestedContentSelector);let t="Nothing to show.",i="";if(this.bell.options.showCredit&&(i='<div class="divider"></div><div class="kickback">Powered by <a href="https://onesignal.com" class="kickback" target="_blank">OneSignal</a></div>'),this.bell.state===T.STATES.SUBSCRIBED&&e===!0||this.bell.state===T.STATES.UNSUBSCRIBED&&e===!1){let n="";const o=hi(this.notificationIcons);o!="default-icon"?n=`<div class="push-notification-icon"><img src="${o}"></div>`:n='<div class="push-notification-icon push-notification-icon-default"></div>';let r="";this.bell.state!==T.STATES.SUBSCRIBED?r=`<button type="button" class="action" id="${this.subscribeButtonSelectorId}">${this.bell.options.text["dialog.main.button.subscribe"]}</button>`:r=`<button type="button" class="action" id="${this.unsubscribeButtonSelectorId}">${this.bell.options.text["dialog.main.button.unsubscribe"]}</button>`,t=`<h1>${this.bell.options.text["dialog.main.title"]}</h1><div class="divider"></div><div class="push-notification">${n}<div class="push-notification-text-container"><div class="push-notification-text push-notification-text-short"></div><div class="push-notification-text"></div><div class="push-notification-text push-notification-text-medium"></div><div class="push-notification-text"></div><div class="push-notification-text push-notification-text-medium"></div></div></div><div class="action-container">${r}</div>${i}`}else if(this.bell.state===T.STATES.BLOCKED){let n=null;k().name==="chrome"?!k().mobile&&!k().tablet&&(n="/bell/chrome-unblock.jpg"):k().name==="firefox"?n="/bell/firefox-unblock.jpg":k().name=="safari"?n="/bell/safari-unblock.jpg":k().name==="msedge"&&(n="/bell/edge-unblock.png");let o="";n&&(n=F.getOneSignalStaticResourcesUrl()+n,o=`<a href="${n}" target="_blank"><img src="${n}"></a></div>`),(k().mobile||k().tablet)&&k().name==="chrome"&&(o="<ol><li>Access <strong>Settings</strong> by tapping the three menu dots <strong>⋮</strong></li><li>Click <strong>Site settings</strong> under Advanced.</li><li>Click <strong>Notifications</strong>.</li><li>Find and click this entry for this website.</li><li>Click <strong>Notifications</strong> and set it to <strong>Allow</strong>.</li></ol>"),t=`<h1>${this.bell.options.text["dialog.blocked.title"]}</h1><div class="divider"></div><div class="instructions"><p>${this.bell.options.text["dialog.blocked.message"]}</p>${o}</div>${i}`}this.nestedContentSelector&&ne(this.nestedContentSelector,"beforeend",t),this.subscribeButton&&this.subscribeButton.addEventListener("click",()=>{OneSignal.__doNotShowWelcomeNotification=!1,C.trigger(T.EVENTS.SUBSCRIBE_CLICK)}),this.unsubscribeButton&&this.unsubscribeButton.addEventListener("click",()=>C.trigger(T.EVENTS.UNSUBSCRIBE_CLICK)),this.bell.setCustomColorsIfSpecified()})}}class As extends be{bell;wasInactive;constructor(e){super(".onesignal-bell-launcher","onesignal-bell-launcher-active",void 0,void 0,"onesignal-bell-launcher-inactive","hidden","active"),this.bell=e,this.wasInactive=!1}async resize(e){if(!this.element)throw new Me(Fe.MissingDomElement);if(e==="small"&&ui(this.element,"onesignal-bell-launcher-sm")||e==="medium"&&ui(this.element,"onesignal-bell-launcher-md")||e==="large"&&ui(this.element,"onesignal-bell-launcher-lg"))return Promise.resolve(this);if(le(this.element,"onesignal-bell-launcher-sm"),le(this.element,"onesignal-bell-launcher-md"),le(this.element,"onesignal-bell-launcher-lg"),e==="small")m(this.element,"onesignal-bell-launcher-sm");else if(e==="medium")m(this.element,"onesignal-bell-launcher-md");else if(e==="large")m(this.element,"onesignal-bell-launcher-lg");else throw new Error("Invalid OneSignal bell size "+e);return this.shown?await new Promise(t=>{if(this.targetTransitionEvents.length==0)return t(this);{const i=setTimeout(()=>{a.debug(`Launcher did not completely resize (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,o)=>{if(n.target===this.element&&He(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),o(),t(this)},!0)}}):this}activateIfInactive(){return this.inactive?(this.wasInactive=!0,this.activate()):at()}inactivateIfWasInactive(){return this.wasInactive?(this.wasInactive=!1,this.inactivate()):at()}clearIfWasInactive(){this.wasInactive=!1}inactivate(){return this.bell.message.hide().then(()=>this.bell.badge.content.length>0?this.bell.badge.hide().then(()=>Promise.all([super.inactivate(),this.resize("small")])).then(()=>this.bell.badge.show()):Promise.all([super.inactivate(),this.resize("small")]))}activate(){return this.bell.badge.content.length>0?this.bell.badge.hide().then(()=>Promise.all([super.activate(),this.resize(this.bell.options.size)])):Promise.all([super.activate(),this.resize(this.bell.options.size)])}}const xs='<svg class="onesignal-bell-svg" xmlns="http://www.w3.org/2000/svg" width="99.7" height="99.7" viewBox="0 0 99.7 99.7"><circle class="background" cx="49.9" cy="49.9" r="49.9"/><path class="foreground" d="M50.1 66.2H27.7s-2-.2-2-2.1c0-1.9 1.7-2 1.7-2s6.7-3.2 6.7-5.5S33 52.7 33 43.3s6-16.6 13.2-16.6c0 0 1-2.4 3.9-2.4 2.8 0 3.8 2.4 3.8 2.4 7.2 0 13.2 7.2 13.2 16.6s-1 11-1 13.3c0 2.3 6.7 5.5 6.7 5.5s1.7.1 1.7 2c0 1.8-2.1 2.1-2.1 2.1H50.1zm-7.2 2.3h14.5s-1 6.3-7.2 6.3-7.3-6.3-7.3-6.3z"/><ellipse class="stroke" cx="49.9" cy="49.9" rx="37.4" ry="36.9"/></svg>';class T{options;state=T.STATES.UNINITIALIZED;_ignoreSubscriptionState=!1;hovering=!1;initialized=!1;_launcher;_button;_badge;_message;_dialog;DEFAULT_SIZE="medium";DEFAULT_POSITION="bottom-right";DEFAULT_THEME="default";static get EVENTS(){return{STATE_CHANGED:"notifyButtonStateChange",LAUNCHER_CLICK:"notifyButtonLauncherClick",BELL_CLICK:"notifyButtonButtonClick",SUBSCRIBE_CLICK:"notifyButtonSubscribeClick",UNSUBSCRIBE_CLICK:"notifyButtonUnsubscribeClick",HOVERING:"notifyButtonHovering",HOVERED:"notifyButtonHover"}}static get STATES(){return{UNINITIALIZED:"uninitialized",SUBSCRIBED:"subscribed",UNSUBSCRIBED:"unsubscribed",BLOCKED:"blocked"}}static get TEXT_SUBS(){return{"prompt.native.grant":{default:"Allow",chrome:"Allow",firefox:"Always Receive Notifications",safari:"Allow"}}}constructor(e,t){this.options={enable:e.enable||!1,size:e.size||this.DEFAULT_SIZE,position:e.position||this.DEFAULT_POSITION,theme:e.theme||this.DEFAULT_THEME,showLauncherAfter:e.showLauncherAfter||10,showBadgeAfter:e.showBadgeAfter||300,text:this.setDefaultTextOptions(e.text||{}),prenotify:e.prenotify,showCredit:e.showCredit,colors:e.colors,offset:e.offset},t&&(this._launcher=t),this.options.enable&&(this.validateOptions(this.options),this.state=T.STATES.UNINITIALIZED,this._ignoreSubscriptionState=!1,this.installEventHooks(),this.updateState())}showDialogProcedure(){this.dialog.shown||this.dialog.show().then(()=>{ye(document,"click",(e,t)=>{this.dialog.element.contains(e.target)||(t(),this.dialog.shown&&this.dialog.hide().then(()=>{this.launcher.inactivateIfWasInactive()}))},!0)})}validateOptions(e){if(!e.size||!He(["small","medium","large"],e.size))throw new Error(`Invalid size ${e.size} for notify button. Choose among 'small', 'medium', or 'large'.`);if(!e.position||!He(["bottom-left","bottom-right"],e.position))throw new Error(`Invalid position ${e.position} for notify button. Choose either 'bottom-left', or 'bottom-right'.`);if(!e.theme||!He(["default","inverse"],e.theme))throw new Error(`Invalid theme ${e.theme} for notify button. Choose either 'default', or 'inverse'.`);if(!e.showLauncherAfter||e.showLauncherAfter<0)throw new Error(`Invalid delay duration of ${this.options.showLauncherAfter} for showing the notify button. Choose a value above 0.`);if(!e.showBadgeAfter||e.showBadgeAfter<0)throw new Error(`Invalid delay duration of ${this.options.showBadgeAfter} for showing the notify button's badge. Choose a value above 0.`)}setDefaultTextOptions(e){return{"tip.state.unsubscribed":e["tip.state.unsubscribed"]||"Subscribe to notifications","tip.state.subscribed":e["tip.state.subscribed"]||"You're subscribed to notifications","tip.state.blocked":e["tip.state.blocked"]||"You've blocked notifications","message.prenotify":e["message.prenotify"]||"Click to subscribe to notifications","message.action.subscribed":e["message.action.subscribed"]||"Thanks for subscribing!","message.action.resubscribed":e["message.action.resubscribed"]||"You're subscribed to notifications","message.action.subscribing":e["message.action.subscribing"]||"Click <strong>{{prompt.native.grant}}</strong> to receive notifications","message.action.unsubscribed":e["message.action.unsubscribed"]||"You won't receive notifications again","dialog.main.title":e["dialog.main.title"]||"Manage Site Notifications","dialog.main.button.subscribe":e["dialog.main.button.subscribe"]||"SUBSCRIBE","dialog.main.button.unsubscribe":e["dialog.main.button.unsubscribe"]||"UNSUBSCRIBE","dialog.blocked.title":e["dialog.blocked.title"]||"Unblock Notifications","dialog.blocked.message":e["dialog.blocked.message"]||"Follow these instructions to allow notifications:"}}installEventHooks(){O.emitter.on(T.EVENTS.SUBSCRIBE_CLICK,()=>{this.dialog.subscribeButton.disabled=!0,this._ignoreSubscriptionState=!0,O.User.PushSubscription.optIn().then(()=>(this.dialog.subscribeButton.disabled=!1,this.dialog.hide())).then(()=>this.message.display(ue.TYPES.MESSAGE,this.options.text["message.action.resubscribed"],ue.TIMEOUT)).then(()=>(this._ignoreSubscriptionState=!1,this.launcher.clearIfWasInactive(),this.launcher.inactivate())).then(()=>this.updateState()).catch(e=>{throw e})}),O.emitter.on(T.EVENTS.UNSUBSCRIBE_CLICK,()=>{this.dialog.unsubscribeButton.disabled=!0,O.User.PushSubscription.optOut().then(()=>(this.dialog.unsubscribeButton.disabled=!1,this.dialog.hide())).then(()=>(this.launcher.clearIfWasInactive(),this.launcher.activate())).then(()=>this.message.display(ue.TYPES.MESSAGE,this.options.text["message.action.unsubscribed"],ue.TIMEOUT)).then(()=>this.updateState())}),O.emitter.on(T.EVENTS.HOVERING,()=>{if(this.hovering=!0,this.launcher.activateIfInactive(),this.message.shown||this.dialog.shown){this.hovering=!1;return}if(this.message.contentType===ue.TYPES.MESSAGE){this.hovering=!1;return}new Promise(e=>{if(this.message.queued.length>0)return this.message.dequeue().then(t=>{this.message.content=t,this.message.contentType=ue.TYPES.QUEUED,e()});this.message.content=vt.decodeHtmlEntities(this.message.getTipForState()),this.message.contentType=ue.TYPES.TIP,e()}).then(()=>this.message.show()).then(()=>{this.hovering=!1}).catch(e=>{a.error(e)})}),O.emitter.on(T.EVENTS.HOVERED,()=>{this.message.contentType!==ue.TYPES.MESSAGE&&this.dialog.hidden&&(this.hovering&&(this.hovering=!1,this.message.waitUntilShown().then(()=>rt(ue.TIMEOUT)).then(()=>this.message.hide()).then(()=>{this.launcher.wasInactive&&this.dialog.hidden&&(this.launcher.inactivate(),this.launcher.wasInactive=!1)})),this.message.shown&&this.message.hide().then(()=>{this.launcher.wasInactive&&this.dialog.hidden&&(this.launcher.inactivate(),this.launcher.wasInactive=!1)}))}),O.emitter.on(O.EVENTS.SUBSCRIPTION_CHANGED,async e=>{if(e.current.optedIn&&(this.badge.shown&&this.options.prenotify&&this.badge.hide(),this.dialog.notificationIcons===null)){const n=await j.getNotificationIcons();this.dialog.notificationIcons=n}const t=await O.context.permissionManager.getPermissionStatus();let i;e.current.optedIn?i=T.STATES.SUBSCRIBED:t===re.Denied?i=T.STATES.BLOCKED:i=T.STATES.UNSUBSCRIBED,this.setState(i,this._ignoreSubscriptionState)}),O.emitter.on(T.EVENTS.STATE_CHANGED,e=>{this.launcher.element&&(e.to===T.STATES.SUBSCRIBED?this.launcher.inactivate():(e.to===T.STATES.UNSUBSCRIBED||T.STATES.BLOCKED)&&this.launcher.activate())}),O.emitter.on(O.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,()=>{this.updateState()})}addDefaultClasses(){const e=this.container;if(this.options.position==="bottom-left")e&&m(e,"onesignal-bell-container-bottom-left"),m(this.launcher.selector,"onesignal-bell-launcher-bottom-left");else if(this.options.position==="bottom-right")e&&m(e,"onesignal-bell-container-bottom-right"),m(this.launcher.selector,"onesignal-bell-launcher-bottom-right");else throw new Error(`Invalid OneSignal notify button position ${this.options.position}`);if(this.options.theme==="default")m(this.launcher.selector,"onesignal-bell-launcher-theme-default");else if(this.options.theme==="inverse")m(this.launcher.selector,"onesignal-bell-launcher-theme-inverse");else throw new Error(`Invalid OneSignal notify button theme ${this.options.theme}`)}async create(){if(!this.options.enable)return;if(await O.context.dynamicResourceLoader.loadSdkStylesheet()!==jt.Loaded){a.debug("Not showing notify button because styles failed to load.");return}this.container&&$e("#onesignal-bell-container"),ne("body","beforeend",'<div id="onesignal-bell-container" class="onesignal-bell-container onesignal-reset"></div>'),this.container&&ne(this.container,"beforeend",'<div id="onesignal-bell-launcher" class="onesignal-bell-launcher"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-button"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-badge"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-message"></div>'),ne(this.message.selector,"beforeend",'<div class="onesignal-bell-launcher-message-body"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-dialog"></div>'),ne(this.dialog.selector,"beforeend",'<div class="onesignal-bell-launcher-dialog-body"></div>'),ne(this.button.selector,"beforeend",xs);const t=await O.context.subscriptionManager.isPushNotificationsEnabled();Ke.wasPromptOfTypeDismissed(ie.Push);const i=t?"small":this.options.size||this.DEFAULT_SIZE;await this.launcher.resize(i),this.addDefaultClasses(),this.applyOffsetIfSpecified(),this.setCustomColorsIfSpecified(),this.patchSafariSvgFilterBug(),a.info("Showing the notify button."),await(t?this.launcher.inactivate():at()).then(()=>t&&this.dialog.notificationIcons===null?j.getNotificationIcons().then(n=>{this.dialog.notificationIcons=n}):at()).then(()=>rt(this.options.showLauncherAfter||0)).then(()=>this.launcher.show()).then(()=>rt(this.options.showBadgeAfter||0)).then(()=>this.options.prenotify&&!t&&O._isNewVisitor?this.message.enqueue(this.options.text["message.prenotify"]).then(()=>this.badge.show()):at()).then(()=>this.initialized=!0)}patchSafariSvgFilterBug(){if(!(k().name=="safari"&&Number(k().version)>=9.1)){const e="drop-shadow(0 2px 4px rgba(34,36,38,0.35));",t="drop-shadow(0 2px 4px rgba(34,36,38,0));",i="drop-shadow(0px 2px 2px rgba(34,36,38,.15));";this.graphic.setAttribute("style",`filter: ${e}; -webkit-filter: ${e};`),this.badge.element.setAttribute("style",`filter: ${t}; -webkit-filter: ${t};`),this.dialog.element.setAttribute("style",`filter: ${i}; -webkit-filter: ${i};`)}k().name=="safari"&&this.badge.element.setAttribute("style","display: none;")}applyOffsetIfSpecified(){const e=this.options.offset;if(e){const t=this.launcher.element;if(!t){a.error("Could not find bell dom element");return}t.style.cssText="",e.bottom&&(t.style.cssText+=`bottom: ${e.bottom};`),this.options.position==="bottom-right"?e.right&&(t.style.cssText+=`right: ${e.right};`):this.options.position==="bottom-left"&&e.left&&(t.style.cssText+=`left: ${e.left};`)}}setCustomColorsIfSpecified(){const e=this.dialog.element.querySelector("button.action"),t=this.button.element.querySelector(".pulse-ring");this.graphic.querySelector(".background").style.cssText="";const i=this.graphic.querySelectorAll(".foreground");for(let n=0;n<i.length;n++){const o=i[n];o.style.cssText=""}if(this.graphic.querySelector(".stroke").style.cssText="",this.badge.element.style.cssText="",e&&(e.style.cssText="",e.style.cssText=""),t&&(t.style.cssText=""),this.options.colors){const n=this.options.colors;if(n["circle.background"]&&(this.graphic.querySelector(".background").style.cssText+=`fill: ${n["circle.background"]}`),n["circle.foreground"]){const o=this.graphic.querySelectorAll(".foreground");for(let r=0;r<o.length;r++){const c=o[r];c.style.cssText+=`fill: ${n["circle.foreground"]}`}this.graphic.querySelector(".stroke").style.cssText+=`stroke: ${n["circle.foreground"]}`}n["badge.background"]&&(this.badge.element.style.cssText+=`background: ${n["badge.background"]}`),n["badge.bordercolor"]&&(this.badge.element.style.cssText+=`border-color: ${n["badge.bordercolor"]}`),n["badge.foreground"]&&(this.badge.element.style.cssText+=`color: ${n["badge.foreground"]}`),e&&(n["dialog.button.background"]&&(this.dialog.element.querySelector("button.action").style.cssText+=`background: ${n["dialog.button.background"]}`),n["dialog.button.foreground"]&&(this.dialog.element.querySelector("button.action").style.cssText+=`color: ${n["dialog.button.foreground"]}`),n["dialog.button.background.hovering"]&&this.addCssToHead("onesignal-background-hover-style",`#onesignal-bell-container.onesignal-reset .onesignal-bell-launcher .onesignal-bell-launcher-dialog button.action:hover { background: ${n["dialog.button.background.hovering"]} !important; }`),n["dialog.button.background.active"]&&this.addCssToHead("onesignal-background-active-style",`#onesignal-bell-container.onesignal-reset .onesignal-bell-launcher .onesignal-bell-launcher-dialog button.action:active { background: ${n["dialog.button.background.active"]} !important; }`)),t&&n["pulse.color"]&&(this.button.element.querySelector(".pulse-ring").style.cssText=`border-color: ${n["pulse.color"]}`)}}addCssToHead(e,t){if(document.getElementById(e))return;const n=document.createElement("style");n.id=e,n.type="text/css",n.appendChild(document.createTextNode(t)),document.head.appendChild(n)}updateState(){Promise.all([O.context.subscriptionManager.isPushNotificationsEnabled(),O.context.permissionManager.getPermissionStatus()]).then(([e,t])=>{this.setState(e?T.STATES.SUBSCRIBED:T.STATES.UNSUBSCRIBED),t===re.Denied&&this.setState(T.STATES.BLOCKED)}).catch(e=>{a.error(e)})}setState(e,t=!1){const i=this.state;this.state=e,i!==e&&!t&&C.trigger(T.EVENTS.STATE_CHANGED,{from:i,to:e})}get container(){return document.querySelector("#onesignal-bell-container")}get graphic(){return this.button.element.querySelector("svg")}get launcher(){return this._launcher||(this._launcher=new As(this)),this._launcher}get button(){return this._button||(this._button=new ks(this)),this._button}get badge(){return this._badge||(this._badge=new Ps),this._badge}get message(){return this._message||(this._message=new ue(this)),this._message}get dialog(){return this._dialog||(this._dialog=new Ns(this)),this._dialog}get subscribed(){return this.state===T.STATES.SUBSCRIBED}get unsubscribed(){return this.state===T.STATES.UNSUBSCRIBED}get blocked(){return this.state===T.STATES.BLOCKED}}class q{static async internalInit(){a.debug("Called internalInit()"),await OneSignal.context.serviceWorkerManager.installWorker();const e=OneSignal.context.sessionManager;if(OneSignal.emitter.on(OneSignal.EVENTS.SESSION_STARTED,e.sendOnSessionUpdateFromPage.bind(e)),OneSignal.context.pageViewManager.incrementPageViewCount(),document.visibilityState!=="visible"){q.postponeSessionInitUntilPageIsInFocus();return}await q.sessionInit()}static postponeSessionInitUntilPageIsInFocus(){ye(document,"visibilitychange",(e,t)=>{document.visibilityState==="visible"&&(t(),q.sessionInit())},!0)}static async sessionInit(){if(a.debug("Called sessionInit()"),OneSignal._sessionInitAlreadyRunning){a.debug("Returning from sessionInit because it has already been called.");return}OneSignal._sessionInitAlreadyRunning=!0;try{await q.doInitialize()}catch(n){if(n instanceof he)return;throw n}const e=await OneSignal.context.subscriptionManager.isOptedOut(),t=await u.getSubscription();t.optedOut=e,await u.setSubscription(t),await q.handleAutoResubscribe(e);const i=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();await u.setIsPushEnabled(!!i),OneSignal.config.userConfig.promptOptions.autoPrompt&&!e&&OneSignal.context.promptsManager.spawnAutoPrompts(),OneSignal._sessionInitAlreadyRunning=!1,await C.trigger(OneSignal.EVENTS.SDK_INITIALIZED)}static async registerForPushNotifications(){await Xe.registerForPush()}static async onSdkInitialized(){const e=await q.processExpiringSubscriptions();await OneSignal.context.subscriptionManager.isAlreadyRegisteredWithOneSignal()?(OneSignal.context.sessionManager.setupSessionEventListeners(),e||await OneSignal.context.updateManager.sendOnSessionUpdate()):!OneSignal.config.userConfig.promptOptions.autoPrompt&&!OneSignal.config.userConfig.autoResubscribe&&await OneSignal.context.updateManager.sendOnSessionUpdate(),await C.trigger(OneSignal.EVENTS.SDK_INITIALIZED_PUBLIC)}static async storeInitialValues(){const e=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),t=await OneSignal.context.permissionManager.getPermissionStatus(),i=await OneSignal.context.subscriptionManager.isOptedOut();H.put("subscription.optedOut",i),await u.put("Options",{key:"isPushEnabled",value:e}),await u.put("Options",{key:"notificationPermission",value:t})}static async setWelcomeNotificationFlag(){await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.context.appConfig.safariWebId)===re.Granted&&(OneSignal.__doNotShowWelcomeNotification=!0)}static async establishServiceWorkerChannel(){if(navigator.serviceWorker&&window.isSecureContext)try{await OneSignal.context.serviceWorkerManager.establishServiceWorkerChannel()}catch(e){a.error(e)}}static async processExpiringSubscriptions(){const e=OneSignal.context;if(a.debug("Checking subscription expiration..."),!await e.subscriptionManager.isSubscriptionExpiring())return a.debug("Subscription is not considered expired."),!1;a.debug("Subscription is considered expiring.");const i=await e.subscriptionManager.subscribe(Tt.SubscribeNew);return await e.subscriptionManager.registerSubscription(i),!0}static async doInitialize(){const e=[];e.push(q.storeInitialValues()),e.push(q.installNativePromptPermissionChangedHook()),e.push(q.setWelcomeNotificationFlag()),e.push(q.establishServiceWorkerChannel()),e.push(q.showNotifyButton()),e.push(q.showPromptsFromWebConfigEditor());try{await Promise.all(e)}catch(t){throw a.error(t),new he(Ie.Unknown)}}static async showNotifyButton(){if(B.isBrowser()&&!OneSignal.notifyButton){OneSignal.config.userConfig.notifyButton=OneSignal.config.userConfig.notifyButton||{},OneSignal.config.userConfig.bell&&(OneSignal.config.userConfig.bell={...OneSignal.config.userConfig.bell,...OneSignal.config.userConfig.notifyButton},OneSignal.config.userConfig.notifyButton={...OneSignal.config.userConfig.notifyButton,...OneSignal.config.userConfig.bell});const e=OneSignal.config.userConfig.notifyButton.displayPredicate;e&&typeof e=="function"?OneSignal.emitter.once(OneSignal.EVENTS.SDK_INITIALIZED,async()=>{await Promise.resolve(OneSignal.config.userConfig.notifyButton.displayPredicate())!==!1?(OneSignal.notifyButton=new T(OneSignal.config.userConfig.notifyButton),OneSignal.notifyButton.create()):a.debug("Notify button display predicate returned false so not showing the notify button.")}):(OneSignal.notifyButton=new T(OneSignal.config.userConfig.notifyButton),OneSignal.notifyButton.create())}}static async showPromptsFromWebConfigEditor(){const e=OneSignal.config;e.userConfig.promptOptions&&await new Ki(e.userConfig.promptOptions.customlink).initialize()}static async installNativePromptPermissionChangedHook(){try{if(navigator.permissions){const e=await navigator.permissions.query({name:"notifications"});e.onchange=function(){kn()}}}catch(e){a.warn(`Could not install native notification permission change hook w/ error: ${e}`)}}static async saveInitOptions(){const e=[],t=OneSignal.config.userConfig.persistNotification;e.push(u.put("Options",{key:"persistNotification",value:t??!0}));const i=OneSignal.config.userConfig.webhooks;return["notification.willDisplay","notification.clicked","notification.dismissed"].forEach(n=>{i&&i[n]?e.push(u.put("Options",{key:`webhooks.${n}`,value:i[n]})):e.push(u.put("Options",{key:`webhooks.${n}`,value:!1}))}),i&&i.cors?e.push(u.put("Options",{key:"webhooks.cors",value:!0})):e.push(u.put("Options",{key:"webhooks.cors",value:!1})),OneSignal.config.userConfig.notificationClickHandlerMatch?e.push(u.put("Options",{key:"notificationClickHandlerMatch",value:OneSignal.config.userConfig.notificationClickHandlerMatch})):e.push(u.put("Options",{key:"notificationClickHandlerMatch",value:"exact"})),OneSignal.config.userConfig.notificationClickHandlerAction?e.push(u.put("Options",{key:"notificationClickHandlerAction",value:OneSignal.config.userConfig.notificationClickHandlerAction})):e.push(u.put("Options",{key:"notificationClickHandlerAction",value:"navigate"})),Promise.all(e)}static async initSaveState(e){const t=j.getAppId(),i=OneSignal.config;await u.put("Ids",{type:"appId",id:t});const n=e||i.siteName||document.title||"Notification";await u.put("Options",{key:"pageTitle",value:n}),a.info(`OneSignal: Set pageTitle to be '${n}'.`)}static async handleAutoResubscribe(e){a.info("handleAutoResubscribe",{autoResubscribe:OneSignal.config.userConfig.autoResubscribe,isOptedOut:e}),OneSignal.config.userConfig.autoResubscribe&&!e&&await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.context.appConfig.safariWebId)==re.Granted&&await Xe.registerForPush()}static errorIfInitAlreadyCalled(){if(OneSignal._initCalled)throw new he(Ie.MultipleInitialization);OneSignal._initCalled=!0}}function dn(s){return`<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="24px" height="24px" fill="${s}"> <g transform="rotate(0 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.916s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(30 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.833s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(60 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(90 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.666s"/> </rect> </g> <g transform="rotate(120 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.583s"/> </rect> </g> <g transform="rotate(150 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.5s"/> </rect> </g> <g transform="rotate(180 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.416s"/> </rect> </g> <g transform="rotate(210 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.333s"/> </rect> </g> <g transform="rotate(240 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.25s"/> </rect> </g> <g transform="rotate(270 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.166s"/> </rect> </g> <g transform="rotate(300 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.083s"/> </rect> </g> <g transform="rotate(330 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="0s"/> </rect> </g> </svg>`}function Ms(s="#FFFFFF"){return`<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.711 2.652a5.489 5.489 0 00-4.044 4.05 5.513 5.513 0 00.104 2.968.167.167 0 00.25.089l.893-.588a.667.667 0 011.02.692l-.61 2.937a.667.667 0 01-.786.52L.6 12.713a.667.667 0 01-.232-1.21l.933-.615a.166.166 0 00.063-.2 7.167 7.167 0 018.828-9.516.833.833 0 01-.507 1.587 5.489 5.489 0 00-2.974-.108zM15.75 3.542c.09.096.15.216.172.346a.667.667 0 01-.301.681l-.898.564a.166.166 0 00-.066.2 7.167 7.167 0 01-8.77 9.514.835.835 0 01-.154-1.544.831.831 0 01.646-.048 5.5 5.5 0 006.856-6.949.167.167 0 00-.176-.114.164.164 0 00-.071.026l-.962.604a.667.667 0 01-1.005-.713l.667-2.924a.667.667 0 01.8-.502l2.925.667c.129.03.246.096.336.192z" fill="${s}"/></svg>`}function Ds(s){const{icon:e,messageText:t,positiveButtonText:i,negativeButtonText:n}=s,o=e===L.defaultIcon?Wn:e,r=e===L.defaultIcon?L.defaultIcon:"",c=document.createElement("div"),l=document.createElement("div"),d=document.createElement("div"),g=document.createElement("div"),S=document.createElement("div"),h=document.createElement("div"),E=document.createElement("button"),w=document.createElement("button"),_=document.createElement("div"),pe=document.createElement("div"),we=document.createElement("img");return m(l,L.body),m(g,L.icon),m(d,L.message),m(h,L.footer),m(_,L.clearfix),m(pe,L.clearfix),m(E,dt.alignRight),m(E,dt.primary),m(E,dt.slidedownButton),m(w,dt.alignRight),m(w,dt.secondary),m(w,dt.slidedownButton),c.id=P.normalSlidedown,l.id=P.body,S.id=P.loadingContainer,E.id=P.allowButton,w.id=P.cancelButton,h.id=P.footer,r&&m(we,r),we.setAttribute("alt","notification icon"),we.setAttribute("src",o||""),d.innerText=t||"",E.innerText=i||"",w.innerText=n||"",g.appendChild(we),l.appendChild(g),l.appendChild(d),l.appendChild(_),l.appendChild(S),h.appendChild(E),h.appendChild(w),h.appendChild(pe),c.appendChild(l),c.appendChild(h),c}var ti=(s=>(s.Stylesheet="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/css/intlTelInput.min.css",s.Main="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/intlTelInput.min.js",s.Utils="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/utils.js",s))(ti||{}),ii=(s=>(s.Stylesheet="sha512-yye/u0ehQsrVrfSd6biT17t39Rg9kNc+vENcCXZuMz2a+LWFGvXUnYuWUW6pbfYj1jcBb/C39UZw2ciQvwDDvg==",s.Main="sha512-OnkjbJ4TwPpgSmjXACCb5J4cJwi880VRe+vWpPDlr8M38/L3slN5uUAeOeWU2jN+4vN0gImCXFGdJmc0wO4Mig==",s.Utils="sha512-bUcJxlqkiGA3cmoYPuZaLRsyc5ChG9APG4ajom2AXKSlBtOmx4kLV3c8uv/6uSz43FMjI4Q2QI21+D223rT76w==",s))(ii||{});class ae{smsInputFieldIsValid=!0;emailInputFieldIsValid=!0;promptOptions;itiOneSignal;constructor(e){this.promptOptions=e}generateHtml(){const e=document.createElement("div");m(e,G.channelCaptureContainer),e.id=G.channelCaptureContainer;let t,i,n;switch(this.promptOptions.type){case f.Sms:t=this.promptOptions.text.smsLabel||"Phone Number",i=this.getInputWithValidationElement(f.Sms,t),e.appendChild(i);break;case f.Email:t=this.promptOptions.text.emailLabel||"Email",n=this.getInputWithValidationElement(f.Email,t),e.appendChild(n);break;case f.SmsAndEmail:t=this.promptOptions.text.emailLabel||"Email",n=this.getInputWithValidationElement(f.Email,t),e.appendChild(n),t=this.promptOptions.text.smsLabel||"Phone Number",i=this.getInputWithValidationElement(f.Sms,t),e.appendChild(i);break}return e}getValidationElementWithMessage(e){const t=document.createElement("div"),i=document.createElement("img"),n=document.createElement("p");return n.innerText=e,i.setAttribute("src",$n),t.appendChild(i),t.appendChild(n),t}getInputWithValidationElement(e,t){const i=this.getTypeSpecificVariablesForValidationElemGeneration(e),n=document.createElement("label"),o=document.createElement("input"),r=document.createElement("div"),c=document.createElement("div"),l=this.getValidationElementWithMessage(i.message),d=document.createElement("div");return r.setAttribute("style","clear:both"),c.setAttribute("style","clear:both"),m(l,G.onesignalValidationElementHidden),m(l,G.onesignalValidationElement),l.id=i.validationElementId,n.title=t,n.innerText=t,n.htmlFor=i.inputElementId,o.type=i.domElementType,o.id=i.inputElementId,o.tabIndex=i.tabIndex,m(o,i.inputClass),m(d,G.inputWithValidationElement),d.id=i.wrappingDivId,d.appendChild(n),d.appendChild(r),d.appendChild(o),d.appendChild(c),d.appendChild(l),d}getTypeSpecificVariablesForValidationElemGeneration(e){if(e===f.Email)return{message:"Please enter a valid email",domElementType:"email",validationElementId:K.onesignalEmailValidationElement,inputElementId:K.onesignalEmailInput,inputClass:G.onesignalEmailInput,wrappingDivId:K.emailInputWithValidationElement,tabIndex:1};if(e===f.Sms)return{message:"Please enter a valid phone number",domElementType:"tel",validationElementId:K.onesignalSmsValidationElement,inputElementId:K.onesignalSmsInput,inputClass:G.onesignalSmsInput,wrappingDivId:K.smsInputWithValidationElement,tabIndex:2};throw new Error("invalid channel type for input validation")}initializePhoneInputLibrary(){const e=W(`#${K.onesignalSmsInput}`);e&&window.intlTelInput?this.itiOneSignal=window.intlTelInput(e,{autoPlaceholder:"off",separateDialCode:!0}):a.error("OneSignal: there was a problem initializing International Telephone Input")}addSmsInputEventListeners(){const e=W(`#${K.onesignalSmsInput}`);e.addEventListener("keyup",t=>{this.smsInputFieldIsValid=this.itiOneSignal.isValidNumber()||e?.value==="",t.key==="Enter"&&document.getElementById(P.allowButton)?.click(),this.updateValidationOnSmsInputChange()}),e.addEventListener("blur",()=>{this.smsInputFieldIsValid=this.itiOneSignal.isValidNumber()||e?.value==="",this.updateValidationOnSmsInputChange()})}addEmailInputEventListeners(){const e=W(`#${K.onesignalEmailInput}`);e.addEventListener("keyup",t=>{const i=e?.value;this.emailInputFieldIsValid=ae.validateEmailInputWithReturnVal(i),t.key==="Enter"&&document.getElementById(P.allowButton)?.click(),this.updateValidationOnEmailInputChange()})}updateValidationOnSmsInputChange(){const e=W(`#${K.smsInputWithValidationElement}`),t=W(`#${K.onesignalSmsValidationElement}`);le(e,G.onesignalErrorInput),m(t,G.onesignalValidationElementHidden)}updateValidationOnEmailInputChange(){const e=W(`#${K.emailInputWithValidationElement}`),t=W(`#${K.onesignalEmailValidationElement}`);le(e,G.onesignalErrorInput),m(t,G.onesignalValidationElementHidden)}async loadPhoneLibraryScripts(){if(OneSignal._didLoadITILibrary)return;const e=document.createElement("script"),t=document.createElement("script"),i=document.createElement("link");e.src=ti.Main,t.src=ti.Utils,i.href=ti.Stylesheet,i.rel="stylesheet",e.integrity=ii.Main,t.integrity=ii.Utils,i.integrity=ii.Stylesheet,e.crossOrigin="anonymous",t.crossOrigin="anonymous",i.crossOrigin="anonymous",document.head.appendChild(e),document.head.appendChild(t),document.head.appendChild(i);const n=new Promise(r=>{e.onload=()=>{r()}}),o=new Promise(r=>{t.onload=()=>{r()}});await Promise.all([n,o]),OneSignal._didLoadITILibrary=!0}async mount(){const e=ae.isUsingSmsInputField(this.promptOptions.type),t=ae.isUsingEmailInputField(this.promptOptions.type);e&&await this.loadPhoneLibraryScripts();const i=this.generateHtml();W(`#${P.body}`).appendChild(i),e&&(this.initializePhoneInputLibrary(),this.addSmsInputEventListeners()),t&&this.addEmailInputEventListeners()}isEmailInputFieldEmpty(){return this.getValueFromEmailInput()===""}isSmsInputFieldEmpty(){return this.getValueFromSmsInput()===""}getValueFromEmailInput(){return W(`#${K.onesignalEmailInput}`)?.value||""}getValueFromSmsInput(){return this.itiOneSignal.getNumber(intlTelInputUtils.numberFormat.E164)||""}static showSmsInputError(e){const t=document.querySelector(`#${K.onesignalSmsValidationElement}`),i=document.querySelector(`#${K.smsInputWithValidationElement}`);if(!t||!i){a.error("OneSignal: couldn't find slidedown validation element");return}e?(t.classList.remove(G.onesignalValidationElementHidden),i.classList.add(G.onesignalErrorInput)):(t.classList.add(G.onesignalValidationElementHidden),i.classList.remove(G.onesignalErrorInput))}static showEmailInputError(e){const t=document.querySelector(`#${K.onesignalEmailValidationElement}`),i=document.querySelector(`#${K.emailInputWithValidationElement}`);if(!t||!i){a.error("OneSignal: couldn't find slidedown validation element");return}e?(t.classList.remove(G.onesignalValidationElementHidden),i.classList.add(G.onesignalErrorInput)):(t.classList.add(G.onesignalValidationElementHidden),i.classList.remove(G.onesignalErrorInput))}static resetInputErrorStates(e){switch(e){case f.Sms:ae.showSmsInputError(!1);break;case f.Email:ae.showEmailInputError(!1);break;case f.SmsAndEmail:ae.showSmsInputError(!1),ae.showEmailInputError(!1);break}}static validateEmailInputWithReturnVal(e){return/^\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(e||"")||e===""}static isUsingSmsInputField(e){return e===f.Sms||e===f.SmsAndEmail}static isUsingEmailInputField(e){return e===f.Email||e===f.SmsAndEmail}}var _e=(s=>(s[s.InvalidSms=0]="InvalidSms",s[s.InvalidEmail=1]="InvalidEmail",s[s.InvalidEmailAndSms=2]="InvalidEmailAndSms",s))(_e||{});class nt extends A{description;reason;constructor(e){let t;switch(e){case 1:t="Invalid email";break;case 0:t="Invalid sms";break;case 2:t="Invalid email & sms";break}super(t),this.description=_e[e],this.reason=e,Object.setPrototypeOf(this,nt.prototype)}}class z{options;notificationIcons;channelCaptureContainer;isShowingFailureState;tagCategories;savingButton=oe.savingText;errorButton=oe.errorButton;updateMessage;positiveUpdateButton;negativeUpdateButton;constructor(e){switch(this.options=e,this.options.text.actionMessage=e.text.actionMessage.substring(0,90),this.options.text.acceptButton=e.text.acceptButton.substring(0,16),this.options.text.cancelButton=e.text.cancelButton.substring(0,16),this.notificationIcons=null,this.channelCaptureContainer=null,this.isShowingFailureState=!1,e.type){case f.Category:this.negativeUpdateButton=this.options.text.negativeUpdateButton?.substring(0,16),this.positiveUpdateButton=this.options.text.positiveUpdateButton?.substring(0,16),this.updateMessage=this.options.text.updateMessage?.substring(0,90),this.tagCategories=e.categories,this.errorButton=y.getValueOrDefault(this.options.text.positiveUpdateButton,oe.errorButton);break;case f.Sms:case f.Email:case f.SmsAndEmail:this.errorButton=y.getValueOrDefault(this.options.text.acceptButton,oe.errorButton);break}}async create(e){if(this.notificationIcons===null){const t=await j.getNotificationIcons();this.notificationIcons=t,this.container.className.includes(L.container)&&$e(`#${P.container}`);const i=e&&this.tagCategories?this.positiveUpdateButton:this.options.text.acceptButton,n=e&&this.tagCategories?this.negativeUpdateButton:this.options.text.cancelButton,o=e&&this.tagCategories?this.updateMessage:this.options.text.actionMessage,r=this.options.icon||this.getPlatformNotificationIcon(),c=Ds({messageText:o,icon:r,positiveButtonText:i,negativeButtonText:n}),l=document.createElement("div"),d=document.createElement("div");l.id=P.container,m(l,L.container),m(l,L.reset),W("body").appendChild(l),d.id=P.dialog,m(d,L.dialog),d.appendChild(c),this.container.appendChild(d),m(this.container,k().mobile?L.slideUp:L.slideDown),this.allowButton.addEventListener("click",this.onSlidedownAllowed.bind(this)),this.cancelButton.addEventListener("click",this.onSlidedownCanceled.bind(this))}}static async triggerSlidedownEvent(e){await C.trigger(e)}async onSlidedownAllowed(e){await z.triggerSlidedownEvent(z.EVENTS.ALLOW_CLICK)}onSlidedownCanceled(e){z.triggerSlidedownEvent(z.EVENTS.CANCEL_CLICK),this.close(),z.triggerSlidedownEvent(z.EVENTS.CLOSED)}close(){m(this.container,L.closeSlidedown),ye(this.dialog,"animationend",(e,t)=>{e.target===this.dialog&&(e.animationName==="slideDownExit"||e.animationName==="slideUpExit")&&($e(`#${P.container}`),t())},!0)}setSaveState(){this.allowButton.disabled=!0,this.allowButton.textContent=null,this.allowButton.insertAdjacentElement("beforeend",this.getTextSpan(this.savingButton)),this.allowButton.insertAdjacentElement("beforeend",this.getIndicatorHolder()),ne(this.buttonIndicatorHolder,"beforeend",dn(Yi.whiteLoadingIndicator)),m(this.allowButton,"disabled"),m(this.allowButton,L.savingStateButton)}removeSaveState(){this.allowButton.textContent=this.positiveUpdateButton,$e(`#${L.buttonIndicatorHolder}`),this.allowButton.disabled=!1,le(this.allowButton,"disabled"),le(this.allowButton,L.savingStateButton)}setFailureState(){this.allowButton.textContent=null,this.allowButton.insertAdjacentElement("beforeend",this.getTextSpan(this.errorButton)),this.options.type===f.Category&&(this.allowButton.insertAdjacentElement("beforeend",this.getIndicatorHolder()),ne(this.buttonIndicatorHolder,"beforeend",Ms()),m(this.allowButton,"onesignal-error-state-button")),this.isShowingFailureState=!0}setFailureStateForInvalidChannelInput(e){switch(e){case _e.InvalidSms:ae.showSmsInputError(!0);break;case _e.InvalidEmail:ae.showEmailInputError(!0);break;case _e.InvalidEmailAndSms:ae.showSmsInputError(!0),ae.showEmailInputError(!0);break}}removeFailureState(){$e("#onesignal-button-indicator-holder"),le(this.allowButton,"onesignal-error-state-button"),Se.isSlidedownPushDependent(this.options.type)||ae.resetInputErrorStates(this.options.type),this.isShowingFailureState=!1}getPlatformNotificationIcon(){return hi(this.notificationIcons)}getIndicatorHolder(){const e=document.createElement("div");return e.id=P.buttonIndicatorHolder,m(e,L.buttonIndicatorHolder),e}getTextSpan(e){const t=document.createElement("span");return t.textContent=e,t}get container(){return W(`#${P.container}`)}get dialog(){return W(`#${P.dialog}`)}get allowButton(){return W(`#${P.allowButton}`)}get cancelButton(){return W(`#${P.cancelButton}`)}get buttonIndicatorHolder(){return W(`#${P.buttonIndicatorHolder}`)}get slidedownFooter(){return W(`#${P.footer}`)}static get EVENTS(){return{ALLOW_CLICK:"slidedownAllowClick",CANCEL_CLICK:"slidedownCancelClick",SHOWN:"slidedownShown",CLOSED:"slidedownClosed",QUEUED:"slidedownQueued"}}}function Rs(){const s=OneSignal.notifyButton;s&&s.options.enable&&OneSignal.notifyButton.launcher.state!=="hidden"&&OneSignal.notifyButton.launcher.waitUntilShown().then(()=>{OneSignal.notifyButton.launcher.hide()}),OneSignal.emitter.once(z.EVENTS.CLOSED,()=>{OneSignal.notifyButton&&OneSignal.notifyButton.options.enable&&OneSignal.notifyButton.launcher.show()})}class Us{isNativePromptShowing;context;eventHooksInstalled;constructor(e){this.isNativePromptShowing=!1,this.context=e,this.eventHooksInstalled=!1}shouldForceSlidedownOverNative(){const{environmentInfo:e}=OneSignal,{browserType:t,browserVersion:i,requiresUserInteraction:n}=e;return t==="chrome"&&Number(i)>=63&&(k().tablet||k().mobile)||n}async spawnAutoPrompts(){const e=OneSignal.config.userConfig.promptOptions,t=this.shouldForceSlidedownOverNative(),i=this.getDelayedPromptOptions(e,f.Native),n=this.isPageViewConditionMet(i),o=i.enabled&&n,r=t&&o;if(o&&!r){this.internalShowDelayedPrompt(f.Native,i.timeDelay||0);return}const c=!!Se.getFirstSlidedownPromptOptionsWithType(e.slidedown?.prompts,f.Push);r&&!c&&this.internalShowDelayedPrompt(f.Push,i.timeDelay||0);const l=e.slidedown?.prompts;if(l&&l?.length>0)for(let d=0;d<l.length;d++){const g=l[d],S=this.getDelayedPromptOptions(e,g.type),h=this.isPageViewConditionMet(S),E=S.enabled&&h,w={slidedownPromptOptions:g};E&&this.internalShowDelayedPrompt(g.type,S.timeDelay||0,w)}}async internalShowDelayedPrompt(e,t,i){if(V.logMethodCall("internalShowDelayedPrompt"),typeof t!="number"){a.error("internalShowDelayedPrompt: timeDelay not a number");return}const{requiresUserInteraction:n}=bi.getEnvironmentInfo();switch(n&&e===f.Native&&(e=f.Push),t>0&&await wt(t*1e3),e){case f.Native:await this.internalShowNativePrompt();break;case f.Push:await this.internalShowSlidedownPrompt(i);break;case f.Category:await this.internalShowCategorySlidedown(i);break;case f.Sms:await this.internalShowSmsSlidedown(i);break;case f.Email:await this.internalShowEmailSlidedown(i);break;case f.SmsAndEmail:await this.internalShowSmsAndEmailSlidedown(i);break;default:a.error("Invalid Delayed Prompt type")}}async internalShowNativePrompt(){if(V.logMethodCall("internalShowNativePrompt"),this.isNativePromptShowing){a.debug("Already showing autoprompt. Abort showing a native prompt.");return}this.isNativePromptShowing=!0,await q.registerForPushNotifications(),this.isNativePromptShowing=!1,Ke.markPromptDismissedWithType(ie.Push)}async internalShowSlidedownPrompt(e={force:!1}){if(V.logMethodCall("internalShowSlidedownPrompt"),e.slidedownPromptOptions||(e.slidedownPromptOptions=Pi),await this.context.dynamicResourceLoader.loadSdkStylesheet()!==jt.Loaded){a.debug("Not showing slidedown permission message because styles failed to load.");return}this.eventHooksInstalled||this.installEventHooksForSlidedown(),await this.context.slidedownManager.createSlidedown(e)}async internalShowCategorySlidedown(e){V.logMethodCall("internalShowCategorySlidedown"),await this.internalShowParticularSlidedown(f.Category,e)}async internalShowSmsSlidedown(e){V.logMethodCall("internalShowSmsSlidedown"),await this.internalShowParticularSlidedown(f.Sms,e)}async internalShowEmailSlidedown(e){V.logMethodCall("internalShowEmailSlidedown"),await this.internalShowParticularSlidedown(f.Email,e)}async internalShowSmsAndEmailSlidedown(e){V.logMethodCall("internalShowSmsAndEmailSlidedown"),await this.internalShowParticularSlidedown(f.SmsAndEmail,e)}async internalShowParticularSlidedown(e,t){const i=this.context.appConfig.userConfig.promptOptions?.slidedown?.prompts,n=t?.slidedownPromptOptions||Se.getFirstSlidedownPromptOptionsWithType(i,e);if(!n)if(e!==f.Push){a.error(`OneSignal: slidedown of type '${e}' couldn't be shown. Check your configuration on the OneSignal dashboard or your custom code initialization.`);return}else a.warn("The OneSignal 'push' slidedown will be shown with default text settings. To customize, see the OneSignal documentation.");await this.internalShowSlidedownPrompt({...t,slidedownPromptOptions:n})}installEventHooksForSlidedown(){this.eventHooksInstalled=!0,OneSignal.emitter.on(z.EVENTS.SHOWN,()=>{this.context.slidedownManager.setIsSlidedownShowing(!0)}),OneSignal.emitter.on(z.EVENTS.CLOSED,()=>{this.context.slidedownManager.setIsSlidedownShowing(!1),this.context.slidedownManager.showQueued()}),OneSignal.emitter.on(z.EVENTS.ALLOW_CLICK,async()=>{await this.context.slidedownManager.handleAllowClick(),C.trigger(OneSignal.EVENTS.TEST_FINISHED_ALLOW_CLICK_HANDLING)}),OneSignal.emitter.on(z.EVENTS.CANCEL_CLICK,()=>{if(!this.context.slidedownManager.slidedown)return;switch(this.context.slidedownManager.slidedown?.options.type){case f.Push:case f.Category:a.debug("Setting flag to not show the slidedown to the user again."),Ke.markPromptDismissedWithType(ie.Push);break;default:a.debug("Setting flag to not show the slidedown to the user again."),Ke.markPromptDismissedWithType(ie.NonPush);break}})}isPageViewConditionMet(e){return!e||typeof e.pageViews>"u"||!e.autoPrompt||!e.enabled?!1:this.context.pageViewManager.getLocalPageViewCount()>=e.pageViews}getDelayedPromptOptions(e,t){const i={enabled:!1,autoPrompt:!1,timeDelay:de.timeDelay,pageViews:de.pageViews};if(!e||!e.native||!e.slidedown)return i;switch(t){case f.Native:{const n=e.native;return{enabled:n?.enabled,autoPrompt:n?.autoPrompt,timeDelay:n?.timeDelay,pageViews:n?.pageViews}}case f.Push:case f.Category:case f.Email:case f.Sms:case f.SmsAndEmail:{const{userConfig:n}=this.context.appConfig,o=Se.getFirstSlidedownPromptOptionsWithType(n.promptOptions?.slidedown?.prompts||[],t);return{enabled:!!o,autoPrompt:!!o?.autoPrompt,timeDelay:o?.delay?.timeDelay,pageViews:o?.delay?.pageViews}}default:return i}}}class Mt extends A{constructor(e){super(`This operation can only be performed when the channel '${e}' does not yet exist.`),Object.setPrototypeOf(this,Mt.prototype)}}class Di extends A{constructor(){super("This operation can only be performed when the user is not subscribed."),Object.setPrototypeOf(this,Di.prototype)}}class Ri extends A{constructor(e){super(`The permission message of type ${e||"unknown"} was previously dismissed.`),Object.setPrototypeOf(this,Ri.prototype)}}class mt{message;constructor(e){this.message=e}async show(){const e=document.createElement("div"),t=document.createElement("p");t.innerText=this.message,e.appendChild(t);const i=document.createElement("div"),n=document.createElement("div");i.id=P.container,e.id=Fn.toastText,m(e,Bn.toastText),m(i,L.container),m(i,L.reset),W("body").appendChild(i),n.id=P.dialog,m(n,L.dialog),n.appendChild(e),this.container.appendChild(n),m(this.container,k().mobile?L.slideUp:L.slideDown),mt.triggerSlidedownEvent(mt.EVENTS.SHOWN)}static async triggerSlidedownEvent(e){await C.trigger(e)}close(){m(this.container,L.closeSlidedown),ye(this.dialog,"animationend",(e,t)=>{e.target===this.dialog&&(e.animationName==="slideDownExit"||e.animationName==="slideUpExit")&&($e(`#${P.container}`),t())},!0)}get container(){return W(`#${P.container}`)}get dialog(){return W(`#${P.dialog}`)}static get EVENTS(){return{SHOWN:"toastShown",CLOSED:"toastClosed"}}}class un{mount(e,t){const i=this.generateHtml(e,t);W(`#${P.body}`).appendChild(i),this.taggingContainer&&this.taggingContainer.addEventListener("change",this.toggleCheckedTag);const o=W(`#${P.allowButton}`);o.disabled=!1,le(o,"disabled"),$e(`#${P.loadingContainer}`)}load(){const e=W(`#${P.loadingContainer}`),t=W(`#${P.allowButton}`),i=document.createElement("div");m(e,`${L.loadingContainer}`),m(i,De.loadingMessage),m(t,"disabled"),ne(e,"beforeend",dn(Yi.greyLoadingIndicator)),i.innerText=Hn.fetchingPreferences,e.appendChild(i),t.disabled=!0}generateHtml(e,t){const i=Ee.getCheckedTagCategories(e,t),n=i.filter(d=>i.indexOf(d)%2===0),o=i.filter(d=>i.indexOf(d)%2),r=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div");return m(r,De.taggingContainerCol),m(c,De.taggingContainerCol),m(l,De.taggingContainer),l.id=Vn.taggingContainer,n.forEach(d=>{r.appendChild(this.getCategoryLabelElement(d))}),o.forEach(d=>{c.appendChild(this.getCategoryLabelElement(d))}),l.appendChild(r),l.appendChild(c),l}getCategoryLabelElement(e){const{label:t}=e,i=document.createElement("label"),n=document.createElement("span"),o=document.createElement("input"),r=document.createElement("span"),c=document.createElement("div"),l=document.createElement("div");return m(i,De.categoryLabel),m(n,De.categoryLabelText),m(o,De.categoryLabelInput),m(r,De.checkmark),i.title=t,n.innerText=t,o.type="checkbox",o.value=e.tag,o.checked=!!e.checked,i.appendChild(n),i.appendChild(o),i.appendChild(r),c.setAttribute("style","clear:both"),l.appendChild(i),l.appendChild(c),l}get taggingContainer(){const e=`#${P.body} > div.${De.taggingContainer}`;return W(e)}toggleCheckedTag(e){const t=e.target;if(t&&t.getAttribute("type")==="checkbox"){const i=t.checked;t.setAttribute("checked",i.toString())}}static getValuesFromTaggingContainer(){const e=`#${P.body} > div.${De.taggingContainer}> div > div > label > input[type=checkbox]`,t=document.querySelectorAll(e),i={};return t.forEach(n=>{i[n.value]=n.checked}),i}}class Ls{context;slidedownQueue;isSlidedownShowing;slidedown;constructor(e){this.context=e,this.slidedownQueue=[],this.isSlidedownShowing=!1}async checkIfSlidedownShouldBeShown(e){const t=await OneSignal.context.permissionManager.getPermissionStatus()===re.Denied;let i;const n=await OneSignal.context.subscriptionManager.getSubscriptionState(),{subscribed:o,optedOut:r}=n,c=e.slidedownPromptOptions?.type;let l=!1;if(c&&(l=Se.isSlidedownPushDependent(c)),l){if(o)return e.isInUpdateMode?!0:(a.info(new Di),!1);if(i=Ke.wasPromptOfTypeDismissed(ie.Push),r)throw new Gt(qt.OptedOut);if(t)return a.info(new ze(tt.Blocked)),!1}else{if(!e.force){const d=await OneSignal.coreDirector.hasSms(),g=await OneSignal.coreDirector.hasEmail(),S=d&&g;if(d&&c===f.Sms)return a.info(new Mt(f.Sms)),!1;if(g&&c===f.Email)return a.info(new Mt(f.Email)),!1;if(S&&c===f.SmsAndEmail)return a.info(new Mt(f.SmsAndEmail)),!1}i=Ke.wasPromptOfTypeDismissed(ie.NonPush)}return i&&!e.force&&!e.isInUpdateMode?(a.info(new Ri(c)),!1):!0}registerForPush(){q.registerForPushNotifications()}async handleAllowForCategoryType(){if(!this.slidedown)throw new A("SlidedownManager: handleAllowForCategoryType: this.slidedown is undefined");const e=un.getValuesFromTaggingContainer();this.context.tagManager.storeTagValuesToUpdate(e),this.registerForPush(),await this.context.tagManager.sendTags(!0)}async handleAllowForEmailType(){if(!this.slidedown)throw new A("SlidedownManager: handleAllowForEmailType: this.slidedown is undefined");const e=this.slidedown.channelCaptureContainer?.emailInputFieldIsValid,t=this.slidedown.channelCaptureContainer?.isEmailInputFieldEmpty();if(!e||t)throw new nt(_e.InvalidEmail);const i=this.slidedown.channelCaptureContainer?.getValueFromEmailInput();this.updateEmail(i)}async handleAllowForSmsType(){if(!this.slidedown)throw new A("SlidedownManager: handleAllowForSmsType: this.slidedown is undefined");const e=this.slidedown.channelCaptureContainer?.smsInputFieldIsValid,t=this.slidedown.channelCaptureContainer?.isSmsInputFieldEmpty();if(!e||t)throw new nt(_e.InvalidSms);const i=this.slidedown.channelCaptureContainer?.getValueFromSmsInput();this.updateSMS(i)}async handleAllowForSmsAndEmailType(){if(!this.slidedown)throw new A("SlidedownManager: handleAllowForSmsAndEmailType: this.slidedown is undefined");const e=this.slidedown.channelCaptureContainer?.smsInputFieldIsValid,t=this.slidedown.channelCaptureContainer?.emailInputFieldIsValid,i=this.slidedown.channelCaptureContainer?.isEmailInputFieldEmpty(),n=this.slidedown.channelCaptureContainer?.isSmsInputFieldEmpty();if(!e&&!t||i&&n)throw new nt(_e.InvalidEmailAndSms);const c=this.slidedown.channelCaptureContainer?.getValueFromEmailInput(),l=this.slidedown.channelCaptureContainer?.getValueFromSmsInput();if(t)i||this.updateEmail(c);else throw new nt(_e.InvalidEmail);if(e)n||this.updateSMS(l);else throw new nt(_e.InvalidSms)}updateEmail(e){e&&OneSignal.User.addEmail(e)}updateSMS(e){e&&OneSignal.User.addSms(e)}async showConfirmationToast(){if(!this.slidedown)throw new A("SlidedownManager: showConfirmationToast: this.slidedown is undefined");const e=this.slidedown.options.text.confirmMessage;if(!e)return;await wt(1e3);const t=new mt(e);await t.show(),await wt(5e3),t.close(),mt.triggerSlidedownEvent(mt.EVENTS.CLOSED)}async mountAuxiliaryContainers(e){switch(e.slidedownPromptOptions?.type){case f.Category:this.mountTaggingContainer(e);break;case f.Email:case f.Sms:case f.SmsAndEmail:await this.mountChannelCaptureContainer(e);break}}async mountTaggingContainer(e){V.logMethodCall("mountTaggingContainer");try{let t={};const i=new un,n=e.slidedownPromptOptions?.categories;if(!n)throw new Error("Categories not defined");const r=OneSignal.coreDirector.getPropertiesModel().tags;e.isInUpdateMode&&r?(this.context.tagManager.storeRemotePlayerTags(r),t=Ee.convertTagsApiToBooleans(r)):Ee.markAllTagsAsSpecified(n,!0),i.mount(n,t)}catch(t){a.error("OneSignal: Attempted to create tagging container with error",t)}}async mountChannelCaptureContainer(e){V.logMethodCall("mountChannelCaptureContainer");try{if(e.slidedownPromptOptions){const t=new ae(e.slidedownPromptOptions);t.mount(),this.slidedown&&(this.slidedown.channelCaptureContainer=t)}}catch(t){a.error("OneSignal: Attempted to create channel capture container with error",t)}}async handleAllowClick(){if(!this.slidedown)throw new A("SlidedownManager: handleAllowClick: this.slidedown is undefined");const e=this.slidedown.options.type;this.slidedown.isShowingFailureState&&this.slidedown.removeFailureState();try{switch(e){case f.Push:this.registerForPush();break;case f.Category:await this.handleAllowForCategoryType();break;case f.Email:await this.handleAllowForEmailType();break;case f.Sms:await this.handleAllowForSmsType();break;case f.SmsAndEmail:await this.handleAllowForSmsAndEmailType();break;default:break}}catch(t){a.warn("OneSignal Slidedown failed to update:",t),this.slidedown.removeSaveState(),this.slidedown.setFailureState(),t.reason!==void 0&&this.slidedown.setFailureStateForInvalidChannelInput(t.reason);return}switch(this.slidedown&&(this.slidedown.close(),Se.isSlidedownPushDependent(e)||await this.showConfirmationToast(),await wt(1e3),z.triggerSlidedownEvent(z.EVENTS.CLOSED)),e){case f.Push:case f.Category:a.debug("Setting flag to not show the slidedown to the user again."),Ke.markPromptDismissedWithType(ie.Push);break;default:a.debug("Setting flag to not show the slidedown to the user again."),Ke.markPromptDismissedWithType(ie.NonPush);break}}setIsSlidedownShowing(e){this.isSlidedownShowing=e}async showQueued(){if(this.slidedownQueue.length>0){const e=this.dequeue();e&&await this.createSlidedown(e)}}enqueue(e){this.slidedownQueue.push(e),z.triggerSlidedownEvent(z.EVENTS.QUEUED)}dequeue(){return this.slidedownQueue.shift()}async createSlidedown(e){V.logMethodCall("createSlidedown");try{if(!await this.checkIfSlidedownShouldBeShown(e))return}catch(t){a.warn("checkIfSlidedownShouldBeShown returned an error",t);return}if(Rs(),this.isSlidedownShowing){this.enqueue(e);return}try{this.setIsSlidedownShowing(!0);const t=e.slidedownPromptOptions||Pi;this.slidedown=new z(t),await this.slidedown.create(e.isInUpdateMode),await this.mountAuxiliaryContainers(e),a.debug("Showing OneSignal Slidedown"),z.triggerSlidedownEvent(z.EVENTS.SHOWN)}catch(t){a.error("There was an error showing the OneSignal Slidedown:",t),this.setIsSlidedownShowing(!1),this.slidedown?.close()}}}class _s{tagsFromTaggingContainer={};context;remoteTags={};constructor(e){this.context=e}async sendTags(){a.info("Category Slidedown Local Tags:",this.tagsFromTaggingContainer);const e=Ee.convertTagsBooleansToApi(this.tagsFromTaggingContainer),t=Ee.getObjectDifference(e,this.remoteTags);return Ee.isTagObjectEmpty(t)?(a.warn("OneSignal: no change detected in Category preferences. Skipping tag update."),t):await OneSignal.User.addTags(t)}storeTagValuesToUpdate(e){this.tagsFromTaggingContainer=e}storeRemotePlayerTags(e){this.context.tagManager.remoteTags=e}}class Bs{appConfig;environmentInfo;dynamicResourceLoader;subscriptionManager;serviceWorkerManager;workerMessenger;pageViewManager;permissionManager;updateManager;promptsManager;sessionManager;tagManager;slidedownManager;constructor(e){this.appConfig=e,typeof OneSignal<"u"&&OneSignal.environmentInfo&&(this.environmentInfo=OneSignal.environmentInfo),this.subscriptionManager=ln.getSubscriptionManager(this),this.serviceWorkerManager=ln.getServiceWorkerManager(this),this.pageViewManager=new ei,this.permissionManager=new xi,this.workerMessenger=new Is(this),this.updateManager=new Es(this),this.sessionManager=new Os(this),this.tagManager=new _s(this),this.slidedownManager=new Ls(this),this.promptsManager=new Us(this),this.dynamicResourceLoader=new wi}}class Fs{static processItem(e,t){if(typeof t=="function")return t(e);throw new A("Only accepts function type!")}}class Vs{setLogLevel(e){a.setLevel(e)}}class pn extends $t{constructor(e){super(),this._permissionNative=e,this._permission=e===re.Granted,O.emitter.on(O.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,t=>{this._permissionNative=t,this._permission=t===re.Granted})}_permission;get permissionNative(){return this._permissionNative}get permission(){return this._permission}async setDefaultUrl(e){if(v("setDefaultUrl",e),typeof e>"u")throw new M("url",x.Empty);if(typeof e!="string")throw new M("url",x.WrongType);if(!Ht.isValidUrl(e,{allowNull:!0}))throw new M("url",x.Malformed);await ce(),v("setDefaultNotificationUrl",e);const t=await u.getAppState();t.defaultNotificationUrl=e,await u.setAppState(t)}async setDefaultTitle(e){if(v("setDefaultTitle",e),typeof e>"u")throw new M("title",x.Empty);if(typeof e!="string")throw new M("title",x.WrongType);await ce();const t=await u.getAppState();t.defaultNotificationTitle=e,await u.setAppState(t)}isPushSupported(){return v("isPushNotificationsSupported"),!0}async requestPermission(){await ce(),await O.context.promptsManager.internalShowNativePrompt()}addEventListener(e,t){O.emitter.on(e,t),e==="click"&&Q.fireStoredNotificationClicks()}removeEventListener(e,t){O.emitter.off(e,t)}}const Ws={NOTIFICATION_PERMISSION_CHANGED_AS_STRING:"permissionChangeAsString",NOTIFICATION_PERMISSION_CHANGED_AS_BOOLEAN:"permissionChange",SUBSCRIPTION_CHANGED:"change",WELCOME_NOTIFICATION_SENT:"sendWelcomeNotification",NOTIFICATION_WILL_DISPLAY:"foregroundWillDisplay",NOTIFICATION_DISMISSED:"dismiss",NOTIFICATION_CLICKED:"click",SDK_INITIALIZED:"initializeInternal",SDK_INITIALIZED_PUBLIC:"initialize",REGISTERED:"register",PERMISSION_PROMPT_DISPLAYED:"permissionPromptDisplay",TEST_FINISHED_ALLOW_CLICK_HANDLING:"testFinishedAllowClickHandling",SESSION_STARTED:"os.sessionStarted"};class $s{async sendOutcome(e,t){const i=OneSignal.config.userConfig.outcomes;if(!i){a.error(`Could not send ${e}. No outcomes config found.`);return}const n=new Nt(OneSignal.config.appId,i,e,!1);if(typeof t<"u"&&typeof t!="number"){a.error("Outcome weight can only be a number if present.");return}if(!await n.beforeOutcomeSend())return;const o=await n.getAttribution();await n.send({type:o.type,notificationIds:o.notificationIds,weight:t})}async sendUniqueOutcome(e){const t=OneSignal.config.userConfig.outcomes;if(!t){a.error(`Could not send ${e}. No outcomes config found.`);return}const i=new Nt(OneSignal.config.appId,t,e,!0);if(!await i.beforeOutcomeSend())return;const n=await i.getAttribution();if(n.type===ve.NotSupported){a.warn("You are on a free plan. Please upgrade to use this functionality.");return}const{notificationIds:o}=n,r=await i.getNotifsToAttributeWithUniqueOutcome(o);if(!i.shouldSendUnique(n,r)){a.warn(`'${e}' was already reported for all notifications.`);return}await i.send({type:n.type,notificationIds:r})}}class Hs extends $t{constructor(){super()}async promptPush(e){await ce(),await O.context.promptsManager.internalShowParticularSlidedown(f.Push,e)}async promptPushCategories(e){await ce();const t=await O.context.subscriptionManager.isPushNotificationsEnabled();await O.context.promptsManager.internalShowCategorySlidedown({...e,isInUpdateMode:t})}async promptSms(e){await ce(),await O.context.promptsManager.internalShowSmsSlidedown({...e})}async promptEmail(e){await ce(),await O.context.promptsManager.internalShowEmailSlidedown({...e})}async promptSmsAndEmail(e){await ce(),await O.context.promptsManager.internalShowSmsAndEmailSlidedown({...e})}addEventListener(e,t){O.emitter.on(e,t)}removeEventListener(e,t){O.emitter.off(e,t)}}let O=class U{static EVENTS=Ws;static async _initializeCoreModuleAndOSNamespaces(){const e=new us;await e.init(),U.coreDirector=new ps(e);const t=await u.getSubscription(),i=await U.context.permissionManager.getPermissionStatus();U.User=new lt(!0,t,i),this.Notifications=new pn(i)}static async _initializeConfig(e){const t=await new Ss().getAppConfig(e);a.debug("OneSignal: Final web app config:",t),U.config=t,U.environmentInfo=bi.getEnvironmentInfo(),U.context=new Bs(t),U.config=U.context.appConfig}static async login(e,t){if(v("login",{externalId:e,jwtToken:t}),typeof e>"u")throw new M("externalId",x.Empty);if(typeof e!="string")throw new M("externalId",x.WrongType);if(t!==void 0&&typeof t!="string")throw new M("jwtToken",x.WrongType);await Oe.login(e,t)}static async logout(){v("logout"),await Oe.logout()}static async init(e){if(v("init"),a.debug(`Browser Environment: ${k().name} ${k().version}`),ut.removeLegacySubscriptionOptions(),q.errorIfInitAlreadyCalled(),await U._initializeConfig(e),!U.config)throw new Error("OneSignal config not initialized!");if(k().name=="safari"&&!U.config.safariWebId){a.warn(new he(Ie.MissingSafariWebId));return}if(await U._initializeCoreModuleAndOSNamespaces(),ut.getConsentRequired()&&!await u.getConsentGiven()){U.pendingInit=!0;return}await U._delayedInit()}static async _delayedInit(){U.pendingInit=!1,U.context.workerMessenger.listen();async function e(){U.__initAlreadyCalled||(U.__initAlreadyCalled=!0,U.emitter.on(U.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,Q.onNotificationPermissionChange),U.emitter.on(U.EVENTS.SUBSCRIPTION_CHANGED,Q._onSubscriptionChanged),U.emitter.on(U.EVENTS.SDK_INITIALIZED,q.onSdkInitialized),window.addEventListener("focus",()=>{j.checkAndTriggerNotificationPermissionChanged()}),await q.initSaveState(),await q.saveInitOptions(),await q.internalInit())}document.readyState==="complete"||document.readyState==="interactive"?await e():(a.debug("OneSignal: Waiting for DOMContentLoaded or readyStateChange event before continuing initialization..."),window.addEventListener("DOMContentLoaded",()=>{e()}),document.onreadystatechange=()=>{(document.readyState==="complete"||document.readyState==="interactive")&&e()})}static async setConsentGiven(e){if(v("setConsentGiven",{consent:e}),typeof e>"u")throw new M("consent",x.Empty);if(typeof e!="boolean")throw new M("consent",x.WrongType);await u.setConsentGiven(e),e&&U.pendingInit&&await U._delayedInit()}static async setConsentRequired(e){if(v("setConsentRequired",{requiresConsent:e}),typeof e>"u")throw new M("requiresConsent",x.Empty);if(typeof e!="boolean")throw new M("requiresConsent",x.WrongType);ut.setConsentRequired(e)}static async push(e){return Fs.processItem(U,e)}static __doNotShowWelcomeNotification;static VERSION=B.version();static _VERSION=B.version();static sdkEnvironment=F;static environmentInfo;static config=null;static _sessionInitAlreadyRunning=!1;static _isNewVisitor=!1;static timedLocalStorage=Ye;static initialized=!1;static _didLoadITILibrary=!1;static notifyButton=null;static environment=B;static database=u;static event=C;static pendingInit=!0;static emitter=new Lt;static cache={};static _LOGGING=!1;static LOGGING=!1;static _initCalled=!1;static __initAlreadyCalled=!1;static context;static coreDirector;static _notifications;static get Notifications(){return this._notifications||(this._notifications=new pn),this._notifications}static set Notifications(e){this._notifications=e}static Slidedown=new Hs;static Session=new $s;static User=new lt(!1);static Debug=new Vs};a.info(`OneSignal Web SDK loaded (version ${O._VERSION},
  ${F.getWindowEnv().toString()} environment).`),a.debug(`Current Page URL: ${typeof location>"u"?"NodeJS":location.href}`);class js{static async processOneSignalDeferredArray(e){for(const t of e)try{await O.push(t)}catch(i){a.error(i)}}}function qs(){if(Mn(),gi()>1){a.warn("OneSignal: The web push SDK is included more than once. For optimal performance, please include our SDK only once on your page."),a.debug(`OneSignal: Exiting from SDK initialization to prevent double-initialization errors. Occurred ${gi()} times.`);return}window.OneSignal=O,window.OneSignalDeferred=window.OneSignalDeferred??[];const s=js.processOneSignalDeferredArray(window.OneSignalDeferred);Object.defineProperty(window.OneSignalDeferred,"push",{value:async function(e){return await s,O.push(e)}})}qs()})();
//# sourceMappingURL=OneSignalSDK.page.es6.js.map
